##################################################################
#
# makefile_openssl_server
#
# creates environment to run several openssl servers
# used to test our own ssl client
#
# Copyright (c) 2006-2015 Digicert Inc, Inc.
#
##################################################################


OPENSSL_VER_ALL := $(shell openssl version)

OPENSSL_VER := $(word 2, $(OPENSSL_VER_ALL))

DHPARAM_FILE := openssl_dh2048.pem

KEY_FILE := openssl_key.pem
CERT_FILE := openssl_cert.pem
CERT_CHAIN := openssl_chain.pem

WILDCHAR_KEY_FILE := openssl_wildchar_key.pem
WILDCHAR_CERT_FILE := openssl_wildchar_cert.pem
WILDCHAR_CERT_CHAIN := openssl_wildchar_chain.pem

REVOKED_KEY_FILE := openssl_revoked_key.pem
REVOKED_CERT_FILE := openssl_revoked_cert.pem
REVOKED_CERT_CHAIN := openssl_revoked_chain.pem

ifneq (, $(findstring  1.,$(OPENSSL_VER)))
EC_KEY_FILE := openssl_ec_key.pem
EC_CERT_FILE:= openssl_ec_cert.pem
EC_RSA_CERT_FILE:=openssl_ec_rsa_cert.pem
EC_RSA_CERT_CHAIN:=openssl_ec_rsa_chain.pem
endif


BITS := 1024
# ports 1450-1459, 1480-1489 are reserved for OpenSSL -- this makefile
# ports 1460-1469 are reserved for Mocana servers -- ssl_server.c
PORT := 1450			  # server with RSA cert
PORT_ECC_MUT_AUTH := 1451 # server with ECC cert + mutual authentication
PORT_SSLV3 := 1452
PORT_KEY512 := 1453       # server with small RSA key
PORT_SMALL_DH := 1454   # server with small DH keys
PORT_ECC := 1455          # server with ECC cert (no mutual authentication)
PORT_MUT_AUTH := 1456     # server with RSA cert + mutual authentication
PORT_PSK_HINT := 1457     # PSK server with hint
PORT_PSK_NO_HINT := 1458  # PSK server without hint
PORT_WILDCHAR := 1459     # server with a certificate with a wild char
PORT_ECC_RSA:= 1480        # server with a EC cert signed by a RSA cert (DH_RSA ciphers)

PORT_CHAIN_LENGTH := 1481 # server with a illegal cert chain
# this uses a 4 length certificate chain: chain1_*_of_4.pem
# leaf is chain1_4_of_4.pem, CAfile is generated by cat chain1_3_of_4.pem chain1_2_of_4.pem chain1_1_of_4.pem > chain1_3_to_1.pem

PORT_CHAIN_LENGTH2 := 1482 # server with a illegal cert chain, CA cert not sent. used for 2 different tests see test code
# leaf is chain1_4_of_4.pem, CAfile is generated by cat chain1_3_of_4.pem chain1_2_of_4.pem > chain1_3_to_2.pem

PORT_ROGUE_CHAIN := 1483 # server with a rogue cert chain, CA is not signing the other certs
# leaf is chain1_4_of_4.pem, CAfile is generated by cat chain1_3_of_4.pem chain1_2_of_4.pem chain2_1_of_4.pem > chain1_3_to_2_to_chain2_1.pem

PORT_CHAIN_LENGTH3 := 1484 # server with a legal cert chain, that has cert path len constraints on all CAs
# leaf is chain2_4_of_4.pem, CAfile is generated by cat chain2_3_of_4.pem chain2_2_of_4.pem chain2_1_of_4.pem > chain2_3_to_1.pem

PORT_SRP := 1485 # SRP server

### CA and CRLs

CAKEY := ./CA/cakey.pem   # CA key
CACERT := ./CA/cacert.pem # CA cert
CADER := ./CA/cacert.der  # CA cert in DER format
CRL := mocana.crl		  # CRL file == cf. config.ssl
PORT_CRL:= 9000           # CRL server == cf. config.ssl

######################
# if you change the name of the der files, also modify ssl_cli_test.c
# in the test directory.
######################

ifneq (, $(findstring  1.,$(OPENSSL_VER)))
EC_DER_FILE := openssl_ec_cert.der
endif

DER_FILES := $(CADER) $(EC_DER_FILE)

KEY_FILES := $(KEY_FILE) $(WILDCHAR_KEY_FILE) $(REVOKED_KEY_FILE) \
	$(EC_KEY_FILE)

CERT_FILES := $(CERT_FILE) $(WILDCHAR_CERT_FILE) $(REVOKED_CERT_FILE) \
	$(EC_CERT_FILE) $(EC_RSA_CERT_FILE)

CERT_CHAINS:= $(CERT_CHAIN) $(WILDCHAR_CERT_CHAIN) $(REVOKED_CERT_CHAIN) \
	$(EC_RSA_CERT_CHAIN)

include ../../../unit_tests/makefile_osdetect.inc

ifeq ($(OS_NAME), CYGWIN)
PS_FLAGS := -W
endif

ifeq ($(OS_NAME), LINUX)
PS_FLAGS := -ef
endif

ifeq ($(OS_NAME), OSX)
PS_FLAGS := -ef
endif

ifeq ($(OS_NAME), SOLARIS)
PS_FLAGS := -ef
endif

ifeq ($(OS_NAME), OPENBSD)
PS_FLAGS := -auxw
endif

ifeq ($(OS_NAME), FREEBSD)
PS_FLAGS := -auxw
endif


all: cleanup_prev_files openssl_version crl $(DHPARAM_FILE) $(CERT_CHAINS) $(DER_FILES)

openssl_version:
	echo $(OPENSSL_VER) > $@

# cleanup previous files if necessary
ifneq ("$(wildcard crl.pem)","")
cleanup_prev_files: clean_certs_keys
	-rm crl.pem
else
cleanup_prev_files:
endif

##############  CRL
crl: $(CRL)

$(CRL): $(CACERT) $(REVOKED_CERT_FILE)
	-openssl ca -config config.ssl -revoke $(REVOKED_CERT_FILE)
	openssl ca -config config.ssl -gencrl -out $@.pem
	openssl crl -in $@.pem -out $@ -outform DER


## CA
CA/initialized:
	touch CA/index.txt
	echo '4011' > CA/serial
	touch $@

$(CAKEY): CA/initialized
	openssl genrsa -out $@ 2048

$(CACERT): $(CAKEY)
	openssl req -x509 -new -sha256 -days 7200 -key $(CAKEY) -out $@  -config config.ssl

$(CADER): $(CACERT)
	openssl x509 -in $< -inform PEM -out $@ -outform DER

##############  KEYS
$(KEY_FILE):
	openssl genrsa -out $@ $(BITS)

$(WILDCHAR_KEY_FILE):
	openssl genrsa -out $@ $(BITS)

$(REVOKED_KEY_FILE):
	openssl genrsa -out $@ $(BITS)

$(EC_KEY_FILE):
	openssl ecparam -name prime256v1 -genkey -out $@

############# DH_PARAMS

$(DHPARAM_FILE):
	openssl dhparam -2 -out $@ 2048

############# CERTS

$(CERT_FILE): $(KEY_FILE) $(CACERT)
	openssl req -new -key $< -out $@.csr \
-subj "/C=US/ST=California/L=San Francisco/O=Mocana/CN=ssltest.mocana.com"
	openssl ca -batch -config config.ssl -days 7200 -in $@.csr -out $@ -extensions v3_leaf

$(WILDCHAR_CERT_FILE): $(WILDCHAR_KEY_FILE) $(CACERT)
	openssl req -new -key $< -out $@.csr \
-subj "/C=US/ST=California/L=San Francisco/O=Mocana/CN=*.mocana.com"
	openssl ca -batch -config config.ssl -days 7200 -in $@.csr -out $@ -extensions v3_leaf

$(REVOKED_CERT_FILE): $(REVOKED_KEY_FILE) $(CACERT)
	openssl req -new -key $< -out $@.csr \
-subj "/C=US/ST=California/L=San Francisco/O=Mocana/CN=revoked_test.mocana.com"
	openssl ca -batch -config config.ssl -days 7200 -in $@.csr -out $@ -extensions v3_leaf

$(EC_RSA_CERT_FILE): $(EC_KEY_FILE) $(CACERT)
	openssl req -new  -key $< -out $@.csr \
-subj "/C=US/ST=California/L=San Francisco/O=Mocana/CN=ecdh_rsa_ciphers_test.mocana.com"
	openssl ca -batch -config config.ssl -days 7200 -in $@.csr -out $@ -extensions v3_leaf_ecc

$(EC_CERT_FILE): $(EC_KEY_FILE)
	openssl req -x509 -new -sha256 -days 7200 -key $< -out $@ -config config.ssl -extensions v3_ca_ecc

## CHAIN: pattern rule
openssl%chain.pem: openssl%cert.pem $(CACERT)
	cat $< $(CACERT) > $@

## DER: pattern rule
openssl_%.der: openssl_%.pem
	openssl x509 -in $< -inform PEM -out $@ -outform DER


.PHONY: run clean really_clean stop

stop: stop_all_openssl stop_all_ruby_httpd

stop_all_openssl:
	-ps $(PS_FLAGS) | \
    ruby -n -e 'begin;Process.kill(9, $$_.split()[1].to_i) if /openssl s_server/ && ! /make/;rescue;end;'

stop_all_ruby_httpd:
	-ps $(PS_FLAGS) | \
    ruby -n -e 'begin;Process.kill(9, $$_.split()[1].to_i) if /ruby -run -e httpd/ && ! /make/;rescue;end;'


run: start_all_openssl start_all_ruby_httpd

start_all_openssl: stop_all_openssl all

	(openssl s_server -accept $(PORT) -www -quiet \
     -cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
     -cert $(CERT_CHAIN) -key $(KEY_FILE) -dhparam $(DHPARAM_FILE) &)

	(openssl s_server -accept $(PORT_MUT_AUTH) -www -quiet \
     -cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
     -cert $(CERT_CHAIN) -key $(KEY_FILE) -dhparam $(DHPARAM_FILE) \
	-CAfile $(CERT_FILE) -Verify 1 &)

	(openssl s_server -ssl3 -accept $(PORT_SSLV3) -www -quiet \
     -cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
     -cert $(CERT_CHAIN) -key $(KEY_FILE) -dhparam $(DHPARAM_FILE) &)

	(openssl s_server -accept $(PORT_PSK_HINT) -www  -quiet \
     -cipher 'PSK' -psk 101112131415161718191a1b1c1d1e1f -psk_hint foobar \
     -nocert &)

	(openssl s_server -accept $(PORT_PSK_NO_HINT) -www -quiet \
     -cipher 'PSK' -psk 101112131415161718191a1b1c1d1e1f \
     -nocert &)

	(openssl s_server -accept $(PORT_WILDCHAR) -www -quiet \
	-cert $(WILDCHAR_CERT_CHAIN) -key $(WILDCHAR_KEY_FILE) -dhparam $(DHPARAM_FILE) &)

	(openssl s_server -accept $(PORT_CHAIN_LENGTH) -www -quiet \
	-cert chain1_4_of_4.pem -key chain1_key4_of_4.pem -CAfile chain1_3_to_1.pem &)

	(openssl s_server -accept $(PORT_CHAIN_LENGTH2) -www -quiet \
	-cert chain1_4_of_4.pem -key chain1_key4_of_4.pem -CAfile chain1_3_to_2.pem &)

	(openssl s_server -accept $(PORT_ROGUE_CHAIN) -www -quiet \
	-cert chain1_4_of_4.pem -key chain1_key4_of_4.pem -CAfile chain1_3_to_2_to_chain2_1.pem &)

	(openssl s_server -accept $(PORT_CHAIN_LENGTH3) -www -quiet \
	-cipher 'ALL:COMPLEMENTOFALL' -dhparam $(DHPARAM_FILE) \
	-cert chain2_4_of_4.pem -key chain2_key4_of_4.pem -CAfile chain2_3_to_1.pem &)


ifneq (, $(findstring  1.,$(OPENSSL_VER)))
	(openssl s_server -accept $(PORT_ECC_MUT_AUTH) -www -quiet \
     -cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
     -cert $(EC_CERT_FILE) -key $(EC_KEY_FILE) -dhparam $(DHPARAM_FILE) \
	 -CAfile $(EC_CERT_FILE) -Verify 1 &)

	(openssl s_server -accept $(PORT_ECC) -www -quiet \
    -cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
    -cert $(EC_CERT_FILE) -key $(EC_KEY_FILE) -dhparam $(DHPARAM_FILE) &)

	(openssl s_server -accept $(PORT_ECC_RSA) -www -quiet \
	-cipher 'ALL:COMPLEMENTOFALL:ECCdraft' \
	-cert $(EC_RSA_CERT_CHAIN) -key $(EC_KEY_FILE) -dhparam $(DHPARAM_FILE) &)
endif


start_all_ruby_httpd: stop_all_ruby_httpd all
#CRL server
	(ruby -run -e httpd . -p $(PORT_CRL) &)


clean:
	-rm -f openssl_version
	-rm -f $(CRL)    # make sure the CRL is generated from scratch

clean_certs_keys:
	-rm -f $(DER_FILES) $(KEY_FILES) $(CERT_FILES) $(CERT_CHAINS)
	-rm -rf CA
	-rm -rf *.csr

really_clean: clean clean_certs_keys
	-rm -f $(DHPARAM_FILE)
