/*
 * mocencode_cms_test.c
 *
 * CMS Encoder Unit Tests
 *
 * Copyright 2025 DigiCert Project Authors. All Rights Reserved.
 * 
 * DigiCert® TrustCore and TrustEdge are licensed under a dual-license model:
 * - **Open Source License**: GNU AGPL v3. See: https://github.com/digicert/trustcore-test/blob/main/LICENSE
 * - **Commercial License**: Available under DigiCert’s Master Services Agreement. See: https://github.com/digicert/trustcore-test/blob/main/LICENSE_COMMERCIAL.txt  
 *   or https://www.digicert.com/master-services-agreement/
 * 
 * *For commercial licensing, contact DigiCert at sales@digicert.com.*
 *
 */

#include "../../asn1/mocasn1.h"
#include "../../asn1/oiddefs.h"

#include "../../../unit_tests/unittest.h"
#include "../../common/mtypes.h"
#include "../../common/initmocana.h"
#include "../../crypto/pubcrypto.h"
#include "../../crypto/ca_mgmt.h"
#include "../../crypto/pkcs_common.h"
#include "../../crypto/pkcs_key.h"
#include "../../crypto/pkcs7.h"

#include "../../crypto/moccms.h"
#include "../../crypto/moccms_util.h"

#include "../../harness/harness.h"

#include <stdio.h>

/**************************************************************/

/* MOCK implementation of an RNG, always returning the same data.
 * This will make the output deterministic and testable
 */
static MSTATUS
MOCK_RNGFun(void* rngFunArg, ubyte4 length, ubyte *buffer)
{
    return DIGI_MEMSET (buffer, 0x55, length);
}

/**************************************************************/

typedef struct
{
   ubyte* buf;
   ubyte4 bufUsed;
   ubyte4 bufMax;
   intBoolean done;
} internal_test;

/* OID 1.2.840.113549.1.9.5  */
static ubyte PKCS9_SIGNINGTIME_OID[] =
{ 0x2A, 0x86, 0x48, 0x86, 0xF7, 0x0D, 0x01, 0x09, 0x05 };

/* OID 1.3.14.3.2.26 */
static ubyte NIST_SHA1_OID[] =
{ 0x2B, 0x0E, 0x03, 0x02, 0x1A };

/* OID 2.16.840.1.101.3.4.2.1 */
static ubyte NIST_SHA256_OID[] =
{ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01 };

/* OID 2.16.840.1.101.3.4.2.3 */
static ubyte NIST_SHA512_OID[] =
{ 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x03 };

/***************************************************************************************/

static MSTATUS
internal_verifyCallback(const void* arg,
                        MOC_CMS_context pCtx,
                        MOC_CMS_UpdateType type,
                        ubyte* pBuf,
                        ubyte4 bufLen)
{
    internal_test* t = (internal_test*)arg;

    if (E_MOC_CMS_ut_final == type)
    {
        FILE* tst = NULL;

        if (NULL != pBuf)
        {
            if (t->bufMax > (t->bufUsed + bufLen))
            {
                DIGI_MEMCPY(t->buf + t->bufUsed, pBuf, bufLen);
                t->bufUsed += bufLen;
            }
            else
            {
                return ERR_FALSE;
            }
        }

        t->done = TRUE;
#if 0
        /* For debugging the output */
        tst = fopen ("test_stream.cms", "wb");
        if (NULL != tst)
        {
            fwrite (t->buf, 1, t->bufUsed, tst);
            fclose (tst);
        }
#endif
    }
    else if (NULL != pBuf)
    {
        if (t->bufMax > (t->bufUsed + bufLen))
        {
            DIGI_MEMCPY(t->buf + t->bufUsed, pBuf, bufLen);
            t->bufUsed += bufLen;
        }
        else
        {
            return ERR_FALSE;
        }
    }

    return OK;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
      0x30, 0x82, 0x02, 0xd3, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
      0x01, 0x07, 0x02, 0xa0, 0x82, 0x02, 0xc4, 0x30, 0x82, 0x02, 0xc0, 0x02,
      0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
      0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
      0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09,
      0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0x31, 0x82, 0x02,
      0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56,
      0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55,
      0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07,
      0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06,
      0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61,
      0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
      0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06,
      0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30,
      0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44,
      0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04,
      0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
      0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a,
      0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd,
      0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9,
      0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b,
      0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d,
      0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c,
      0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda,
      0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a,
      0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed,
      0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b,
      0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17,
      0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9,
      0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd,
      0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4,
      0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1,
      0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3,
      0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94,
      0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56,
      0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43,
      0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce,
      0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac,
      0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6,
      0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2,
      0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc,
      0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75,
      0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca,
      0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64,
      0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f,
      0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa,
      0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91,
      0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05,
      0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b,
      0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2,
      0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88,
      0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2,
      0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40,
      0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c,
      0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71,
      0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d,
      0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18,
      0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e,
      0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51,
      0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c,
      0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddDigestDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x82, 0x02, 0xe2, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x02, 0xa0, 0x82, 0x02, 0xd3, 0x30, 0x82, 0x02, 0xcf, 0x02,
        0x01, 0x01, 0x31, 0x1e, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
        0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x60,
        0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x03, 0x05, 0x00, 0x30, 0x18,
        0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0,
        0x0b, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43,
        0x31, 0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30,
        0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06,
        0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04,
        0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11,
        0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b,
        0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55,
        0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11,
        0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41,
        0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a,
        0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
        0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a,
        0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82,
        0x02, 0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9,
        0xfb, 0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5,
        0xd9, 0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50,
        0x54, 0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5,
        0x06, 0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0,
        0xef, 0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb,
        0xf2, 0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3,
        0xe8, 0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe,
        0xbf, 0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea,
        0x86, 0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0,
        0x98, 0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16,
        0x60, 0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e,
        0x2d, 0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52,
        0x18, 0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a,
        0x9a, 0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21,
        0x80, 0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72,
        0x93, 0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb,
        0x63, 0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e,
        0x56, 0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59,
        0xbd, 0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73,
        0x55, 0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0,
        0x62, 0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26,
        0x8d, 0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf,
        0x78, 0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb,
        0x85, 0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1,
        0x77, 0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6,
        0x16, 0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03,
        0x9f, 0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b,
        0x9e, 0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1,
        0xa6, 0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14,
        0xfe, 0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8,
        0x47, 0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f,
        0x26, 0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b,
        0x39, 0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71,
        0xc5, 0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7,
        0xd5, 0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab,
        0x15, 0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6,
        0x20, 0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4,
        0x25, 0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6,
        0x93, 0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55,
        0x3e, 0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29,
        0x93, 0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8,
        0xe5, 0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Add another digest */
    status = DIGI_CMS_addDigest (ctx,
                                NIST_SHA512_OID,
                                sizeof(NIST_SHA512_OID));
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddRawSignatureDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    ubyte pRawTest[] = {
        0x30, 0x82, 0x02, 0x86, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31,
        0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53,
        0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46,
        0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e,
        0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06,
        0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39,
        0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10,
        0x30, 0x09, 0x06, 0x05, 0x2b, 0x0e, 0x03, 0x02, 0x1a, 0x05, 0x00, 0x30,
        0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01,
        0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0xaf, 0x33, 0xc4, 0x64, 0x7e, 0x63,
        0x8e, 0xc5, 0x80, 0x50, 0x1d, 0x6f, 0xa9, 0xc0, 0x1a, 0x46, 0x88, 0xe5,
        0x49, 0x4d, 0x9a, 0x5b, 0x67, 0x81, 0x24, 0x35, 0xa9, 0x4d, 0x5a, 0xa5,
        0x09, 0x5e, 0xd0, 0x30, 0xb5, 0x63, 0x66, 0xca, 0x0c, 0xfd, 0x85, 0xca,
        0xe1, 0x3f, 0xca, 0x09, 0x57, 0xca, 0xb1, 0xc2, 0x06, 0x44, 0x09, 0xb7,
        0xaa, 0xec, 0x67, 0x52, 0x94, 0xaa, 0x9b, 0xb1, 0x75, 0xe4, 0xff, 0x55,
        0xe6, 0xf3, 0xa1, 0xe4, 0xd9, 0xe6, 0xb6, 0x23, 0x54, 0xc2, 0x2e, 0x97,
        0x19, 0xbb, 0xc0, 0x19, 0xa7, 0x58, 0x37, 0x52, 0x7a, 0xaf, 0xed, 0x25,
        0xa1, 0x7e, 0xb2, 0xd1, 0xce, 0x95, 0xbe, 0x8b, 0x63, 0x43, 0xc4, 0xdf,
        0x46, 0x64, 0x55, 0x11, 0xf0, 0x9e, 0x3c, 0xf7, 0xe0, 0x9b, 0x68, 0x64,
        0x94, 0xdc, 0x95, 0x5d, 0x53, 0x4c, 0xb8, 0x00, 0x87, 0x47, 0x83, 0x69,
        0x90, 0xac, 0xc0, 0xd4, 0x72, 0x6e, 0xd5, 0xea, 0x3d, 0x69, 0x36, 0x40,
        0x5d, 0xab, 0x38, 0x19, 0x0a, 0x0e, 0xed, 0x05, 0xda, 0x33, 0xa9, 0x2d,
        0x65, 0x03, 0xb3, 0x62, 0x53, 0xed, 0xd8, 0x58, 0xc7, 0xe3, 0x9d, 0x5c,
        0x5d, 0x97, 0x05, 0x52, 0x2f, 0x22, 0xf7, 0xd5, 0x73, 0x13, 0x7e, 0x5a,
        0x40, 0x44, 0x5e, 0x23, 0x40, 0xd0, 0x77, 0xe1, 0x2a, 0xa5, 0x2f, 0x96,
        0xf4, 0x70, 0x01, 0x2c, 0x6a, 0x57, 0x32, 0x61, 0x81, 0x41, 0x5b, 0x29,
        0x75, 0x52, 0x93, 0xb2, 0x30, 0x94, 0x71, 0xe9, 0xaa, 0xb9, 0xbf, 0x62,
        0xce, 0xac, 0x31, 0xa0, 0x50, 0xc4, 0xbc, 0x04, 0x81, 0xc0, 0x7c, 0x6e,
        0x41, 0x67, 0xd5, 0xda, 0x84, 0xeb, 0x8a, 0x01, 0xe8, 0x52, 0xa1, 0xef,
        0x9a, 0x96, 0x79, 0xfd, 0xa4, 0x75, 0x9d, 0xbe, 0xe3, 0x96, 0x2e, 0x2d,
        0x2c, 0x19, 0x66, 0x42, 0xbf, 0x17, 0x0a, 0x1d, 0x3f, 0x88, 0xa9, 0x40,
        0xf5, 0xef, 0x41, 0x09, 0xc7, 0x0c, 0xf2, 0xbe, 0x68, 0x13, 0x21, 0x91,
        0x41, 0x0b, 0x62, 0x0b, 0x7f, 0x7f, 0x23, 0x53, 0x64, 0xbd, 0x34, 0x60,
        0xd7, 0x3e, 0xad, 0xd2, 0x56, 0x25, 0xa0, 0x47, 0x49, 0xa2, 0x82, 0x5d,
        0x5f, 0x64, 0x76, 0xce, 0x9f, 0x47, 0xc8, 0xb2, 0xb4, 0xd9, 0x30, 0x15,
        0x5a, 0xdb, 0xcd, 0x51, 0x1f, 0x77, 0x27, 0xbd, 0x73, 0xe1, 0x54, 0xb1,
        0xa6, 0x78, 0xd8, 0xca, 0xdb, 0xfe, 0xb4, 0x8f, 0xf0, 0x33, 0xb4, 0x05,
        0x57, 0xc1, 0x14, 0xea, 0x77, 0x6f, 0x81, 0xae, 0x1d, 0x08, 0x10, 0xca,
        0xeb, 0xf4, 0xb4, 0x79, 0xbc, 0x35, 0x86, 0xaf, 0x34, 0xc7, 0xf8, 0x6b,
        0xa3, 0x40, 0x2b, 0xb3, 0x39, 0xec, 0xf3, 0xf5, 0xbe, 0xf3, 0xef, 0x17,
        0xe4, 0x57, 0x1b, 0x80, 0xee, 0x88, 0x4c, 0x47, 0x0d, 0x63, 0xe6, 0x69,
        0x03, 0xea, 0xdc, 0xc6, 0x4b, 0xb5, 0x25, 0xa0, 0x71, 0xa7, 0x60, 0x41,
        0x29, 0x04, 0xff, 0x7c, 0x61, 0x27, 0x70, 0x64, 0xdb, 0x08, 0x98, 0x99,
        0x86, 0xd4, 0xad, 0xc6, 0xc8, 0x85, 0xa6, 0x95, 0xcb, 0x01, 0x1b, 0x58,
        0xb8, 0x42, 0xfd, 0x58, 0x82, 0x1a, 0x71, 0x8f, 0x2a, 0x9d, 0xe6, 0x2d,
        0xdd, 0x2b, 0xce, 0xc5, 0xe5, 0x03, 0x26, 0x95, 0x9c, 0x7e, 0x87, 0x90,
        0x7c, 0x70, 0xa4, 0x50, 0x5d, 0xea, 0xbc, 0xb9, 0x4f, 0x2f, 0xbf, 0xf3,
        0x3c, 0x61, 0x00, 0x09, 0xb9, 0x61, 0x08, 0x5c, 0xca, 0x28, 0xeb, 0x02,
        0x13, 0xad, 0x9c, 0xde, 0x8d, 0xd7, 0x3d, 0xdd, 0x3a, 0x81, 0x99, 0xaf,
        0x4e, 0xcd, 0x92, 0x45, 0x41, 0x82, 0xd3, 0x87, 0x1a, 0x10, 0x55, 0xae,
        0xa6, 0x1d, 0x3c, 0x3b, 0x55, 0xab, 0x44, 0x1a, 0x96, 0x4b, 0x25, 0xe5,
        0x40, 0x82, 0x60, 0x58, 0x16, 0xb1, 0x0a, 0x7e, 0xe7, 0x75, 0x06, 0x12,
        0x7e, 0xa0
    };

    /* Expected data */
    ubyte test_signed_cms[] = {
          0x30, 0x82, 0x05, 0x68, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
          0x01, 0x07, 0x02, 0xa0, 0x82, 0x05, 0x59, 0x30, 0x82, 0x05, 0x55, 0x02,
          0x01, 0x01, 0x31, 0x1a, 0x30, 0x09, 0x06, 0x05, 0x2b, 0x0e, 0x03, 0x02,
          0x1a, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
          0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a, 0x86,
          0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09, 0x41,
          0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0x31, 0x82, 0x05, 0x18,
          0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31,
          0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53,
          0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46,
          0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
          0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e,
          0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06,
          0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
          0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39,
          0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10,
          0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02,
          0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
          0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec,
          0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd, 0x1b,
          0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9, 0x58,
          0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f,
          0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea,
          0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c, 0xc2,
          0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda, 0xc6,
          0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5,
          0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea,
          0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b, 0xd1,
          0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17, 0x10,
          0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a,
          0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31,
          0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4, 0x18,
          0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1, 0xfe,
          0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98,
          0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68,
          0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56, 0xf7,
          0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43, 0xf0,
          0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb,
          0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5,
          0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6, 0xdb,
          0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2, 0xd8,
          0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63,
          0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3,
          0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca, 0x4c,
          0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64, 0x44,
          0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76,
          0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82,
          0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91, 0x8b,
          0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05, 0xd9,
          0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71,
          0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12,
          0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88, 0x99,
          0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2, 0xb0,
          0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4,
          0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70,
          0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71, 0x27,
          0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d, 0x96,
          0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57,
          0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c,
          0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51, 0xf4,
          0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c, 0x13,
          0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x30, 0x82, 0x02, 0x86, 0x02, 0x01,
          0x01, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55,
          0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03,
          0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61,
          0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c,
          0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06,
          0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
          0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52,
          0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52,
          0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x09, 0x06, 0x05, 0x2b, 0x0e,
          0x03, 0x02, 0x1a, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48,
          0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00,
          0xaf, 0x33, 0xc4, 0x64, 0x7e, 0x63, 0x8e, 0xc5, 0x80, 0x50, 0x1d, 0x6f,
          0xa9, 0xc0, 0x1a, 0x46, 0x88, 0xe5, 0x49, 0x4d, 0x9a, 0x5b, 0x67, 0x81,
          0x24, 0x35, 0xa9, 0x4d, 0x5a, 0xa5, 0x09, 0x5e, 0xd0, 0x30, 0xb5, 0x63,
          0x66, 0xca, 0x0c, 0xfd, 0x85, 0xca, 0xe1, 0x3f, 0xca, 0x09, 0x57, 0xca,
          0xb1, 0xc2, 0x06, 0x44, 0x09, 0xb7, 0xaa, 0xec, 0x67, 0x52, 0x94, 0xaa,
          0x9b, 0xb1, 0x75, 0xe4, 0xff, 0x55, 0xe6, 0xf3, 0xa1, 0xe4, 0xd9, 0xe6,
          0xb6, 0x23, 0x54, 0xc2, 0x2e, 0x97, 0x19, 0xbb, 0xc0, 0x19, 0xa7, 0x58,
          0x37, 0x52, 0x7a, 0xaf, 0xed, 0x25, 0xa1, 0x7e, 0xb2, 0xd1, 0xce, 0x95,
          0xbe, 0x8b, 0x63, 0x43, 0xc4, 0xdf, 0x46, 0x64, 0x55, 0x11, 0xf0, 0x9e,
          0x3c, 0xf7, 0xe0, 0x9b, 0x68, 0x64, 0x94, 0xdc, 0x95, 0x5d, 0x53, 0x4c,
          0xb8, 0x00, 0x87, 0x47, 0x83, 0x69, 0x90, 0xac, 0xc0, 0xd4, 0x72, 0x6e,
          0xd5, 0xea, 0x3d, 0x69, 0x36, 0x40, 0x5d, 0xab, 0x38, 0x19, 0x0a, 0x0e,
          0xed, 0x05, 0xda, 0x33, 0xa9, 0x2d, 0x65, 0x03, 0xb3, 0x62, 0x53, 0xed,
          0xd8, 0x58, 0xc7, 0xe3, 0x9d, 0x5c, 0x5d, 0x97, 0x05, 0x52, 0x2f, 0x22,
          0xf7, 0xd5, 0x73, 0x13, 0x7e, 0x5a, 0x40, 0x44, 0x5e, 0x23, 0x40, 0xd0,
          0x77, 0xe1, 0x2a, 0xa5, 0x2f, 0x96, 0xf4, 0x70, 0x01, 0x2c, 0x6a, 0x57,
          0x32, 0x61, 0x81, 0x41, 0x5b, 0x29, 0x75, 0x52, 0x93, 0xb2, 0x30, 0x94,
          0x71, 0xe9, 0xaa, 0xb9, 0xbf, 0x62, 0xce, 0xac, 0x31, 0xa0, 0x50, 0xc4,
          0xbc, 0x04, 0x81, 0xc0, 0x7c, 0x6e, 0x41, 0x67, 0xd5, 0xda, 0x84, 0xeb,
          0x8a, 0x01, 0xe8, 0x52, 0xa1, 0xef, 0x9a, 0x96, 0x79, 0xfd, 0xa4, 0x75,
          0x9d, 0xbe, 0xe3, 0x96, 0x2e, 0x2d, 0x2c, 0x19, 0x66, 0x42, 0xbf, 0x17,
          0x0a, 0x1d, 0x3f, 0x88, 0xa9, 0x40, 0xf5, 0xef, 0x41, 0x09, 0xc7, 0x0c,
          0xf2, 0xbe, 0x68, 0x13, 0x21, 0x91, 0x41, 0x0b, 0x62, 0x0b, 0x7f, 0x7f,
          0x23, 0x53, 0x64, 0xbd, 0x34, 0x60, 0xd7, 0x3e, 0xad, 0xd2, 0x56, 0x25,
          0xa0, 0x47, 0x49, 0xa2, 0x82, 0x5d, 0x5f, 0x64, 0x76, 0xce, 0x9f, 0x47,
          0xc8, 0xb2, 0xb4, 0xd9, 0x30, 0x15, 0x5a, 0xdb, 0xcd, 0x51, 0x1f, 0x77,
          0x27, 0xbd, 0x73, 0xe1, 0x54, 0xb1, 0xa6, 0x78, 0xd8, 0xca, 0xdb, 0xfe,
          0xb4, 0x8f, 0xf0, 0x33, 0xb4, 0x05, 0x57, 0xc1, 0x14, 0xea, 0x77, 0x6f,
          0x81, 0xae, 0x1d, 0x08, 0x10, 0xca, 0xeb, 0xf4, 0xb4, 0x79, 0xbc, 0x35,
          0x86, 0xaf, 0x34, 0xc7, 0xf8, 0x6b, 0xa3, 0x40, 0x2b, 0xb3, 0x39, 0xec,
          0xf3, 0xf5, 0xbe, 0xf3, 0xef, 0x17, 0xe4, 0x57, 0x1b, 0x80, 0xee, 0x88,
          0x4c, 0x47, 0x0d, 0x63, 0xe6, 0x69, 0x03, 0xea, 0xdc, 0xc6, 0x4b, 0xb5,
          0x25, 0xa0, 0x71, 0xa7, 0x60, 0x41, 0x29, 0x04, 0xff, 0x7c, 0x61, 0x27,
          0x70, 0x64, 0xdb, 0x08, 0x98, 0x99, 0x86, 0xd4, 0xad, 0xc6, 0xc8, 0x85,
          0xa6, 0x95, 0xcb, 0x01, 0x1b, 0x58, 0xb8, 0x42, 0xfd, 0x58, 0x82, 0x1a,
          0x71, 0x8f, 0x2a, 0x9d, 0xe6, 0x2d, 0xdd, 0x2b, 0xce, 0xc5, 0xe5, 0x03,
          0x26, 0x95, 0x9c, 0x7e, 0x87, 0x90, 0x7c, 0x70, 0xa4, 0x50, 0x5d, 0xea,
          0xbc, 0xb9, 0x4f, 0x2f, 0xbf, 0xf3, 0x3c, 0x61, 0x00, 0x09, 0xb9, 0x61,
          0x08, 0x5c, 0xca, 0x28, 0xeb, 0x02, 0x13, 0xad, 0x9c, 0xde, 0x8d, 0xd7,
          0x3d, 0xdd, 0x3a, 0x81, 0x99, 0xaf, 0x4e, 0xcd, 0x92, 0x45, 0x41, 0x82,
          0xd3, 0x87, 0x1a, 0x10, 0x55, 0xae, 0xa6, 0x1d, 0x3c, 0x3b, 0x55, 0xab,
          0x44, 0x1a, 0x96, 0x4b, 0x25, 0xe5, 0x40, 0x82, 0x60, 0x58, 0x16, 0xb1,
          0x0a, 0x7e, 0xe7, 0x75, 0x06, 0x12, 0x7e, 0xa0
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Add another digest */
    status = DIGI_CMS_addDigest (ctx,
                                NIST_SHA1_OID,
                                sizeof(NIST_SHA1_OID));
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    /* Add another signature's DER */
    status = DIGI_CMS_addSignatureRaw (ctx,
                                      pRawTest,
                                      sizeof(pRawTest));
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddActionDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x82, 0x08, 0x5a, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x02, 0xa0, 0x82, 0x08, 0x4b, 0x30, 0x82, 0x08, 0x47, 0x02,
        0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
        0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
        0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09,
        0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0xa0, 0x82, 0x05,
        0x83, 0x30, 0x82, 0x05, 0x7f, 0x30, 0x82, 0x03, 0x67, 0xa0, 0x03, 0x02,
        0x01, 0x02, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44,
        0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x01, 0x0b, 0x05, 0x00, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06,
        0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08,
        0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08,
        0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x1e, 0x17, 0x0d,
        0x31, 0x38, 0x30, 0x31, 0x32, 0x39, 0x31, 0x35, 0x31, 0x36, 0x30, 0x38,
        0x5a, 0x17, 0x0d, 0x32, 0x38, 0x30, 0x31, 0x32, 0x37, 0x31, 0x35, 0x31,
        0x36, 0x30, 0x38, 0x5a, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06,
        0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08,
        0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08,
        0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x82, 0x02, 0x22,
        0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
        0x01, 0x05, 0x00, 0x03, 0x82, 0x02, 0x0f, 0x00, 0x30, 0x82, 0x02, 0x0a,
        0x02, 0x82, 0x02, 0x01, 0x00, 0xbc, 0x6f, 0x96, 0x11, 0x49, 0x79, 0x6b,
        0xbb, 0xc9, 0x59, 0x48, 0xc5, 0xaa, 0x19, 0x58, 0xb9, 0xce, 0x06, 0xc3,
        0xaa, 0x43, 0x9e, 0xa0, 0xc4, 0xb7, 0x6d, 0x84, 0x55, 0x5b, 0xe7, 0x01,
        0x38, 0x54, 0x28, 0x75, 0x80, 0x20, 0x85, 0x8b, 0x71, 0xfa, 0x49, 0x5b,
        0x8a, 0x55, 0x74, 0x91, 0x63, 0xab, 0xb1, 0x4d, 0xae, 0xae, 0x35, 0xe5,
        0x29, 0x86, 0xb1, 0x7e, 0x32, 0xa7, 0x8d, 0x8d, 0x6f, 0xaa, 0xe8, 0x20,
        0x5b, 0xaa, 0x63, 0xa1, 0xc9, 0xef, 0x7c, 0x02, 0x7d, 0xaa, 0x80, 0x2a,
        0xb3, 0x0a, 0xaa, 0x28, 0x36, 0xfa, 0x86, 0xfb, 0x79, 0x6e, 0xc9, 0xa7,
        0x9f, 0xdb, 0x13, 0x23, 0x15, 0x05, 0x89, 0x45, 0x62, 0x04, 0x65, 0x05,
        0x10, 0x66, 0x5c, 0x83, 0xe9, 0xed, 0x43, 0xed, 0x2b, 0xe8, 0xf8, 0x4a,
        0xb0, 0xd3, 0xb6, 0xec, 0x0e, 0xb1, 0xd3, 0xdb, 0x06, 0x24, 0xc8, 0xa6,
        0xed, 0x5a, 0xaa, 0xb2, 0x6d, 0xc6, 0x5a, 0x45, 0x70, 0x12, 0xd5, 0x16,
        0xbc, 0xff, 0xad, 0xd6, 0x0e, 0x49, 0x18, 0xae, 0xa9, 0x99, 0xf7, 0xb9,
        0x19, 0x1f, 0xe4, 0x05, 0x15, 0x62, 0x0f, 0xe1, 0xe4, 0x3d, 0x98, 0x46,
        0x29, 0x4a, 0xf1, 0x76, 0x7d, 0x49, 0xb9, 0xfe, 0x09, 0xce, 0xb6, 0xa2,
        0x13, 0xe8, 0x4c, 0x53, 0x4e, 0xf0, 0x9c, 0xec, 0x8a, 0xe2, 0x86, 0x72,
        0xf4, 0x1c, 0x9d, 0x50, 0xac, 0x50, 0x9f, 0xbd, 0x9d, 0xc8, 0xd1, 0x09,
        0xb5, 0xd7, 0x43, 0x4e, 0x5d, 0xda, 0x3c, 0x0a, 0x6f, 0x63, 0xfd, 0xa2,
        0x54, 0x6e, 0x34, 0xb8, 0xcc, 0xbc, 0x96, 0x10, 0x3a, 0x5f, 0x23, 0xb4,
        0x67, 0x69, 0x12, 0x7e, 0x9e, 0x28, 0x17, 0x23, 0xe4, 0x81, 0x3b, 0x98,
        0x66, 0xa0, 0x97, 0xab, 0xf4, 0x6f, 0x18, 0x85, 0x6e, 0xf1, 0x21, 0x9f,
        0xe8, 0x2b, 0x62, 0x26, 0x22, 0x2c, 0x23, 0xb1, 0xa2, 0xa1, 0x68, 0xcb,
        0xdd, 0x20, 0x9c, 0xcd, 0x5a, 0xbc, 0xef, 0x20, 0x0b, 0x12, 0xcd, 0x54,
        0x73, 0x0f, 0x7d, 0xeb, 0x48, 0xe7, 0x4c, 0x83, 0x97, 0xb9, 0xd2, 0xa7,
        0x9f, 0xc6, 0x52, 0xa1, 0x43, 0x9e, 0x19, 0x05, 0x95, 0x17, 0xb2, 0xbd,
        0x7a, 0xb2, 0x27, 0xac, 0xac, 0x50, 0x3e, 0x51, 0xd5, 0x34, 0x4f, 0x5a,
        0x35, 0x83, 0x19, 0x10, 0x92, 0x21, 0x10, 0xab, 0x55, 0x97, 0xfc, 0x1c,
        0x52, 0xaf, 0x2a, 0x1e, 0x11, 0x62, 0x1f, 0xb9, 0xe9, 0xea, 0x9f, 0x0f,
        0x29, 0x6c, 0xd9, 0x6a, 0xaa, 0xb8, 0x7a, 0xc5, 0xd1, 0x4e, 0xc0, 0xf8,
        0x1c, 0xd8, 0x77, 0x43, 0xb4, 0xfa, 0x8d, 0x69, 0x75, 0xb2, 0x9c, 0xa6,
        0x50, 0x2f, 0xa6, 0x90, 0x36, 0x70, 0xcc, 0xe6, 0x67, 0x59, 0xc1, 0xf7,
        0x9b, 0x0b, 0x0f, 0x90, 0xfe, 0x6a, 0x4b, 0x6c, 0x6c, 0xb7, 0x4e, 0xe1,
        0x13, 0x08, 0x98, 0x74, 0xe6, 0x08, 0xb5, 0x35, 0x28, 0xee, 0x0f, 0x70,
        0x7f, 0xe7, 0x01, 0x13, 0xc8, 0x5f, 0x9b, 0x21, 0x89, 0xad, 0xbe, 0xd8,
        0xbd, 0x9e, 0x3f, 0x71, 0x88, 0x4e, 0xa8, 0x93, 0xe5, 0x43, 0xa1, 0x65,
        0xef, 0x54, 0x62, 0x1b, 0x56, 0x8a, 0x1e, 0x93, 0x5e, 0x7e, 0xde, 0xf2,
        0xd3, 0xc1, 0x9e, 0xe3, 0x52, 0x5b, 0x21, 0xca, 0x3e, 0x37, 0xd6, 0x1c,
        0x5a, 0x8a, 0x86, 0x43, 0xb2, 0x24, 0x65, 0x15, 0x58, 0xc3, 0xcc, 0xd6,
        0x8a, 0x56, 0x5c, 0x4c, 0x27, 0xe2, 0x35, 0xfc, 0x63, 0x67, 0xd7, 0x8b,
        0x1d, 0x02, 0x71, 0xe5, 0xa3, 0x20, 0xf7, 0xe4, 0xad, 0xd6, 0x53, 0xfc,
        0x8d, 0x84, 0xa4, 0x53, 0xbb, 0x5b, 0xa5, 0x5f, 0x00, 0xaa, 0xc8, 0x0d,
        0xdc, 0x38, 0xd2, 0x78, 0x18, 0xa7, 0xe2, 0x25, 0xd5, 0xac, 0x87, 0x28,
        0xf1, 0x69, 0x6b, 0xae, 0x07, 0xc0, 0xa0, 0x61, 0x34, 0x89, 0x49, 0x59,
        0xcd, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3, 0x50, 0x30, 0x4e, 0x30, 0x1d,
        0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0x23, 0xf6, 0xea,
        0x1b, 0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda,
        0xbf, 0xab, 0x3d, 0x97, 0xfb, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d, 0x23,
        0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x23, 0xf6, 0xea, 0x1b, 0x1b, 0x30,
        0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda, 0xbf, 0xab, 0x3d,
        0x97, 0xfb, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04, 0x05, 0x30,
        0x03, 0x01, 0x01, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
        0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x03, 0x82, 0x02, 0x01, 0x00,
        0x22, 0xb8, 0xf4, 0xf8, 0x91, 0x8e, 0x0c, 0x14, 0x14, 0x5b, 0x0f, 0x61,
        0x43, 0x25, 0xba, 0x0f, 0xf4, 0x28, 0x4e, 0xc8, 0x60, 0xd6, 0xe4, 0x4c,
        0x64, 0xa5, 0x64, 0x2b, 0x0e, 0xd3, 0x87, 0xbd, 0xd6, 0x6a, 0x15, 0x03,
        0xf2, 0xdc, 0x0b, 0xf9, 0xb9, 0x7c, 0x58, 0x59, 0x13, 0xe8, 0x66, 0xde,
        0x87, 0xe8, 0x02, 0xa8, 0xfe, 0x3b, 0x13, 0x5c, 0x25, 0x74, 0xb5, 0x74,
        0x37, 0x3d, 0x20, 0x69, 0xdb, 0xdd, 0x9d, 0x9f, 0x53, 0x1e, 0xeb, 0xc2,
        0xe2, 0xaa, 0xcb, 0x93, 0x2c, 0x47, 0x9a, 0xf3, 0xf3, 0x86, 0xfd, 0xf2,
        0xed, 0x0b, 0xba, 0x9e, 0x20, 0x6c, 0x05, 0x42, 0x55, 0xd2, 0x14, 0xdd,
        0xc5, 0x4b, 0x1e, 0x4b, 0x5c, 0xe1, 0xe4, 0x4f, 0xd8, 0x5a, 0x1c, 0xb8,
        0xfc, 0x62, 0xa5, 0xd3, 0x11, 0xaa, 0x4b, 0x6b, 0xe0, 0xd8, 0x30, 0x94,
        0xc3, 0x0b, 0x66, 0xa6, 0x82, 0xe3, 0x66, 0x48, 0xba, 0x77, 0x9f, 0x85,
        0x9e, 0xfb, 0x6d, 0x92, 0x25, 0x3f, 0x3b, 0xf5, 0x56, 0x9f, 0xa9, 0x24,
        0x5d, 0x40, 0x10, 0xc5, 0x55, 0x8b, 0xd2, 0xef, 0x08, 0x75, 0xbd, 0xcb,
        0xd9, 0x6f, 0xa1, 0x09, 0x52, 0x82, 0x43, 0xb9, 0x39, 0x23, 0xbe, 0xc0,
        0xd0, 0xdc, 0xf5, 0x91, 0xd8, 0xff, 0x2c, 0x39, 0x21, 0x49, 0x9c, 0xd4,
        0x92, 0x38, 0x53, 0x89, 0x32, 0xa8, 0xf4, 0x1d, 0xb5, 0x3a, 0x0e, 0x58,
        0xe2, 0x33, 0x9d, 0x27, 0xc8, 0x64, 0x53, 0x54, 0xd6, 0xe7, 0x9d, 0x29,
        0x37, 0x8d, 0xba, 0x8d, 0x84, 0xa3, 0x43, 0x37, 0x3d, 0x5e, 0x78, 0x0c,
        0xa1, 0x75, 0x91, 0x76, 0x62, 0x75, 0xe2, 0xf4, 0xe1, 0x2d, 0xca, 0xd2,
        0x9b, 0x92, 0x64, 0xdd, 0x9d, 0x5f, 0xec, 0x23, 0x7a, 0x80, 0xb2, 0x39,
        0xd9, 0x32, 0xfc, 0xd5, 0xe2, 0x73, 0x3d, 0xd0, 0xd3, 0x5b, 0x7a, 0x32,
        0xcc, 0xc6, 0xe1, 0xea, 0x44, 0xaa, 0xc3, 0x0a, 0xd1, 0x34, 0x3a, 0x2c,
        0xba, 0x61, 0x90, 0xff, 0x83, 0xf0, 0x0b, 0x27, 0x69, 0x24, 0x18, 0x9b,
        0x9d, 0xd3, 0xa0, 0x29, 0x39, 0x94, 0xd1, 0xaf, 0xad, 0x13, 0xe4, 0x08,
        0xb4, 0x4a, 0x44, 0xdf, 0xc9, 0xca, 0x19, 0x7a, 0xd5, 0x45, 0xd2, 0x05,
        0xfb, 0xe7, 0xfc, 0xf6, 0x4c, 0x29, 0xc8, 0xfd, 0x6b, 0x29, 0xb1, 0x89,
        0x11, 0xb3, 0xc5, 0xdd, 0xe1, 0x9c, 0x5a, 0xca, 0xd6, 0xca, 0x25, 0x9b,
        0x29, 0xc5, 0x5e, 0xd9, 0x1e, 0x1f, 0x89, 0x9a, 0x73, 0x18, 0x6d, 0x5d,
        0x31, 0x2a, 0x50, 0x52, 0x87, 0xf4, 0x48, 0x56, 0xba, 0x5e, 0x5f, 0xba,
        0x90, 0x98, 0x63, 0xcb, 0x15, 0xac, 0xad, 0x3e, 0x21, 0x1b, 0x17, 0x5b,
        0x89, 0xc0, 0x6c, 0xb2, 0x09, 0x57, 0x76, 0x1c, 0xcb, 0x32, 0xfa, 0x41,
        0xd3, 0xf7, 0xe3, 0x37, 0xd7, 0xf9, 0x92, 0x4b, 0x75, 0x92, 0xe0, 0x53,
        0xb9, 0x00, 0x56, 0xdb, 0xa5, 0xbf, 0x42, 0x31, 0x26, 0x15, 0xf0, 0xb5,
        0xa9, 0x87, 0x92, 0x61, 0x3f, 0x3b, 0x24, 0xf5, 0x1e, 0x94, 0xb5, 0x1c,
        0xd0, 0xcf, 0x24, 0x24, 0x50, 0x52, 0x69, 0x87, 0x1a, 0x24, 0xd1, 0x38,
        0xac, 0x3d, 0xb8, 0x51, 0xc6, 0x73, 0xd4, 0xf8, 0xae, 0x37, 0x1f, 0x41,
        0xe5, 0x00, 0xaa, 0x34, 0xf0, 0x38, 0xa1, 0xe7, 0x25, 0xe0, 0x26, 0x54,
        0x38, 0x19, 0x63, 0xa9, 0xd2, 0x19, 0x24, 0xa9, 0x05, 0x11, 0x10, 0x76,
        0xa9, 0x8f, 0x01, 0x2e, 0x97, 0x03, 0x06, 0xb6, 0x9b, 0x7d, 0xde, 0x71,
        0x85, 0x9b, 0xc5, 0xd5, 0x3e, 0xe2, 0x26, 0x5c, 0xf0, 0x67, 0x1d, 0xc3,
        0x62, 0x87, 0xb4, 0x20, 0x36, 0xd0, 0x90, 0xd5, 0xb0, 0xb7, 0xca, 0xf7,
        0x89, 0xce, 0x60, 0xa2, 0x3e, 0xf5, 0xd1, 0x5a, 0x48, 0x13, 0x50, 0x17,
        0x08, 0x5e, 0x9c, 0x98, 0x89, 0x32, 0xb4, 0x29, 0x31, 0x82, 0x02, 0x8e,
        0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31,
        0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53,
        0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46,
        0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e,
        0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06,
        0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39,
        0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10,
        0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02,
        0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
        0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec,
        0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd, 0x1b,
        0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9, 0x58,
        0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f,
        0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea,
        0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c, 0xc2,
        0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda, 0xc6,
        0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5,
        0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea,
        0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b, 0xd1,
        0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17, 0x10,
        0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a,
        0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31,
        0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4, 0x18,
        0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1, 0xfe,
        0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98,
        0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68,
        0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56, 0xf7,
        0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43, 0xf0,
        0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb,
        0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5,
        0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6, 0xdb,
        0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2, 0xd8,
        0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63,
        0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3,
        0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca, 0x4c,
        0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64, 0x44,
        0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76,
        0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82,
        0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91, 0x8b,
        0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05, 0xd9,
        0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71,
        0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12,
        0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88, 0x99,
        0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2, 0xb0,
        0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4,
        0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70,
        0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71, 0x27,
        0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d, 0x96,
        0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57,
        0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c,
        0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51, 0xf4,
        0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c, 0x13,
        0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 4096;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_addCert,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddCertificateDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x82, 0x08, 0x5a, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x02, 0xa0, 0x82, 0x08, 0x4b, 0x30, 0x82, 0x08, 0x47, 0x02,
        0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
        0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
        0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09,
        0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0xa0, 0x82, 0x05,
        0x83, 0x30, 0x82, 0x05, 0x7f, 0x30, 0x82, 0x03, 0x67, 0xa0, 0x03, 0x02,
        0x01, 0x02, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44,
        0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x01, 0x0b, 0x05, 0x00, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06,
        0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08,
        0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08,
        0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x1e, 0x17, 0x0d,
        0x31, 0x38, 0x30, 0x31, 0x32, 0x39, 0x31, 0x35, 0x31, 0x36, 0x30, 0x38,
        0x5a, 0x17, 0x0d, 0x32, 0x38, 0x30, 0x31, 0x32, 0x37, 0x31, 0x35, 0x31,
        0x36, 0x30, 0x38, 0x5a, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06,
        0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08,
        0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08,
        0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x82, 0x02, 0x22,
        0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
        0x01, 0x05, 0x00, 0x03, 0x82, 0x02, 0x0f, 0x00, 0x30, 0x82, 0x02, 0x0a,
        0x02, 0x82, 0x02, 0x01, 0x00, 0xbc, 0x6f, 0x96, 0x11, 0x49, 0x79, 0x6b,
        0xbb, 0xc9, 0x59, 0x48, 0xc5, 0xaa, 0x19, 0x58, 0xb9, 0xce, 0x06, 0xc3,
        0xaa, 0x43, 0x9e, 0xa0, 0xc4, 0xb7, 0x6d, 0x84, 0x55, 0x5b, 0xe7, 0x01,
        0x38, 0x54, 0x28, 0x75, 0x80, 0x20, 0x85, 0x8b, 0x71, 0xfa, 0x49, 0x5b,
        0x8a, 0x55, 0x74, 0x91, 0x63, 0xab, 0xb1, 0x4d, 0xae, 0xae, 0x35, 0xe5,
        0x29, 0x86, 0xb1, 0x7e, 0x32, 0xa7, 0x8d, 0x8d, 0x6f, 0xaa, 0xe8, 0x20,
        0x5b, 0xaa, 0x63, 0xa1, 0xc9, 0xef, 0x7c, 0x02, 0x7d, 0xaa, 0x80, 0x2a,
        0xb3, 0x0a, 0xaa, 0x28, 0x36, 0xfa, 0x86, 0xfb, 0x79, 0x6e, 0xc9, 0xa7,
        0x9f, 0xdb, 0x13, 0x23, 0x15, 0x05, 0x89, 0x45, 0x62, 0x04, 0x65, 0x05,
        0x10, 0x66, 0x5c, 0x83, 0xe9, 0xed, 0x43, 0xed, 0x2b, 0xe8, 0xf8, 0x4a,
        0xb0, 0xd3, 0xb6, 0xec, 0x0e, 0xb1, 0xd3, 0xdb, 0x06, 0x24, 0xc8, 0xa6,
        0xed, 0x5a, 0xaa, 0xb2, 0x6d, 0xc6, 0x5a, 0x45, 0x70, 0x12, 0xd5, 0x16,
        0xbc, 0xff, 0xad, 0xd6, 0x0e, 0x49, 0x18, 0xae, 0xa9, 0x99, 0xf7, 0xb9,
        0x19, 0x1f, 0xe4, 0x05, 0x15, 0x62, 0x0f, 0xe1, 0xe4, 0x3d, 0x98, 0x46,
        0x29, 0x4a, 0xf1, 0x76, 0x7d, 0x49, 0xb9, 0xfe, 0x09, 0xce, 0xb6, 0xa2,
        0x13, 0xe8, 0x4c, 0x53, 0x4e, 0xf0, 0x9c, 0xec, 0x8a, 0xe2, 0x86, 0x72,
        0xf4, 0x1c, 0x9d, 0x50, 0xac, 0x50, 0x9f, 0xbd, 0x9d, 0xc8, 0xd1, 0x09,
        0xb5, 0xd7, 0x43, 0x4e, 0x5d, 0xda, 0x3c, 0x0a, 0x6f, 0x63, 0xfd, 0xa2,
        0x54, 0x6e, 0x34, 0xb8, 0xcc, 0xbc, 0x96, 0x10, 0x3a, 0x5f, 0x23, 0xb4,
        0x67, 0x69, 0x12, 0x7e, 0x9e, 0x28, 0x17, 0x23, 0xe4, 0x81, 0x3b, 0x98,
        0x66, 0xa0, 0x97, 0xab, 0xf4, 0x6f, 0x18, 0x85, 0x6e, 0xf1, 0x21, 0x9f,
        0xe8, 0x2b, 0x62, 0x26, 0x22, 0x2c, 0x23, 0xb1, 0xa2, 0xa1, 0x68, 0xcb,
        0xdd, 0x20, 0x9c, 0xcd, 0x5a, 0xbc, 0xef, 0x20, 0x0b, 0x12, 0xcd, 0x54,
        0x73, 0x0f, 0x7d, 0xeb, 0x48, 0xe7, 0x4c, 0x83, 0x97, 0xb9, 0xd2, 0xa7,
        0x9f, 0xc6, 0x52, 0xa1, 0x43, 0x9e, 0x19, 0x05, 0x95, 0x17, 0xb2, 0xbd,
        0x7a, 0xb2, 0x27, 0xac, 0xac, 0x50, 0x3e, 0x51, 0xd5, 0x34, 0x4f, 0x5a,
        0x35, 0x83, 0x19, 0x10, 0x92, 0x21, 0x10, 0xab, 0x55, 0x97, 0xfc, 0x1c,
        0x52, 0xaf, 0x2a, 0x1e, 0x11, 0x62, 0x1f, 0xb9, 0xe9, 0xea, 0x9f, 0x0f,
        0x29, 0x6c, 0xd9, 0x6a, 0xaa, 0xb8, 0x7a, 0xc5, 0xd1, 0x4e, 0xc0, 0xf8,
        0x1c, 0xd8, 0x77, 0x43, 0xb4, 0xfa, 0x8d, 0x69, 0x75, 0xb2, 0x9c, 0xa6,
        0x50, 0x2f, 0xa6, 0x90, 0x36, 0x70, 0xcc, 0xe6, 0x67, 0x59, 0xc1, 0xf7,
        0x9b, 0x0b, 0x0f, 0x90, 0xfe, 0x6a, 0x4b, 0x6c, 0x6c, 0xb7, 0x4e, 0xe1,
        0x13, 0x08, 0x98, 0x74, 0xe6, 0x08, 0xb5, 0x35, 0x28, 0xee, 0x0f, 0x70,
        0x7f, 0xe7, 0x01, 0x13, 0xc8, 0x5f, 0x9b, 0x21, 0x89, 0xad, 0xbe, 0xd8,
        0xbd, 0x9e, 0x3f, 0x71, 0x88, 0x4e, 0xa8, 0x93, 0xe5, 0x43, 0xa1, 0x65,
        0xef, 0x54, 0x62, 0x1b, 0x56, 0x8a, 0x1e, 0x93, 0x5e, 0x7e, 0xde, 0xf2,
        0xd3, 0xc1, 0x9e, 0xe3, 0x52, 0x5b, 0x21, 0xca, 0x3e, 0x37, 0xd6, 0x1c,
        0x5a, 0x8a, 0x86, 0x43, 0xb2, 0x24, 0x65, 0x15, 0x58, 0xc3, 0xcc, 0xd6,
        0x8a, 0x56, 0x5c, 0x4c, 0x27, 0xe2, 0x35, 0xfc, 0x63, 0x67, 0xd7, 0x8b,
        0x1d, 0x02, 0x71, 0xe5, 0xa3, 0x20, 0xf7, 0xe4, 0xad, 0xd6, 0x53, 0xfc,
        0x8d, 0x84, 0xa4, 0x53, 0xbb, 0x5b, 0xa5, 0x5f, 0x00, 0xaa, 0xc8, 0x0d,
        0xdc, 0x38, 0xd2, 0x78, 0x18, 0xa7, 0xe2, 0x25, 0xd5, 0xac, 0x87, 0x28,
        0xf1, 0x69, 0x6b, 0xae, 0x07, 0xc0, 0xa0, 0x61, 0x34, 0x89, 0x49, 0x59,
        0xcd, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3, 0x50, 0x30, 0x4e, 0x30, 0x1d,
        0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0x23, 0xf6, 0xea,
        0x1b, 0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda,
        0xbf, 0xab, 0x3d, 0x97, 0xfb, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d, 0x23,
        0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x23, 0xf6, 0xea, 0x1b, 0x1b, 0x30,
        0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda, 0xbf, 0xab, 0x3d,
        0x97, 0xfb, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04, 0x05, 0x30,
        0x03, 0x01, 0x01, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
        0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x03, 0x82, 0x02, 0x01, 0x00,
        0x22, 0xb8, 0xf4, 0xf8, 0x91, 0x8e, 0x0c, 0x14, 0x14, 0x5b, 0x0f, 0x61,
        0x43, 0x25, 0xba, 0x0f, 0xf4, 0x28, 0x4e, 0xc8, 0x60, 0xd6, 0xe4, 0x4c,
        0x64, 0xa5, 0x64, 0x2b, 0x0e, 0xd3, 0x87, 0xbd, 0xd6, 0x6a, 0x15, 0x03,
        0xf2, 0xdc, 0x0b, 0xf9, 0xb9, 0x7c, 0x58, 0x59, 0x13, 0xe8, 0x66, 0xde,
        0x87, 0xe8, 0x02, 0xa8, 0xfe, 0x3b, 0x13, 0x5c, 0x25, 0x74, 0xb5, 0x74,
        0x37, 0x3d, 0x20, 0x69, 0xdb, 0xdd, 0x9d, 0x9f, 0x53, 0x1e, 0xeb, 0xc2,
        0xe2, 0xaa, 0xcb, 0x93, 0x2c, 0x47, 0x9a, 0xf3, 0xf3, 0x86, 0xfd, 0xf2,
        0xed, 0x0b, 0xba, 0x9e, 0x20, 0x6c, 0x05, 0x42, 0x55, 0xd2, 0x14, 0xdd,
        0xc5, 0x4b, 0x1e, 0x4b, 0x5c, 0xe1, 0xe4, 0x4f, 0xd8, 0x5a, 0x1c, 0xb8,
        0xfc, 0x62, 0xa5, 0xd3, 0x11, 0xaa, 0x4b, 0x6b, 0xe0, 0xd8, 0x30, 0x94,
        0xc3, 0x0b, 0x66, 0xa6, 0x82, 0xe3, 0x66, 0x48, 0xba, 0x77, 0x9f, 0x85,
        0x9e, 0xfb, 0x6d, 0x92, 0x25, 0x3f, 0x3b, 0xf5, 0x56, 0x9f, 0xa9, 0x24,
        0x5d, 0x40, 0x10, 0xc5, 0x55, 0x8b, 0xd2, 0xef, 0x08, 0x75, 0xbd, 0xcb,
        0xd9, 0x6f, 0xa1, 0x09, 0x52, 0x82, 0x43, 0xb9, 0x39, 0x23, 0xbe, 0xc0,
        0xd0, 0xdc, 0xf5, 0x91, 0xd8, 0xff, 0x2c, 0x39, 0x21, 0x49, 0x9c, 0xd4,
        0x92, 0x38, 0x53, 0x89, 0x32, 0xa8, 0xf4, 0x1d, 0xb5, 0x3a, 0x0e, 0x58,
        0xe2, 0x33, 0x9d, 0x27, 0xc8, 0x64, 0x53, 0x54, 0xd6, 0xe7, 0x9d, 0x29,
        0x37, 0x8d, 0xba, 0x8d, 0x84, 0xa3, 0x43, 0x37, 0x3d, 0x5e, 0x78, 0x0c,
        0xa1, 0x75, 0x91, 0x76, 0x62, 0x75, 0xe2, 0xf4, 0xe1, 0x2d, 0xca, 0xd2,
        0x9b, 0x92, 0x64, 0xdd, 0x9d, 0x5f, 0xec, 0x23, 0x7a, 0x80, 0xb2, 0x39,
        0xd9, 0x32, 0xfc, 0xd5, 0xe2, 0x73, 0x3d, 0xd0, 0xd3, 0x5b, 0x7a, 0x32,
        0xcc, 0xc6, 0xe1, 0xea, 0x44, 0xaa, 0xc3, 0x0a, 0xd1, 0x34, 0x3a, 0x2c,
        0xba, 0x61, 0x90, 0xff, 0x83, 0xf0, 0x0b, 0x27, 0x69, 0x24, 0x18, 0x9b,
        0x9d, 0xd3, 0xa0, 0x29, 0x39, 0x94, 0xd1, 0xaf, 0xad, 0x13, 0xe4, 0x08,
        0xb4, 0x4a, 0x44, 0xdf, 0xc9, 0xca, 0x19, 0x7a, 0xd5, 0x45, 0xd2, 0x05,
        0xfb, 0xe7, 0xfc, 0xf6, 0x4c, 0x29, 0xc8, 0xfd, 0x6b, 0x29, 0xb1, 0x89,
        0x11, 0xb3, 0xc5, 0xdd, 0xe1, 0x9c, 0x5a, 0xca, 0xd6, 0xca, 0x25, 0x9b,
        0x29, 0xc5, 0x5e, 0xd9, 0x1e, 0x1f, 0x89, 0x9a, 0x73, 0x18, 0x6d, 0x5d,
        0x31, 0x2a, 0x50, 0x52, 0x87, 0xf4, 0x48, 0x56, 0xba, 0x5e, 0x5f, 0xba,
        0x90, 0x98, 0x63, 0xcb, 0x15, 0xac, 0xad, 0x3e, 0x21, 0x1b, 0x17, 0x5b,
        0x89, 0xc0, 0x6c, 0xb2, 0x09, 0x57, 0x76, 0x1c, 0xcb, 0x32, 0xfa, 0x41,
        0xd3, 0xf7, 0xe3, 0x37, 0xd7, 0xf9, 0x92, 0x4b, 0x75, 0x92, 0xe0, 0x53,
        0xb9, 0x00, 0x56, 0xdb, 0xa5, 0xbf, 0x42, 0x31, 0x26, 0x15, 0xf0, 0xb5,
        0xa9, 0x87, 0x92, 0x61, 0x3f, 0x3b, 0x24, 0xf5, 0x1e, 0x94, 0xb5, 0x1c,
        0xd0, 0xcf, 0x24, 0x24, 0x50, 0x52, 0x69, 0x87, 0x1a, 0x24, 0xd1, 0x38,
        0xac, 0x3d, 0xb8, 0x51, 0xc6, 0x73, 0xd4, 0xf8, 0xae, 0x37, 0x1f, 0x41,
        0xe5, 0x00, 0xaa, 0x34, 0xf0, 0x38, 0xa1, 0xe7, 0x25, 0xe0, 0x26, 0x54,
        0x38, 0x19, 0x63, 0xa9, 0xd2, 0x19, 0x24, 0xa9, 0x05, 0x11, 0x10, 0x76,
        0xa9, 0x8f, 0x01, 0x2e, 0x97, 0x03, 0x06, 0xb6, 0x9b, 0x7d, 0xde, 0x71,
        0x85, 0x9b, 0xc5, 0xd5, 0x3e, 0xe2, 0x26, 0x5c, 0xf0, 0x67, 0x1d, 0xc3,
        0x62, 0x87, 0xb4, 0x20, 0x36, 0xd0, 0x90, 0xd5, 0xb0, 0xb7, 0xca, 0xf7,
        0x89, 0xce, 0x60, 0xa2, 0x3e, 0xf5, 0xd1, 0x5a, 0x48, 0x13, 0x50, 0x17,
        0x08, 0x5e, 0x9c, 0x98, 0x89, 0x32, 0xb4, 0x29, 0x31, 0x82, 0x02, 0x8e,
        0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31,
        0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53,
        0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46,
        0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e,
        0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06,
        0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03,
        0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39,
        0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10,
        0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02,
        0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
        0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec,
        0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd, 0x1b,
        0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9, 0x58,
        0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f,
        0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea,
        0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c, 0xc2,
        0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda, 0xc6,
        0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5,
        0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea,
        0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b, 0xd1,
        0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17, 0x10,
        0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a,
        0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31,
        0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4, 0x18,
        0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1, 0xfe,
        0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98,
        0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68,
        0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56, 0xf7,
        0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43, 0xf0,
        0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb,
        0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5,
        0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6, 0xdb,
        0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2, 0xd8,
        0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63,
        0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3,
        0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca, 0x4c,
        0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64, 0x44,
        0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76,
        0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82,
        0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91, 0x8b,
        0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05, 0xd9,
        0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71,
        0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12,
        0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88, 0x99,
        0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2, 0xb0,
        0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4,
        0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70,
        0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71, 0x27,
        0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d, 0x96,
        0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57,
        0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c,
        0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51, 0xf4,
        0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c, 0x13,
        0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 4096;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    /* Add certificate after data */
    status = DIGI_CMS_addCertificate (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (22, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddCRLDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* FAKE string */
    ubyte CRL[] = {
         0x0C, 28,
            'h', 't', 't', 'p', 's', ':', '/', '/', 'c', 'r',
            'l', '.', 'm', 'c', 'o', 'm', 'p', 'a', 'n', 'y',
            '.', 'c', 'o', 'm', '/', 'C', 'R', 'L'
    };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x82, 0x02, 0xf3, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x02, 0xa0, 0x82, 0x02, 0xe4, 0x30, 0x82, 0x02, 0xe0, 0x02,
        0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
        0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
        0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09,
        0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0xa1, 0x1e, 0x0c,
        0x1c, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x2f, 0x2f, 0x63, 0x72, 0x6c,
        0x2e, 0x6d, 0x63, 0x6f, 0x6d, 0x70, 0x61, 0x6e, 0x79, 0x2e, 0x63, 0x6f,
        0x6d, 0x2f, 0x43, 0x52, 0x4c, 0x31, 0x82, 0x02, 0x8e, 0x30, 0x82, 0x02,
        0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09,
        0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30,
        0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
        0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07,
        0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f,
        0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63,
        0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
        0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09,
        0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06,
        0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00,
        0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
        0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8,
        0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6,
        0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9, 0x58, 0x76, 0x57, 0x17,
        0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0,
        0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef,
        0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06,
        0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f,
        0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c,
        0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2,
        0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2,
        0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17, 0x10, 0x68, 0x94, 0x1a,
        0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06,
        0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc,
        0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e,
        0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2,
        0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28,
        0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c,
        0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea,
        0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31,
        0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81,
        0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74,
        0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b,
        0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb,
        0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09,
        0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44,
        0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23,
        0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64, 0x44, 0x9b, 0x98, 0x92,
        0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52,
        0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc,
        0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f,
        0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89,
        0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6,
        0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6,
        0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7,
        0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42,
        0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd,
        0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f,
        0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71, 0x27, 0x64, 0xd5, 0x71,
        0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f,
        0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91,
        0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6,
        0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f,
        0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02,
        0xc2, 0x48, 0xac
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 4096;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    /* Add FAKE CRL after data */
    status = DIGI_CMS_addCRL (ctx, CRL, sizeof(CRL));
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (22, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextTwoDigestsDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };


    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data w/ SHA256 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Set signer data w/ SHA1 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA1_OID,
                                sizeof(NIST_SHA1_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextTwoSignersDefinite()
{
#if (defined(__ENABLE_DIGICERT_DSA__))
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key1 = { 0 };
    struct AsymmetricKey key2 = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    unsigned char test_signed_cms[] = {
      0x30, 0x82, 0x03, 0xe7, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
      0x01, 0x07, 0x02, 0xa0, 0x82, 0x03, 0xd8, 0x30, 0x82, 0x03, 0xd4, 0x02,
      0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01,
      0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
      0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09,
      0x41, 0x55, 0x54, 0x48, 0x45, 0x4e, 0x54, 0x49, 0x43, 0x31, 0x82, 0x03,
      0xa2, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30, 0x56,
      0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55,
      0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07,
      0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06,
      0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61,
      0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
      0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06,
      0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30,
      0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44,
      0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04,
      0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
      0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a,
      0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd,
      0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9,
      0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b,
      0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d,
      0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c,
      0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda,
      0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a,
      0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed,
      0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b,
      0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17,
      0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9,
      0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd,
      0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4,
      0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1,
      0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3,
      0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94,
      0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56,
      0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43,
      0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce,
      0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac,
      0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6,
      0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2,
      0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc,
      0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75,
      0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca,
      0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64,
      0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f,
      0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa,
      0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91,
      0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05,
      0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b,
      0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2,
      0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88,
      0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2,
      0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40,
      0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c,
      0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71,
      0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d,
      0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18,
      0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e,
      0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51,
      0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c,
      0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x30, 0x82, 0x01, 0x10, 0x02,
      0x01, 0x01, 0x30, 0x81, 0xbb, 0x30, 0x81, 0xad, 0x31, 0x0b, 0x30, 0x09,
      0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x13, 0x30,
      0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x13, 0x0a, 0x43, 0x61, 0x6c, 0x69,
      0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31, 0x16, 0x30, 0x14, 0x06, 0x03,
      0x55, 0x04, 0x07, 0x13, 0x0d, 0x53, 0x61, 0x6e, 0x20, 0x46, 0x72, 0x61,
      0x6e, 0x63, 0x69, 0x73, 0x63, 0x6f, 0x31, 0x1b, 0x30, 0x19, 0x06, 0x03,
      0x55, 0x04, 0x0a, 0x13, 0x12, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x20,
      0x43, 0x6f, 0x72, 0x70, 0x6f, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x31,
      0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x13, 0x0b, 0x45, 0x6e,
      0x67, 0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x31, 0x1b, 0x30,
      0x19, 0x06, 0x03, 0x55, 0x04, 0x03, 0x13, 0x12, 0x73, 0x73, 0x6c, 0x74,
      0x65, 0x73, 0x74, 0x2e, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63,
      0x6f, 0x6d, 0x31, 0x21, 0x30, 0x1f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
      0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x12, 0x66, 0x61, 0x62, 0x72, 0x69,
      0x63, 0x65, 0x40, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f,
      0x6d, 0x02, 0x09, 0x00, 0xc8, 0x10, 0x13, 0x9b, 0x21, 0x4a, 0xb2, 0x59,
      0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02,
      0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
      0x03, 0x04, 0x03, 0x02, 0x05, 0x00, 0x04, 0x2f, 0x30, 0x2d, 0x02, 0x15,
      0x00, 0x84, 0x82, 0xd1, 0x26, 0x95, 0xb7, 0xae, 0x04, 0x33, 0x14, 0xfa,
      0x0e, 0xb3, 0xbe, 0x05, 0xe1, 0xf0, 0xac, 0x3b, 0x45, 0x02, 0x14, 0x1f,
      0xa2, 0xc6, 0xd2, 0xd8, 0x4e, 0x6a, 0x41, 0x03, 0xea, 0x15, 0xe7, 0x45,
      0x3e, 0x53, 0x2c, 0x22, 0x7d, 0x3f, 0x47
    };

    CRYPTO_initAsymmetricKey (&key1);
    CRYPTO_initAsymmetricKey (&key2);

    /* Read key 1 */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key1);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate 1 */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data #1 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key1,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read key 2 */
    status = DIGICERT_readFile("dsa_keyblobFile.dat", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = CA_MGMT_extractKeyBlobEx (pCert, certLen, &key2);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate 2 */
    status = DIGICERT_readFile("dsacert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Set signer data #2 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key2,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key1, NULL);
    CRYPTO_uninitAsymmetricKey (&key2, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
#else
    printf("**** DSA signature tests disabled!\n");
    return 0;
#endif
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextThreeSignersDefinite()
{
#if (defined(__ENABLE_DIGICERT_ECC__) && defined(__ENABLE_DIGICERT_DSA__))
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key1 = { 0 };
    struct AsymmetricKey key2 = { 0 };
    struct AsymmetricKey key3 = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    unsigned char test_signed_cms[] =
    {
        0x30, 0x82, 0x05, 0x65, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x02, 0xa0,
        0x82, 0x05, 0x56, 0x30, 0x82, 0x05, 0x52, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x09,
        0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x18, 0x06, 0x09, 0x2a,
        0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x0b, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
        0x45, 0x4e, 0x54, 0x49, 0x43, 0x31, 0x82, 0x05, 0x20, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01,
        0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55,
        0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
        0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61,
        0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c,
        0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
        0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd,
        0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04,
        0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01,
        0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a,
        0xa9, 0xfb, 0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9,
        0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0,
        0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5,
        0xa0, 0xef, 0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda,
        0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c,
        0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7,
        0xea, 0x86, 0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17,
        0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06,
        0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21,
        0x52, 0x18, 0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1,
        0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28,
        0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91,
        0xbb, 0x63, 0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43,
        0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81,
        0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22,
        0xe0, 0x62, 0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2,
        0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09,
        0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9,
        0xd1, 0x77, 0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64,
        0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52,
        0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9,
        0xf1, 0xa6, 0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05,
        0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6,
        0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c,
        0x0b, 0x39, 0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2,
        0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd,
        0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd,
        0xe6, 0x20, 0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d,
        0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91,
        0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28,
        0x29, 0x93, 0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c,
        0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x30, 0x82, 0x01, 0x10, 0x02, 0x01, 0x01, 0x30, 0x81,
        0xbb, 0x30, 0x81, 0xad, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55,
        0x53, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x13, 0x0a, 0x43, 0x61, 0x6c, 0x69,
        0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31, 0x16, 0x30, 0x14, 0x06, 0x03, 0x55, 0x04, 0x07, 0x13,
        0x0d, 0x53, 0x61, 0x6e, 0x20, 0x46, 0x72, 0x61, 0x6e, 0x63, 0x69, 0x73, 0x63, 0x6f, 0x31, 0x1b,
        0x30, 0x19, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x13, 0x12, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x20,
        0x43, 0x6f, 0x72, 0x70, 0x6f, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x31, 0x14, 0x30, 0x12, 0x06,
        0x03, 0x55, 0x04, 0x0b, 0x13, 0x0b, 0x45, 0x6e, 0x67, 0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e,
        0x67, 0x31, 0x1b, 0x30, 0x19, 0x06, 0x03, 0x55, 0x04, 0x03, 0x13, 0x12, 0x73, 0x73, 0x6c, 0x74,
        0x65, 0x73, 0x74, 0x2e, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f, 0x6d, 0x31, 0x21,
        0x30, 0x1f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x12, 0x66,
        0x61, 0x62, 0x72, 0x69, 0x63, 0x65, 0x40, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f,
        0x6d, 0x02, 0x09, 0x00, 0xc8, 0x10, 0x13, 0x9b, 0x21, 0x4a, 0xb2, 0x59, 0x30, 0x0d, 0x06, 0x09,
        0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x60,
        0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x03, 0x02, 0x05, 0x00, 0x04, 0x2f, 0x30, 0x2d, 0x02, 0x15,
        0x00, 0x84, 0x82, 0xd1, 0x26, 0x95, 0xb7, 0xae, 0x04, 0x33, 0x14, 0xfa, 0x0e, 0xb3, 0xbe, 0x05,
        0xe1, 0xf0, 0xac, 0x3b, 0x45, 0x02, 0x14, 0x1f, 0xa2, 0xc6, 0xd2, 0xd8, 0x4e, 0x6a, 0x41, 0x03,
        0xea, 0x15, 0xe7, 0x45, 0x3e, 0x53, 0x2c, 0x22, 0x7d, 0x3f, 0x47, 0x30, 0x82, 0x01, 0x7a, 0x02,
        0x01, 0x01, 0x30, 0x81, 0xc9, 0x30, 0x81, 0xb0, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04,
        0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x13, 0x0a,
        0x43, 0x61, 0x6c, 0x69, 0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31, 0x16, 0x30, 0x14, 0x06, 0x03,
        0x55, 0x04, 0x07, 0x13, 0x0d, 0x53, 0x61, 0x6e, 0x20, 0x46, 0x72, 0x61, 0x6e, 0x63, 0x69, 0x73,
        0x63, 0x6f, 0x31, 0x21, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x13, 0x18, 0x45, 0x6e, 0x67,
        0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x20, 0x43, 0x41, 0x20, 0x28, 0x45, 0x43, 0x43,
        0x20, 0x35, 0x32, 0x31, 0x29, 0x31, 0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x13, 0x0b,
        0x45, 0x6e, 0x67, 0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x31, 0x1b, 0x30, 0x19, 0x06,
        0x03, 0x55, 0x04, 0x03, 0x13, 0x12, 0x73, 0x73, 0x6c, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x6d, 0x6f,
        0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f, 0x6d, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x0f, 0x69, 0x6e, 0x66, 0x6f, 0x40, 0x6d, 0x6f,
        0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f, 0x6d, 0x02, 0x14, 0x73, 0xeb, 0x15, 0xcd, 0xea, 0xc6,
        0xdc, 0x4c, 0x5c, 0xa8, 0x67, 0x27, 0xde, 0x8f, 0x77, 0x22, 0x31, 0x60, 0x6d, 0xf0, 0x30, 0x0d,
        0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0c, 0x06,
        0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x05, 0x00, 0x04, 0x81, 0x8b, 0x30, 0x81,
        0x88, 0x02, 0x42, 0x00, 0xe8, 0x8c, 0xed, 0x68, 0x14, 0x0e, 0x42, 0x87, 0xda, 0x04, 0x21, 0xe1,
        0xd5, 0x5e, 0xff, 0xaa, 0x96, 0xad, 0xf7, 0x0e, 0x51, 0x40, 0x34, 0x2a, 0xe2, 0x81, 0xc3, 0x74,
        0xd0, 0xfc, 0xf2, 0x72, 0x2b, 0x3e, 0xe0, 0x3a, 0x32, 0xe4, 0xb7, 0x12, 0x9a, 0xd8, 0xbf, 0xee,
        0x65, 0x51, 0x4b, 0x56, 0x93, 0xf7, 0x90, 0x4a, 0xe9, 0x65, 0x37, 0xbf, 0x1d, 0xe3, 0xb6, 0xaa,
        0xe2, 0x44, 0x6b, 0x41, 0x6a, 0x02, 0x42, 0x01, 0x2f, 0x7d, 0x33, 0xe9, 0x68, 0xa9, 0x84, 0x55,
        0x08, 0xcb, 0x6d, 0x2a, 0xfb, 0xc4, 0xf1, 0x00, 0x52, 0xde, 0x19, 0x6b, 0x46, 0xd9, 0x9a, 0x9a,
        0xff, 0xd0, 0xd5, 0x56, 0x1d, 0x1f, 0x50, 0x7a, 0xce, 0x7e, 0x9f, 0x8a, 0xec, 0x92, 0x90, 0x4b,
        0xa7, 0xed, 0x08, 0x7a, 0x03, 0x71, 0xdb, 0x3f, 0x91, 0x8d, 0x86, 0xc8, 0x87, 0x6f, 0x79, 0x8b,
        0x32, 0x30, 0xcc, 0x4a, 0xb2, 0x0f, 0x3a, 0xd1, 0x6f
    };

    CRYPTO_initAsymmetricKey (&key1);
    CRYPTO_initAsymmetricKey (&key2);
    CRYPTO_initAsymmetricKey (&key3);

    /* Read key 1 */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key1);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate 1 */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data #1 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key1,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read key 2 */
    status = DIGICERT_readFile("dsa_keyblobFile.dat", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = CA_MGMT_extractKeyBlobEx (pCert, certLen, &key2);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate 2 */
    status = DIGICERT_readFile("dsacert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Set signer data #2 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key2,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read key 3 */
    status = DIGICERT_readFile("ecc_keyblobFile.dat", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = CA_MGMT_extractKeyBlobEx (pCert, certLen, &key3);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate 3 */
    status = DIGICERT_readFile("ecc_selfcert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Set signer data #3 */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key3,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;
    
    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key1, NULL);
    CRYPTO_uninitAsymmetricKey (&key2, NULL);
    CRYPTO_uninitAsymmetricKey (&key3, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
#else
    printf("**** DSA signature or ECDSA signatures tests disabled!\n");
    return 0;
#endif
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    ubyte test_signed_cms[] = {
      0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
      0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
      0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
      0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
      0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
      0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
      0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63,
      0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
      0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
      0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
      0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
      0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
      0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
      0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
      0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
      0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
      0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb,
      0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9,
      0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54,
      0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06,
      0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef,
      0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2,
      0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8,
      0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf,
      0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86,
      0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98,
      0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60,
      0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d,
      0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18,
      0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a,
      0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80,
      0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93,
      0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63,
      0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56,
      0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd,
      0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55,
      0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62,
      0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d,
      0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78,
      0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85,
      0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77,
      0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16,
      0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f,
      0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e,
      0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6,
      0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe,
      0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47,
      0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26,
      0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39,
      0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5,
      0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5,
      0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15,
      0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20,
      0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25,
      0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93,
      0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e,
      0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93,
      0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5,
      0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextWithAuthAttributeIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Fixed Data */
    TimeDate fakeTime = { 2015, 11, 11, 11, 0, 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    ubyte test_signed_cms[] = {
        0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
        0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
        0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
        0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
        0x82, 0x02, 0xf9, 0x30, 0x82, 0x02, 0xf5, 0x02, 0x01, 0x01, 0x30, 0x63,
        0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
        0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
        0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
        0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
        0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
        0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
        0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
        0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
        0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
        0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0xa0, 0x69, 0x30, 0x1c, 0x06, 0x09,
        0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x05, 0x31, 0x0f, 0x17,
        0x0d, 0x38, 0x35, 0x31, 0x31, 0x31, 0x31, 0x31, 0x31, 0x30, 0x30, 0x30,
        0x30, 0x5a, 0x30, 0x18, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x09, 0x03, 0x31, 0x0b, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
        0x0d, 0x01, 0x07, 0x01, 0x30, 0x2f, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
        0xf7, 0x0d, 0x01, 0x09, 0x04, 0x31, 0x22, 0x04, 0x20, 0x44, 0x0a, 0xee,
        0x12, 0x99, 0xa0, 0xf7, 0xe9, 0xdf, 0x52, 0x5e, 0x87, 0xd0, 0x68, 0x4f,
        0x3f, 0xa1, 0x92, 0x8e, 0x02, 0xc4, 0x01, 0xb6, 0xcd, 0x39, 0x9a, 0xbb,
        0x3d, 0xac, 0x5d, 0x01, 0xf3, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48,
        0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00,
        0x33, 0xce, 0x35, 0x8c, 0xdb, 0x66, 0x46, 0xb8, 0xac, 0xb7, 0xf4, 0x1d,
        0x96, 0xca, 0x5c, 0x70, 0x73, 0x9d, 0x4a, 0xdc, 0xde, 0xfe, 0xf5, 0x3e,
        0x48, 0x2b, 0x6b, 0x51, 0x77, 0xdf, 0xf2, 0x97, 0x03, 0xc2, 0x12, 0x21,
        0xfa, 0x29, 0x4d, 0x53, 0xde, 0x6f, 0xc6, 0x36, 0x31, 0x87, 0xf8, 0xc9,
        0xc0, 0xc3, 0x74, 0x64, 0xd8, 0x26, 0x9e, 0xb8, 0x04, 0xc6, 0xc7, 0x58,
        0x28, 0x27, 0x53, 0x37, 0x2c, 0xb4, 0xb4, 0x3a, 0xb5, 0x2a, 0xd0, 0x8e,
        0x5a, 0x36, 0xfe, 0x13, 0xac, 0x17, 0xaa, 0x3a, 0x15, 0x40, 0x5a, 0x16,
        0x3a, 0x22, 0x14, 0x53, 0x5b, 0xf9, 0x60, 0xe4, 0xd7, 0xc4, 0x76, 0x3b,
        0xe8, 0x1d, 0x13, 0x9b, 0xec, 0x0b, 0x43, 0x4f, 0xa1, 0xc8, 0x8c, 0x22,
        0x1c, 0x2f, 0x8d, 0x65, 0xab, 0xeb, 0xec, 0xae, 0xbc, 0x18, 0x35, 0x41,
        0xff, 0x00, 0xa5, 0xc8, 0x99, 0x3f, 0x39, 0xea, 0x26, 0x52, 0xf3, 0x32,
        0x36, 0x67, 0x69, 0x9c, 0x0d, 0xc5, 0x73, 0xb2, 0x4f, 0xe2, 0xd5, 0xeb,
        0x28, 0xcb, 0x7d, 0x07, 0xe3, 0x43, 0xf4, 0x18, 0xc4, 0x42, 0xf8, 0x22,
        0x57, 0xe6, 0xb1, 0x7e, 0x68, 0x87, 0x89, 0x61, 0xa9, 0xc9, 0x2c, 0xa2,
        0x19, 0x8b, 0xdf, 0xfb, 0xa3, 0x3f, 0xae, 0x01, 0x80, 0x88, 0x71, 0xe7,
        0x6b, 0xfc, 0x32, 0x99, 0xcc, 0x9c, 0x6a, 0x57, 0xbb, 0x93, 0x08, 0x4d,
        0xed, 0xd7, 0xdd, 0x53, 0x3f, 0xe1, 0x59, 0x3a, 0x4e, 0x1f, 0x9b, 0x3e,
        0xa2, 0x05, 0xb5, 0xf3, 0x79, 0xac, 0xc4, 0xf5, 0xaa, 0x16, 0x8e, 0xa3,
        0x6d, 0xbd, 0xb2, 0x00, 0xff, 0xdb, 0x51, 0x23, 0x9d, 0xd2, 0x7d, 0x42,
        0x86, 0x9e, 0x06, 0xbc, 0x25, 0x64, 0xcb, 0xf1, 0x5e, 0x4b, 0x74, 0x55,
        0x39, 0x47, 0x0a, 0xe6, 0x7a, 0x2c, 0x6f, 0x83, 0x9f, 0x84, 0xac, 0x3d,
        0x53, 0x68, 0x90, 0xd7, 0x77, 0xab, 0xd3, 0x4f, 0xbe, 0x24, 0x12, 0xaa,
        0xed, 0x83, 0xad, 0xdb, 0x14, 0x01, 0xb6, 0x58, 0x36, 0x79, 0xec, 0xf1,
        0x47, 0xa2, 0xe2, 0xdc, 0xc9, 0xf6, 0x76, 0xfe, 0x0e, 0xf4, 0xfd, 0x68,
        0x9e, 0x3b, 0xfd, 0xb7, 0x3e, 0x07, 0xf9, 0x98, 0xc0, 0xf0, 0xa3, 0x24,
        0x1c, 0x65, 0x30, 0xcc, 0x9d, 0x89, 0x3e, 0xbe, 0x5b, 0x79, 0xe5, 0xd5,
        0x0c, 0x98, 0xc1, 0x0f, 0x53, 0x14, 0xa7, 0x1d, 0xdb, 0xea, 0xef, 0x94,
        0x0c, 0xd2, 0xff, 0x24, 0x1a, 0x53, 0xab, 0x51, 0x10, 0x4b, 0x73, 0x7f,
        0x56, 0x79, 0xf1, 0xb3, 0xb4, 0x14, 0x29, 0x30, 0xaf, 0xa5, 0x97, 0x9e,
        0x79, 0xd0, 0xb8, 0x20, 0xd3, 0xcf, 0xd4, 0x60, 0x5b, 0x43, 0xa2, 0xe8,
        0x83, 0x05, 0xb5, 0xdb, 0x6b, 0x91, 0xb6, 0xbd, 0xa2, 0xcd, 0x69, 0x68,
        0xb6, 0xd4, 0x7e, 0x80, 0x6d, 0xb9, 0x87, 0x65, 0xd8, 0xc4, 0x45, 0x88,
        0x80, 0xb8, 0xa1, 0x2f, 0x4e, 0x13, 0x51, 0x13, 0x73, 0x91, 0xef, 0xee,
        0x48, 0x1a, 0xd0, 0xbf, 0x74, 0x1c, 0xc0, 0x24, 0xfc, 0x0b, 0x85, 0xf9,
        0x8f, 0xdb, 0x82, 0xcb, 0x47, 0x2a, 0x15, 0xab, 0xda, 0xdf, 0x39, 0xba,
        0x90, 0x3a, 0x2a, 0x2d, 0xae, 0x42, 0x26, 0x0a, 0x6a, 0xe6, 0x7c, 0x03,
        0xea, 0x5d, 0x2a, 0x89, 0xea, 0xe3, 0x2e, 0x55, 0xf6, 0x9c, 0x5a, 0x65,
        0x36, 0x67, 0xc1, 0x95, 0x92, 0x9d, 0xaf, 0xda, 0xe7, 0xfd, 0x09, 0xa2,
        0xb6, 0xe8, 0xa9, 0x84, 0xf9, 0xbe, 0xfa, 0xa0, 0xa5, 0xee, 0x1b, 0xa9,
        0x9d, 0xe6, 0x82, 0x75, 0x27, 0x22, 0x9d, 0x6a, 0x8c, 0xab, 0x09, 0xab,
        0xdf, 0x39, 0xc2, 0xe8, 0x32, 0x4a, 0x10, 0x08, 0x5e, 0xb3, 0xfb, 0x72,
        0x5f, 0x46, 0x66, 0xb0, 0xbe, 0x6b, 0x04, 0x43, 0x3f, 0xea, 0x55, 0x7f,
        0xc4, 0x4c, 0x95, 0x7d, 0xe4, 0x97, 0xdc, 0x6a, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Add authenticated Time Attribute */
    status = DIGI_CMS_addSignerAttribute (ctx,
                                         MOC_CMS_signerID_ALL,
                                         PKCS9_SIGNINGTIME_OID, sizeof(PKCS9_SIGNINGTIME_OID),
                                         MASN1_TYPE_UTC_TIME,
                                         (ubyte*)&fakeTime, 0,
                                         TRUE);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextWithUnauthAttributeIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Fixed Data */
    TimeDate fakeTime = { 2015, 11, 11, 11, 0, 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    ubyte test_signed_cms[] = {
        0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
        0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
        0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
        0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
        0x82, 0x02, 0xae, 0x30, 0x82, 0x02, 0xaa, 0x02, 0x01, 0x01, 0x30, 0x63,
        0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
        0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
        0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
        0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
        0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
        0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
        0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
        0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
        0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
        0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
        0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb,
        0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9,
        0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54,
        0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06,
        0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef,
        0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2,
        0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8,
        0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf,
        0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86,
        0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98,
        0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60,
        0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d,
        0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18,
        0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a,
        0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80,
        0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93,
        0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63,
        0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56,
        0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd,
        0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55,
        0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62,
        0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d,
        0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78,
        0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85,
        0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77,
        0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16,
        0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f,
        0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e,
        0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6,
        0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe,
        0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47,
        0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26,
        0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39,
        0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5,
        0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5,
        0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15,
        0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20,
        0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25,
        0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93,
        0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e,
        0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93,
        0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5,
        0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0xa1, 0x1e, 0x30,
        0x1c, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x05,
        0x31, 0x0f, 0x17, 0x0d, 0x38, 0x35, 0x31, 0x31, 0x31, 0x31, 0x31, 0x31,
        0x30, 0x30, 0x30, 0x30, 0x5a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Add non-authenticated Time Attribute (per RFC this is illegal but a good test) */
    status = DIGI_CMS_addSignerAttribute (ctx,
                                         MOC_CMS_signerID_ALL,
                                         PKCS9_SIGNINGTIME_OID, sizeof(PKCS9_SIGNINGTIME_OID),
                                         MASN1_TYPE_UTC_TIME,
                                         (ubyte*)&fakeTime, 0,
                                         FALSE);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextChunkedIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult, idx;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
        0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
        0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x01, 0x41, 0x04, 0x01, 0x55,
        0x04, 0x01, 0x54, 0x04, 0x01, 0x48, 0x04, 0x01, 0x45, 0x04, 0x01, 0x4e,
        0x04, 0x01, 0x54, 0x04, 0x01, 0x49, 0x04, 0x01, 0x43, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x31, 0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02,
        0x01, 0x01, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06,
        0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08,
        0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e,
        0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08,
        0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d,
        0x52, 0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60,
        0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d,
        0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05,
        0x00, 0x04, 0x82, 0x02, 0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31,
        0x32, 0x5a, 0xa9, 0xfb, 0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71,
        0x89, 0x11, 0xe5, 0xd9, 0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4,
        0x37, 0xd6, 0x50, 0x54, 0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc,
        0x7a, 0x6c, 0xa5, 0x06, 0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb,
        0x91, 0xb5, 0xa0, 0xef, 0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64,
        0xfe, 0xac, 0xbb, 0xf2, 0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4,
        0x81, 0xf1, 0xb3, 0xe8, 0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d,
        0x3f, 0xb3, 0xbe, 0xbf, 0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1,
        0x0f, 0xe7, 0xea, 0x86, 0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59,
        0x1f, 0xc9, 0xb0, 0x98, 0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b,
        0x73, 0xe4, 0x16, 0x60, 0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8,
        0x36, 0xee, 0x2e, 0x2d, 0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04,
        0x50, 0x21, 0x52, 0x18, 0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a,
        0xc2, 0xac, 0x5a, 0x9a, 0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec,
        0x41, 0x0b, 0x21, 0x80, 0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f,
        0x07, 0xf1, 0x72, 0x93, 0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01,
        0xbb, 0x91, 0xbb, 0x63, 0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec,
        0x0b, 0xab, 0x2e, 0x56, 0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a,
        0xed, 0xa0, 0x59, 0xbd, 0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb,
        0xde, 0x5f, 0x73, 0x55, 0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e,
        0x89, 0x22, 0xe0, 0x62, 0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50,
        0x96, 0xf9, 0x26, 0x8d, 0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74,
        0x33, 0x1c, 0xdf, 0x78, 0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed,
        0xf8, 0x36, 0xcb, 0x85, 0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce,
        0x78, 0xc9, 0xd1, 0x77, 0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef,
        0xb2, 0xf5, 0xc6, 0x16, 0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4,
        0xee, 0xb5, 0x03, 0x9f, 0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68,
        0xaf, 0xe5, 0x7b, 0x9e, 0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6,
        0x14, 0xd9, 0xf1, 0xa6, 0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85,
        0x1c, 0xf2, 0x14, 0xfe, 0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe,
        0x1e, 0xfd, 0xa8, 0x47, 0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32,
        0x10, 0xec, 0x4f, 0x26, 0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2,
        0x85, 0x1c, 0x0b, 0x39, 0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c,
        0x8a, 0xee, 0x71, 0xc5, 0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d,
        0x2f, 0x8f, 0xe7, 0xd5, 0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7,
        0xb4, 0xbc, 0xab, 0x15, 0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea,
        0x47, 0xdd, 0xe6, 0x20, 0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1,
        0xbf, 0x5e, 0xb4, 0x25, 0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e,
        0x74, 0x53, 0xb6, 0x93, 0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10,
        0xc1, 0x22, 0x55, 0x3e, 0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75,
        0x1f, 0x28, 0x29, 0x93, 0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9,
        0x67, 0xe8, 0xb8, 0xe5, 0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48,
        0xac, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    for (idx = 0; idx < sizeof(payLoad); ++idx)
    {
        intBoolean last = FALSE;

        /* Final byte? */
        if ((idx + 1) == sizeof(payLoad))
        {
            last = TRUE;
        }

        status = DIGI_CMS_updateContextOut (ctx, payLoad + idx, 1, last);
        retval += UNITTEST_STATUS (20 + (idx*100), status);
        if (0 < retval)
            goto exit;
    }

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddActionIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
        0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
        0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
        0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
        0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
        0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
        0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0,
        0x82, 0x05, 0x83, 0x30, 0x82, 0x05, 0x7f, 0x30, 0x82, 0x03, 0x67, 0xa0,
        0x03, 0x02, 0x01, 0x02, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
        0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
        0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09,
        0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30,
        0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
        0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07,
        0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f,
        0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63,
        0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
        0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x1e,
        0x17, 0x0d, 0x31, 0x38, 0x30, 0x31, 0x32, 0x39, 0x31, 0x35, 0x31, 0x36,
        0x30, 0x38, 0x5a, 0x17, 0x0d, 0x32, 0x38, 0x30, 0x31, 0x32, 0x37, 0x31,
        0x35, 0x31, 0x36, 0x30, 0x38, 0x5a, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09,
        0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30,
        0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
        0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07,
        0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f,
        0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63,
        0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
        0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x82,
        0x02, 0x22, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x01, 0x01, 0x05, 0x00, 0x03, 0x82, 0x02, 0x0f, 0x00, 0x30, 0x82,
        0x02, 0x0a, 0x02, 0x82, 0x02, 0x01, 0x00, 0xbc, 0x6f, 0x96, 0x11, 0x49,
        0x79, 0x6b, 0xbb, 0xc9, 0x59, 0x48, 0xc5, 0xaa, 0x19, 0x58, 0xb9, 0xce,
        0x06, 0xc3, 0xaa, 0x43, 0x9e, 0xa0, 0xc4, 0xb7, 0x6d, 0x84, 0x55, 0x5b,
        0xe7, 0x01, 0x38, 0x54, 0x28, 0x75, 0x80, 0x20, 0x85, 0x8b, 0x71, 0xfa,
        0x49, 0x5b, 0x8a, 0x55, 0x74, 0x91, 0x63, 0xab, 0xb1, 0x4d, 0xae, 0xae,
        0x35, 0xe5, 0x29, 0x86, 0xb1, 0x7e, 0x32, 0xa7, 0x8d, 0x8d, 0x6f, 0xaa,
        0xe8, 0x20, 0x5b, 0xaa, 0x63, 0xa1, 0xc9, 0xef, 0x7c, 0x02, 0x7d, 0xaa,
        0x80, 0x2a, 0xb3, 0x0a, 0xaa, 0x28, 0x36, 0xfa, 0x86, 0xfb, 0x79, 0x6e,
        0xc9, 0xa7, 0x9f, 0xdb, 0x13, 0x23, 0x15, 0x05, 0x89, 0x45, 0x62, 0x04,
        0x65, 0x05, 0x10, 0x66, 0x5c, 0x83, 0xe9, 0xed, 0x43, 0xed, 0x2b, 0xe8,
        0xf8, 0x4a, 0xb0, 0xd3, 0xb6, 0xec, 0x0e, 0xb1, 0xd3, 0xdb, 0x06, 0x24,
        0xc8, 0xa6, 0xed, 0x5a, 0xaa, 0xb2, 0x6d, 0xc6, 0x5a, 0x45, 0x70, 0x12,
        0xd5, 0x16, 0xbc, 0xff, 0xad, 0xd6, 0x0e, 0x49, 0x18, 0xae, 0xa9, 0x99,
        0xf7, 0xb9, 0x19, 0x1f, 0xe4, 0x05, 0x15, 0x62, 0x0f, 0xe1, 0xe4, 0x3d,
        0x98, 0x46, 0x29, 0x4a, 0xf1, 0x76, 0x7d, 0x49, 0xb9, 0xfe, 0x09, 0xce,
        0xb6, 0xa2, 0x13, 0xe8, 0x4c, 0x53, 0x4e, 0xf0, 0x9c, 0xec, 0x8a, 0xe2,
        0x86, 0x72, 0xf4, 0x1c, 0x9d, 0x50, 0xac, 0x50, 0x9f, 0xbd, 0x9d, 0xc8,
        0xd1, 0x09, 0xb5, 0xd7, 0x43, 0x4e, 0x5d, 0xda, 0x3c, 0x0a, 0x6f, 0x63,
        0xfd, 0xa2, 0x54, 0x6e, 0x34, 0xb8, 0xcc, 0xbc, 0x96, 0x10, 0x3a, 0x5f,
        0x23, 0xb4, 0x67, 0x69, 0x12, 0x7e, 0x9e, 0x28, 0x17, 0x23, 0xe4, 0x81,
        0x3b, 0x98, 0x66, 0xa0, 0x97, 0xab, 0xf4, 0x6f, 0x18, 0x85, 0x6e, 0xf1,
        0x21, 0x9f, 0xe8, 0x2b, 0x62, 0x26, 0x22, 0x2c, 0x23, 0xb1, 0xa2, 0xa1,
        0x68, 0xcb, 0xdd, 0x20, 0x9c, 0xcd, 0x5a, 0xbc, 0xef, 0x20, 0x0b, 0x12,
        0xcd, 0x54, 0x73, 0x0f, 0x7d, 0xeb, 0x48, 0xe7, 0x4c, 0x83, 0x97, 0xb9,
        0xd2, 0xa7, 0x9f, 0xc6, 0x52, 0xa1, 0x43, 0x9e, 0x19, 0x05, 0x95, 0x17,
        0xb2, 0xbd, 0x7a, 0xb2, 0x27, 0xac, 0xac, 0x50, 0x3e, 0x51, 0xd5, 0x34,
        0x4f, 0x5a, 0x35, 0x83, 0x19, 0x10, 0x92, 0x21, 0x10, 0xab, 0x55, 0x97,
        0xfc, 0x1c, 0x52, 0xaf, 0x2a, 0x1e, 0x11, 0x62, 0x1f, 0xb9, 0xe9, 0xea,
        0x9f, 0x0f, 0x29, 0x6c, 0xd9, 0x6a, 0xaa, 0xb8, 0x7a, 0xc5, 0xd1, 0x4e,
        0xc0, 0xf8, 0x1c, 0xd8, 0x77, 0x43, 0xb4, 0xfa, 0x8d, 0x69, 0x75, 0xb2,
        0x9c, 0xa6, 0x50, 0x2f, 0xa6, 0x90, 0x36, 0x70, 0xcc, 0xe6, 0x67, 0x59,
        0xc1, 0xf7, 0x9b, 0x0b, 0x0f, 0x90, 0xfe, 0x6a, 0x4b, 0x6c, 0x6c, 0xb7,
        0x4e, 0xe1, 0x13, 0x08, 0x98, 0x74, 0xe6, 0x08, 0xb5, 0x35, 0x28, 0xee,
        0x0f, 0x70, 0x7f, 0xe7, 0x01, 0x13, 0xc8, 0x5f, 0x9b, 0x21, 0x89, 0xad,
        0xbe, 0xd8, 0xbd, 0x9e, 0x3f, 0x71, 0x88, 0x4e, 0xa8, 0x93, 0xe5, 0x43,
        0xa1, 0x65, 0xef, 0x54, 0x62, 0x1b, 0x56, 0x8a, 0x1e, 0x93, 0x5e, 0x7e,
        0xde, 0xf2, 0xd3, 0xc1, 0x9e, 0xe3, 0x52, 0x5b, 0x21, 0xca, 0x3e, 0x37,
        0xd6, 0x1c, 0x5a, 0x8a, 0x86, 0x43, 0xb2, 0x24, 0x65, 0x15, 0x58, 0xc3,
        0xcc, 0xd6, 0x8a, 0x56, 0x5c, 0x4c, 0x27, 0xe2, 0x35, 0xfc, 0x63, 0x67,
        0xd7, 0x8b, 0x1d, 0x02, 0x71, 0xe5, 0xa3, 0x20, 0xf7, 0xe4, 0xad, 0xd6,
        0x53, 0xfc, 0x8d, 0x84, 0xa4, 0x53, 0xbb, 0x5b, 0xa5, 0x5f, 0x00, 0xaa,
        0xc8, 0x0d, 0xdc, 0x38, 0xd2, 0x78, 0x18, 0xa7, 0xe2, 0x25, 0xd5, 0xac,
        0x87, 0x28, 0xf1, 0x69, 0x6b, 0xae, 0x07, 0xc0, 0xa0, 0x61, 0x34, 0x89,
        0x49, 0x59, 0xcd, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3, 0x50, 0x30, 0x4e,
        0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0x23,
        0xf6, 0xea, 0x1b, 0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d,
        0x17, 0xda, 0xbf, 0xab, 0x3d, 0x97, 0xfb, 0x30, 0x1f, 0x06, 0x03, 0x55,
        0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x23, 0xf6, 0xea, 0x1b,
        0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda, 0xbf,
        0xab, 0x3d, 0x97, 0xfb, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04,
        0x05, 0x30, 0x03, 0x01, 0x01, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x03, 0x82, 0x02,
        0x01, 0x00, 0x22, 0xb8, 0xf4, 0xf8, 0x91, 0x8e, 0x0c, 0x14, 0x14, 0x5b,
        0x0f, 0x61, 0x43, 0x25, 0xba, 0x0f, 0xf4, 0x28, 0x4e, 0xc8, 0x60, 0xd6,
        0xe4, 0x4c, 0x64, 0xa5, 0x64, 0x2b, 0x0e, 0xd3, 0x87, 0xbd, 0xd6, 0x6a,
        0x15, 0x03, 0xf2, 0xdc, 0x0b, 0xf9, 0xb9, 0x7c, 0x58, 0x59, 0x13, 0xe8,
        0x66, 0xde, 0x87, 0xe8, 0x02, 0xa8, 0xfe, 0x3b, 0x13, 0x5c, 0x25, 0x74,
        0xb5, 0x74, 0x37, 0x3d, 0x20, 0x69, 0xdb, 0xdd, 0x9d, 0x9f, 0x53, 0x1e,
        0xeb, 0xc2, 0xe2, 0xaa, 0xcb, 0x93, 0x2c, 0x47, 0x9a, 0xf3, 0xf3, 0x86,
        0xfd, 0xf2, 0xed, 0x0b, 0xba, 0x9e, 0x20, 0x6c, 0x05, 0x42, 0x55, 0xd2,
        0x14, 0xdd, 0xc5, 0x4b, 0x1e, 0x4b, 0x5c, 0xe1, 0xe4, 0x4f, 0xd8, 0x5a,
        0x1c, 0xb8, 0xfc, 0x62, 0xa5, 0xd3, 0x11, 0xaa, 0x4b, 0x6b, 0xe0, 0xd8,
        0x30, 0x94, 0xc3, 0x0b, 0x66, 0xa6, 0x82, 0xe3, 0x66, 0x48, 0xba, 0x77,
        0x9f, 0x85, 0x9e, 0xfb, 0x6d, 0x92, 0x25, 0x3f, 0x3b, 0xf5, 0x56, 0x9f,
        0xa9, 0x24, 0x5d, 0x40, 0x10, 0xc5, 0x55, 0x8b, 0xd2, 0xef, 0x08, 0x75,
        0xbd, 0xcb, 0xd9, 0x6f, 0xa1, 0x09, 0x52, 0x82, 0x43, 0xb9, 0x39, 0x23,
        0xbe, 0xc0, 0xd0, 0xdc, 0xf5, 0x91, 0xd8, 0xff, 0x2c, 0x39, 0x21, 0x49,
        0x9c, 0xd4, 0x92, 0x38, 0x53, 0x89, 0x32, 0xa8, 0xf4, 0x1d, 0xb5, 0x3a,
        0x0e, 0x58, 0xe2, 0x33, 0x9d, 0x27, 0xc8, 0x64, 0x53, 0x54, 0xd6, 0xe7,
        0x9d, 0x29, 0x37, 0x8d, 0xba, 0x8d, 0x84, 0xa3, 0x43, 0x37, 0x3d, 0x5e,
        0x78, 0x0c, 0xa1, 0x75, 0x91, 0x76, 0x62, 0x75, 0xe2, 0xf4, 0xe1, 0x2d,
        0xca, 0xd2, 0x9b, 0x92, 0x64, 0xdd, 0x9d, 0x5f, 0xec, 0x23, 0x7a, 0x80,
        0xb2, 0x39, 0xd9, 0x32, 0xfc, 0xd5, 0xe2, 0x73, 0x3d, 0xd0, 0xd3, 0x5b,
        0x7a, 0x32, 0xcc, 0xc6, 0xe1, 0xea, 0x44, 0xaa, 0xc3, 0x0a, 0xd1, 0x34,
        0x3a, 0x2c, 0xba, 0x61, 0x90, 0xff, 0x83, 0xf0, 0x0b, 0x27, 0x69, 0x24,
        0x18, 0x9b, 0x9d, 0xd3, 0xa0, 0x29, 0x39, 0x94, 0xd1, 0xaf, 0xad, 0x13,
        0xe4, 0x08, 0xb4, 0x4a, 0x44, 0xdf, 0xc9, 0xca, 0x19, 0x7a, 0xd5, 0x45,
        0xd2, 0x05, 0xfb, 0xe7, 0xfc, 0xf6, 0x4c, 0x29, 0xc8, 0xfd, 0x6b, 0x29,
        0xb1, 0x89, 0x11, 0xb3, 0xc5, 0xdd, 0xe1, 0x9c, 0x5a, 0xca, 0xd6, 0xca,
        0x25, 0x9b, 0x29, 0xc5, 0x5e, 0xd9, 0x1e, 0x1f, 0x89, 0x9a, 0x73, 0x18,
        0x6d, 0x5d, 0x31, 0x2a, 0x50, 0x52, 0x87, 0xf4, 0x48, 0x56, 0xba, 0x5e,
        0x5f, 0xba, 0x90, 0x98, 0x63, 0xcb, 0x15, 0xac, 0xad, 0x3e, 0x21, 0x1b,
        0x17, 0x5b, 0x89, 0xc0, 0x6c, 0xb2, 0x09, 0x57, 0x76, 0x1c, 0xcb, 0x32,
        0xfa, 0x41, 0xd3, 0xf7, 0xe3, 0x37, 0xd7, 0xf9, 0x92, 0x4b, 0x75, 0x92,
        0xe0, 0x53, 0xb9, 0x00, 0x56, 0xdb, 0xa5, 0xbf, 0x42, 0x31, 0x26, 0x15,
        0xf0, 0xb5, 0xa9, 0x87, 0x92, 0x61, 0x3f, 0x3b, 0x24, 0xf5, 0x1e, 0x94,
        0xb5, 0x1c, 0xd0, 0xcf, 0x24, 0x24, 0x50, 0x52, 0x69, 0x87, 0x1a, 0x24,
        0xd1, 0x38, 0xac, 0x3d, 0xb8, 0x51, 0xc6, 0x73, 0xd4, 0xf8, 0xae, 0x37,
        0x1f, 0x41, 0xe5, 0x00, 0xaa, 0x34, 0xf0, 0x38, 0xa1, 0xe7, 0x25, 0xe0,
        0x26, 0x54, 0x38, 0x19, 0x63, 0xa9, 0xd2, 0x19, 0x24, 0xa9, 0x05, 0x11,
        0x10, 0x76, 0xa9, 0x8f, 0x01, 0x2e, 0x97, 0x03, 0x06, 0xb6, 0x9b, 0x7d,
        0xde, 0x71, 0x85, 0x9b, 0xc5, 0xd5, 0x3e, 0xe2, 0x26, 0x5c, 0xf0, 0x67,
        0x1d, 0xc3, 0x62, 0x87, 0xb4, 0x20, 0x36, 0xd0, 0x90, 0xd5, 0xb0, 0xb7,
        0xca, 0xf7, 0x89, 0xce, 0x60, 0xa2, 0x3e, 0xf5, 0xd1, 0x5a, 0x48, 0x13,
        0x50, 0x17, 0x08, 0x5e, 0x9c, 0x98, 0x89, 0x32, 0xb4, 0x29, 0x31, 0x82,
        0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30,
        0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02,
        0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c,
        0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f,
        0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c,
        0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a,
        0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f,
        0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34,
        0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69,
        0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03,
        0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48,
        0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00,
        0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44,
        0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73,
        0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1,
        0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97,
        0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08,
        0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf,
        0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44,
        0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3,
        0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01,
        0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68,
        0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d,
        0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e,
        0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc,
        0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4,
        0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8,
        0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9,
        0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0,
        0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27,
        0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85,
        0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d,
        0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b,
        0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c,
        0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4,
        0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73,
        0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98,
        0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87,
        0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85,
        0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54,
        0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad,
        0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1,
        0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21,
        0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2,
        0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d,
        0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59,
        0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97,
        0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5,
        0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69,
        0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d,
        0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc,
        0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02,
        0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a,
        0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d,
        0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 4096;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_addCert,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_signTextAddCertificateIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to sign */
    ubyte payLoad[] = { 'A', 'U', 'T', 'H', 'E', 'N', 'T', 'I', 'C' };

    /* Expected data */
    unsigned char test_signed_cms[] = {
            0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
            0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
            0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
            0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
            0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
            0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0,
            0x82, 0x05, 0x83, 0x30, 0x82, 0x05, 0x7f, 0x30, 0x82, 0x03, 0x67, 0xa0,
            0x03, 0x02, 0x01, 0x02, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
            0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7,
            0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09,
            0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30,
            0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
            0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07,
            0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f,
            0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63,
            0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
            0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x1e,
            0x17, 0x0d, 0x31, 0x38, 0x30, 0x31, 0x32, 0x39, 0x31, 0x35, 0x31, 0x36,
            0x30, 0x38, 0x5a, 0x17, 0x0d, 0x32, 0x38, 0x30, 0x31, 0x32, 0x37, 0x31,
            0x35, 0x31, 0x36, 0x30, 0x38, 0x5a, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09,
            0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30,
            0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72,
            0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07,
            0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f,
            0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63,
            0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b,
            0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x30, 0x82,
            0x02, 0x22, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
            0x01, 0x01, 0x01, 0x05, 0x00, 0x03, 0x82, 0x02, 0x0f, 0x00, 0x30, 0x82,
            0x02, 0x0a, 0x02, 0x82, 0x02, 0x01, 0x00, 0xbc, 0x6f, 0x96, 0x11, 0x49,
            0x79, 0x6b, 0xbb, 0xc9, 0x59, 0x48, 0xc5, 0xaa, 0x19, 0x58, 0xb9, 0xce,
            0x06, 0xc3, 0xaa, 0x43, 0x9e, 0xa0, 0xc4, 0xb7, 0x6d, 0x84, 0x55, 0x5b,
            0xe7, 0x01, 0x38, 0x54, 0x28, 0x75, 0x80, 0x20, 0x85, 0x8b, 0x71, 0xfa,
            0x49, 0x5b, 0x8a, 0x55, 0x74, 0x91, 0x63, 0xab, 0xb1, 0x4d, 0xae, 0xae,
            0x35, 0xe5, 0x29, 0x86, 0xb1, 0x7e, 0x32, 0xa7, 0x8d, 0x8d, 0x6f, 0xaa,
            0xe8, 0x20, 0x5b, 0xaa, 0x63, 0xa1, 0xc9, 0xef, 0x7c, 0x02, 0x7d, 0xaa,
            0x80, 0x2a, 0xb3, 0x0a, 0xaa, 0x28, 0x36, 0xfa, 0x86, 0xfb, 0x79, 0x6e,
            0xc9, 0xa7, 0x9f, 0xdb, 0x13, 0x23, 0x15, 0x05, 0x89, 0x45, 0x62, 0x04,
            0x65, 0x05, 0x10, 0x66, 0x5c, 0x83, 0xe9, 0xed, 0x43, 0xed, 0x2b, 0xe8,
            0xf8, 0x4a, 0xb0, 0xd3, 0xb6, 0xec, 0x0e, 0xb1, 0xd3, 0xdb, 0x06, 0x24,
            0xc8, 0xa6, 0xed, 0x5a, 0xaa, 0xb2, 0x6d, 0xc6, 0x5a, 0x45, 0x70, 0x12,
            0xd5, 0x16, 0xbc, 0xff, 0xad, 0xd6, 0x0e, 0x49, 0x18, 0xae, 0xa9, 0x99,
            0xf7, 0xb9, 0x19, 0x1f, 0xe4, 0x05, 0x15, 0x62, 0x0f, 0xe1, 0xe4, 0x3d,
            0x98, 0x46, 0x29, 0x4a, 0xf1, 0x76, 0x7d, 0x49, 0xb9, 0xfe, 0x09, 0xce,
            0xb6, 0xa2, 0x13, 0xe8, 0x4c, 0x53, 0x4e, 0xf0, 0x9c, 0xec, 0x8a, 0xe2,
            0x86, 0x72, 0xf4, 0x1c, 0x9d, 0x50, 0xac, 0x50, 0x9f, 0xbd, 0x9d, 0xc8,
            0xd1, 0x09, 0xb5, 0xd7, 0x43, 0x4e, 0x5d, 0xda, 0x3c, 0x0a, 0x6f, 0x63,
            0xfd, 0xa2, 0x54, 0x6e, 0x34, 0xb8, 0xcc, 0xbc, 0x96, 0x10, 0x3a, 0x5f,
            0x23, 0xb4, 0x67, 0x69, 0x12, 0x7e, 0x9e, 0x28, 0x17, 0x23, 0xe4, 0x81,
            0x3b, 0x98, 0x66, 0xa0, 0x97, 0xab, 0xf4, 0x6f, 0x18, 0x85, 0x6e, 0xf1,
            0x21, 0x9f, 0xe8, 0x2b, 0x62, 0x26, 0x22, 0x2c, 0x23, 0xb1, 0xa2, 0xa1,
            0x68, 0xcb, 0xdd, 0x20, 0x9c, 0xcd, 0x5a, 0xbc, 0xef, 0x20, 0x0b, 0x12,
            0xcd, 0x54, 0x73, 0x0f, 0x7d, 0xeb, 0x48, 0xe7, 0x4c, 0x83, 0x97, 0xb9,
            0xd2, 0xa7, 0x9f, 0xc6, 0x52, 0xa1, 0x43, 0x9e, 0x19, 0x05, 0x95, 0x17,
            0xb2, 0xbd, 0x7a, 0xb2, 0x27, 0xac, 0xac, 0x50, 0x3e, 0x51, 0xd5, 0x34,
            0x4f, 0x5a, 0x35, 0x83, 0x19, 0x10, 0x92, 0x21, 0x10, 0xab, 0x55, 0x97,
            0xfc, 0x1c, 0x52, 0xaf, 0x2a, 0x1e, 0x11, 0x62, 0x1f, 0xb9, 0xe9, 0xea,
            0x9f, 0x0f, 0x29, 0x6c, 0xd9, 0x6a, 0xaa, 0xb8, 0x7a, 0xc5, 0xd1, 0x4e,
            0xc0, 0xf8, 0x1c, 0xd8, 0x77, 0x43, 0xb4, 0xfa, 0x8d, 0x69, 0x75, 0xb2,
            0x9c, 0xa6, 0x50, 0x2f, 0xa6, 0x90, 0x36, 0x70, 0xcc, 0xe6, 0x67, 0x59,
            0xc1, 0xf7, 0x9b, 0x0b, 0x0f, 0x90, 0xfe, 0x6a, 0x4b, 0x6c, 0x6c, 0xb7,
            0x4e, 0xe1, 0x13, 0x08, 0x98, 0x74, 0xe6, 0x08, 0xb5, 0x35, 0x28, 0xee,
            0x0f, 0x70, 0x7f, 0xe7, 0x01, 0x13, 0xc8, 0x5f, 0x9b, 0x21, 0x89, 0xad,
            0xbe, 0xd8, 0xbd, 0x9e, 0x3f, 0x71, 0x88, 0x4e, 0xa8, 0x93, 0xe5, 0x43,
            0xa1, 0x65, 0xef, 0x54, 0x62, 0x1b, 0x56, 0x8a, 0x1e, 0x93, 0x5e, 0x7e,
            0xde, 0xf2, 0xd3, 0xc1, 0x9e, 0xe3, 0x52, 0x5b, 0x21, 0xca, 0x3e, 0x37,
            0xd6, 0x1c, 0x5a, 0x8a, 0x86, 0x43, 0xb2, 0x24, 0x65, 0x15, 0x58, 0xc3,
            0xcc, 0xd6, 0x8a, 0x56, 0x5c, 0x4c, 0x27, 0xe2, 0x35, 0xfc, 0x63, 0x67,
            0xd7, 0x8b, 0x1d, 0x02, 0x71, 0xe5, 0xa3, 0x20, 0xf7, 0xe4, 0xad, 0xd6,
            0x53, 0xfc, 0x8d, 0x84, 0xa4, 0x53, 0xbb, 0x5b, 0xa5, 0x5f, 0x00, 0xaa,
            0xc8, 0x0d, 0xdc, 0x38, 0xd2, 0x78, 0x18, 0xa7, 0xe2, 0x25, 0xd5, 0xac,
            0x87, 0x28, 0xf1, 0x69, 0x6b, 0xae, 0x07, 0xc0, 0xa0, 0x61, 0x34, 0x89,
            0x49, 0x59, 0xcd, 0x02, 0x03, 0x01, 0x00, 0x01, 0xa3, 0x50, 0x30, 0x4e,
            0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d, 0x0e, 0x04, 0x16, 0x04, 0x14, 0x23,
            0xf6, 0xea, 0x1b, 0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d,
            0x17, 0xda, 0xbf, 0xab, 0x3d, 0x97, 0xfb, 0x30, 0x1f, 0x06, 0x03, 0x55,
            0x1d, 0x23, 0x04, 0x18, 0x30, 0x16, 0x80, 0x14, 0x23, 0xf6, 0xea, 0x1b,
            0x1b, 0x30, 0x73, 0xd3, 0x1b, 0x4d, 0x90, 0x21, 0x2d, 0x17, 0xda, 0xbf,
            0xab, 0x3d, 0x97, 0xfb, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04,
            0x05, 0x30, 0x03, 0x01, 0x01, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
            0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05, 0x00, 0x03, 0x82, 0x02,
            0x01, 0x00, 0x22, 0xb8, 0xf4, 0xf8, 0x91, 0x8e, 0x0c, 0x14, 0x14, 0x5b,
            0x0f, 0x61, 0x43, 0x25, 0xba, 0x0f, 0xf4, 0x28, 0x4e, 0xc8, 0x60, 0xd6,
            0xe4, 0x4c, 0x64, 0xa5, 0x64, 0x2b, 0x0e, 0xd3, 0x87, 0xbd, 0xd6, 0x6a,
            0x15, 0x03, 0xf2, 0xdc, 0x0b, 0xf9, 0xb9, 0x7c, 0x58, 0x59, 0x13, 0xe8,
            0x66, 0xde, 0x87, 0xe8, 0x02, 0xa8, 0xfe, 0x3b, 0x13, 0x5c, 0x25, 0x74,
            0xb5, 0x74, 0x37, 0x3d, 0x20, 0x69, 0xdb, 0xdd, 0x9d, 0x9f, 0x53, 0x1e,
            0xeb, 0xc2, 0xe2, 0xaa, 0xcb, 0x93, 0x2c, 0x47, 0x9a, 0xf3, 0xf3, 0x86,
            0xfd, 0xf2, 0xed, 0x0b, 0xba, 0x9e, 0x20, 0x6c, 0x05, 0x42, 0x55, 0xd2,
            0x14, 0xdd, 0xc5, 0x4b, 0x1e, 0x4b, 0x5c, 0xe1, 0xe4, 0x4f, 0xd8, 0x5a,
            0x1c, 0xb8, 0xfc, 0x62, 0xa5, 0xd3, 0x11, 0xaa, 0x4b, 0x6b, 0xe0, 0xd8,
            0x30, 0x94, 0xc3, 0x0b, 0x66, 0xa6, 0x82, 0xe3, 0x66, 0x48, 0xba, 0x77,
            0x9f, 0x85, 0x9e, 0xfb, 0x6d, 0x92, 0x25, 0x3f, 0x3b, 0xf5, 0x56, 0x9f,
            0xa9, 0x24, 0x5d, 0x40, 0x10, 0xc5, 0x55, 0x8b, 0xd2, 0xef, 0x08, 0x75,
            0xbd, 0xcb, 0xd9, 0x6f, 0xa1, 0x09, 0x52, 0x82, 0x43, 0xb9, 0x39, 0x23,
            0xbe, 0xc0, 0xd0, 0xdc, 0xf5, 0x91, 0xd8, 0xff, 0x2c, 0x39, 0x21, 0x49,
            0x9c, 0xd4, 0x92, 0x38, 0x53, 0x89, 0x32, 0xa8, 0xf4, 0x1d, 0xb5, 0x3a,
            0x0e, 0x58, 0xe2, 0x33, 0x9d, 0x27, 0xc8, 0x64, 0x53, 0x54, 0xd6, 0xe7,
            0x9d, 0x29, 0x37, 0x8d, 0xba, 0x8d, 0x84, 0xa3, 0x43, 0x37, 0x3d, 0x5e,
            0x78, 0x0c, 0xa1, 0x75, 0x91, 0x76, 0x62, 0x75, 0xe2, 0xf4, 0xe1, 0x2d,
            0xca, 0xd2, 0x9b, 0x92, 0x64, 0xdd, 0x9d, 0x5f, 0xec, 0x23, 0x7a, 0x80,
            0xb2, 0x39, 0xd9, 0x32, 0xfc, 0xd5, 0xe2, 0x73, 0x3d, 0xd0, 0xd3, 0x5b,
            0x7a, 0x32, 0xcc, 0xc6, 0xe1, 0xea, 0x44, 0xaa, 0xc3, 0x0a, 0xd1, 0x34,
            0x3a, 0x2c, 0xba, 0x61, 0x90, 0xff, 0x83, 0xf0, 0x0b, 0x27, 0x69, 0x24,
            0x18, 0x9b, 0x9d, 0xd3, 0xa0, 0x29, 0x39, 0x94, 0xd1, 0xaf, 0xad, 0x13,
            0xe4, 0x08, 0xb4, 0x4a, 0x44, 0xdf, 0xc9, 0xca, 0x19, 0x7a, 0xd5, 0x45,
            0xd2, 0x05, 0xfb, 0xe7, 0xfc, 0xf6, 0x4c, 0x29, 0xc8, 0xfd, 0x6b, 0x29,
            0xb1, 0x89, 0x11, 0xb3, 0xc5, 0xdd, 0xe1, 0x9c, 0x5a, 0xca, 0xd6, 0xca,
            0x25, 0x9b, 0x29, 0xc5, 0x5e, 0xd9, 0x1e, 0x1f, 0x89, 0x9a, 0x73, 0x18,
            0x6d, 0x5d, 0x31, 0x2a, 0x50, 0x52, 0x87, 0xf4, 0x48, 0x56, 0xba, 0x5e,
            0x5f, 0xba, 0x90, 0x98, 0x63, 0xcb, 0x15, 0xac, 0xad, 0x3e, 0x21, 0x1b,
            0x17, 0x5b, 0x89, 0xc0, 0x6c, 0xb2, 0x09, 0x57, 0x76, 0x1c, 0xcb, 0x32,
            0xfa, 0x41, 0xd3, 0xf7, 0xe3, 0x37, 0xd7, 0xf9, 0x92, 0x4b, 0x75, 0x92,
            0xe0, 0x53, 0xb9, 0x00, 0x56, 0xdb, 0xa5, 0xbf, 0x42, 0x31, 0x26, 0x15,
            0xf0, 0xb5, 0xa9, 0x87, 0x92, 0x61, 0x3f, 0x3b, 0x24, 0xf5, 0x1e, 0x94,
            0xb5, 0x1c, 0xd0, 0xcf, 0x24, 0x24, 0x50, 0x52, 0x69, 0x87, 0x1a, 0x24,
            0xd1, 0x38, 0xac, 0x3d, 0xb8, 0x51, 0xc6, 0x73, 0xd4, 0xf8, 0xae, 0x37,
            0x1f, 0x41, 0xe5, 0x00, 0xaa, 0x34, 0xf0, 0x38, 0xa1, 0xe7, 0x25, 0xe0,
            0x26, 0x54, 0x38, 0x19, 0x63, 0xa9, 0xd2, 0x19, 0x24, 0xa9, 0x05, 0x11,
            0x10, 0x76, 0xa9, 0x8f, 0x01, 0x2e, 0x97, 0x03, 0x06, 0xb6, 0x9b, 0x7d,
            0xde, 0x71, 0x85, 0x9b, 0xc5, 0xd5, 0x3e, 0xe2, 0x26, 0x5c, 0xf0, 0x67,
            0x1d, 0xc3, 0x62, 0x87, 0xb4, 0x20, 0x36, 0xd0, 0x90, 0xd5, 0xb0, 0xb7,
            0xca, 0xf7, 0x89, 0xce, 0x60, 0xa2, 0x3e, 0xf5, 0xd1, 0x5a, 0x48, 0x13,
            0x50, 0x17, 0x08, 0x5e, 0x9c, 0x98, 0x89, 0x32, 0xb4, 0x29, 0x31, 0x82,
            0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63, 0x30,
            0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02,
            0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c,
            0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30, 0x0f,
            0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65, 0x6c,
            0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04, 0x0a,
            0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30, 0x0f,
            0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d, 0x34,
            0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad, 0x69,
            0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03,
            0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48,
            0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02, 0x00,
            0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb, 0x44,
            0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9, 0x73,
            0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54, 0xa1,
            0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06, 0x97,
            0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef, 0x08,
            0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2, 0xbf,
            0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8, 0x44,
            0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf, 0xe3,
            0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86, 0x01,
            0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98, 0x68,
            0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60, 0x2d,
            0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d, 0x6e,
            0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18, 0xfc,
            0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a, 0xe4,
            0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80, 0xc8,
            0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93, 0xc9,
            0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63, 0xe0,
            0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56, 0x27,
            0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd, 0x85,
            0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55, 0x2d,
            0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62, 0x1b,
            0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d, 0x2c,
            0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78, 0xe4,
            0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85, 0x73,
            0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77, 0x98,
            0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16, 0x87,
            0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f, 0x85,
            0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e, 0x54,
            0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6, 0xad,
            0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe, 0xc1,
            0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47, 0x21,
            0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26, 0xe2,
            0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39, 0x6d,
            0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5, 0x59,
            0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5, 0x97,
            0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15, 0xa5,
            0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20, 0x69,
            0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25, 0x2d,
            0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93, 0xcc,
            0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e, 0x02,
            0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93, 0x2a,
            0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5, 0x8d,
            0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00
    };

    CRYPTO_initAsymmetricKey (&key);

    /* Read key */
    status = DIGICERT_readFile("signer_rsa_key.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    status = PKCS_getPKCS8Key (pCert, certLen, &key);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 4096;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for signing */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_signedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set signer data */
    status = DIGI_CMS_addSigner (ctx, pCert, certLen,
                                &key,
                                NIST_SHA256_OID,
                                sizeof(NIST_SHA256_OID),
                                E_MOC_CMS_sa_none,
                                NULL);
    retval += UNITTEST_STATUS (15, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    /* Add certificate after data */
    status = DIGI_CMS_addCertificate (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (22, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_signed_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_signed_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}


/*----------------------------------------------------------------------*/

MSTATUS decode_cms(internal_test *t, MOC_CMS_GetPrivateKey getPrivKeyFun)
{
   MSTATUS status;
   MOC_CMS_context     pCtx = NULL;
   MOC_CMS_Callbacks   cb = { 0 };
   intBoolean finished = FALSE;

   cb.getPrivKeyFun = getPrivKeyFun;

   status = DIGI_CMS_newContext(&pCtx, (void *) t, &cb);
   if (OK != status)
      goto exit;

    status = DIGI_CMS_updateContext(pCtx, t->buf, t->bufUsed, &finished);
   if (OK != status)
      goto exit;

   if (TRUE != finished)
   {
      status = ERR_CRYPTO;
      goto exit;
   }

exit:

    DIGI_CMS_deleteContext(&pCtx);

   return status;
}

/*----------------------------------------------------------------------*/

static MSTATUS
cb_mocencode_cms_test_envelopTextDefinite(const void* arg,
                 ubyte* pSerialNumber,
                 ubyte4 serialNumberLen,
                 ubyte* pIssuer,
                 ubyte4 issuerLen,
                 struct AsymmetricKey* pKey)
{
   MSTATUS status;
   ubyte *pData = NULL;
   ubyte4 dataLen = 0;

   status = DIGICERT_readFile("signer_rsa_key.der", &pData, &dataLen);
   if (OK != status)
      goto exit;

   status = CRYPTO_deserializeAsymKey(pData, dataLen, NULL, pKey);

exit:

   if (NULL != pData)
   {
      DIGI_FREE((void **) &pData);
   }
   return status;
}

/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

    unsigned char test_env_cms[] = {
        0x30, 0x82, 0x02, 0xce, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x03, 0xa0, 0x82, 0x02, 0xbf, 0x30, 0x82, 0x02, 0xbb, 0x02,
        0x01, 0x00, 0x31, 0x82, 0x02, 0x7f, 0x30, 0x82, 0x02, 0x7b, 0x02, 0x01,
        0x00, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55,
        0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03,
        0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c,
        0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06,
        0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52,
        0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52,
        0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
        0x00, 0x13, 0x1f, 0xe4, 0x20, 0xdd, 0x6f, 0xc8, 0x26, 0x33, 0xaa, 0xcf,
        0x5b, 0xcd, 0x5e, 0xfe, 0x02, 0x56, 0x65, 0xbc, 0x74, 0xca, 0xb3, 0x34,
        0x9f, 0x65, 0x59, 0x7e, 0xc2, 0x5b, 0x74, 0xa3, 0xc8, 0x4b, 0xe7, 0x60,
        0xcc, 0xcb, 0x25, 0x22, 0x8b, 0xb0, 0x84, 0x2e, 0xe3, 0x52, 0xd7, 0x2b,
        0x7b, 0x00, 0xc5, 0xde, 0x28, 0x62, 0x42, 0x60, 0xfe, 0x71, 0xaf, 0x83,
        0xef, 0xb0, 0x9f, 0xdc, 0xe2, 0x53, 0x08, 0x77, 0xb3, 0xf2, 0xe0, 0xdb,
        0x14, 0x14, 0x2a, 0x57, 0x04, 0xad, 0xf7, 0x42, 0x6a, 0x25, 0x97, 0xc4,
        0x92, 0x3b, 0x5e, 0x1d, 0x99, 0x3f, 0x10, 0x9a, 0xce, 0xd0, 0x62, 0xcb,
        0x85, 0xa8, 0xf9, 0x5b, 0xf7, 0x08, 0xe9, 0xb7, 0xbf, 0x2c, 0xaf, 0xec,
        0x1f, 0xff, 0x0e, 0x6b, 0xae, 0x53, 0x01, 0x01, 0xac, 0x16, 0xa2, 0x28,
        0xed, 0x0c, 0x34, 0x5d, 0x82, 0xcb, 0xba, 0x97, 0x12, 0x37, 0x32, 0x51,
        0xfe, 0x38, 0x0b, 0x67, 0x1d, 0xdf, 0x13, 0x8d, 0xb5, 0xca, 0x9a, 0x53,
        0xf9, 0x3c, 0xba, 0xaf, 0xf4, 0xf8, 0x18, 0xcd, 0xd3, 0xe8, 0x0b, 0x66,
        0x00, 0xf9, 0xa7, 0x16, 0x77, 0xc1, 0x23, 0xb5, 0xae, 0xea, 0x6e, 0x10,
        0xe1, 0x5a, 0x8a, 0x79, 0x02, 0xb0, 0x74, 0x59, 0xf0, 0xc9, 0x87, 0x09,
        0xaf, 0xb4, 0x39, 0xa3, 0xf4, 0x0c, 0x58, 0x06, 0xf4, 0xf7, 0x08, 0x73,
        0x4d, 0x55, 0x9f, 0xf7, 0x4d, 0x2a, 0xb6, 0xff, 0x85, 0x3c, 0x47, 0xce,
        0x84, 0xbe, 0x25, 0xd3, 0x4e, 0xe9, 0xb5, 0xae, 0x7c, 0xb3, 0xb2, 0x1f,
        0x43, 0x8d, 0x74, 0x98, 0xe2, 0x3a, 0xb1, 0x96, 0xd9, 0x9d, 0x04, 0x3a,
        0x7e, 0x26, 0x27, 0x80, 0x94, 0xa4, 0x6a, 0x9b, 0xa7, 0x13, 0xf7, 0xa2,
        0x7c, 0xca, 0xf3, 0xc4, 0xcb, 0xd9, 0x6f, 0x69, 0x2f, 0xc7, 0x6b, 0x33,
        0x37, 0x23, 0xa1, 0x2d, 0x03, 0xe4, 0x71, 0xc0, 0x95, 0x89, 0x22, 0xf2,
        0x15, 0xca, 0x38, 0x85, 0x33, 0x04, 0x36, 0xf5, 0x34, 0xf6, 0xe7, 0x5a,
        0x94, 0x3f, 0x30, 0xfb, 0xf1, 0x8f, 0x99, 0xd4, 0x7a, 0xff, 0x00, 0x2b,
        0xe1, 0x8e, 0x8f, 0xca, 0x99, 0x38, 0xfa, 0x2d, 0xd5, 0xfa, 0xa2, 0x86,
        0xd2, 0x7a, 0x6e, 0x3c, 0x0e, 0x73, 0xc5, 0xd6, 0xbd, 0x47, 0xd2, 0xb6,
        0x26, 0x97, 0xf7, 0xb5, 0xcc, 0x70, 0x28, 0x6f, 0x31, 0xa7, 0xe2, 0x1b,
        0x5b, 0x18, 0xf9, 0x79, 0x56, 0x2c, 0x98, 0xcd, 0x42, 0x2f, 0xd7, 0x02,
        0x0d, 0x29, 0x7b, 0xa3, 0xc3, 0xb8, 0x08, 0xee, 0x74, 0x84, 0x5d, 0x33,
        0x73, 0x67, 0x1a, 0xf1, 0x05, 0xeb, 0x14, 0x13, 0x63, 0xa1, 0x4a, 0x4c,
        0x51, 0x1f, 0xba, 0x36, 0xa5, 0x30, 0x3c, 0xa1, 0xd3, 0xa0, 0x19, 0x18,
        0xe0, 0x3f, 0xdb, 0xed, 0x23, 0xab, 0xe2, 0x86, 0x19, 0x14, 0xf2, 0xbe,
        0x90, 0xfd, 0x8e, 0x37, 0x8e, 0x7d, 0xbe, 0x38, 0x66, 0xb6, 0x6e, 0x23,
        0xf6, 0x8b, 0xb2, 0xf6, 0x4d, 0xe0, 0x43, 0xbe, 0xd6, 0x24, 0x10, 0xee,
        0x2c, 0x79, 0xc9, 0x90, 0x0b, 0x18, 0x5d, 0xd4, 0x23, 0xaa, 0x81, 0x55,
        0xc1, 0x01, 0xc5, 0xe4, 0x9d, 0xba, 0x47, 0x35, 0xc4, 0xec, 0x15, 0x9b,
        0x19, 0xd5, 0x4f, 0xec, 0x43, 0xcd, 0xa4, 0x02, 0x34, 0xb8, 0x9c, 0x57,
        0x2d, 0x93, 0x75, 0x8f, 0xbf, 0xb3, 0xf1, 0x53, 0xa5, 0xe5, 0xa4, 0xca,
        0xff, 0xd0, 0x8b, 0x69, 0x6f, 0x96, 0x69, 0x6e, 0xe8, 0x0a, 0xe0, 0x71,
        0xb1, 0xb5, 0xe0, 0xb0, 0xdc, 0xd4, 0x8b, 0xa0, 0x7c, 0x0b, 0x2d, 0x7b,
        0x45, 0xe1, 0x6a, 0x82, 0xdd, 0x8d, 0xac, 0xc2, 0xa1, 0x01, 0x2c, 0x1e,
        0xa3, 0xf6, 0x42, 0xa0, 0x64, 0xa6, 0x0c, 0xb5, 0x65, 0x00, 0xe6, 0x33,
        0xa0, 0xe7, 0xef, 0x3b, 0x43, 0xfa, 0xc1, 0x17, 0xe0, 0x30, 0x33, 0x06,
        0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0x30, 0x14,
        0x06, 0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x07, 0x04, 0x08,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x80, 0x10, 0xaf, 0xe5,
        0xff, 0x19, 0x54, 0x36, 0xcb, 0x93, 0xc7, 0x08, 0x8d, 0x30, 0x56, 0x0f,
        0x2b, 0xed
    };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Read certificate for recipient */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the 3-DES-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    desEDE3CBC_OID + 1,
                                    desEDE3CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

   /* Can't use known answer test for RSA OAEP since PKCS1 OAEP API does not
    * take in RNGFun and RNGArg. Perform CMS decrypt to make sure envelop is
    * valid */
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    status = decode_cms(t, cb_mocencode_cms_test_envelopTextDefinite);
    retval += UNITTEST_STATUS (40, status);
    if (retval > 0)
        goto exit;
#else
    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_env_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_env_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);
#endif

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextWithAttributeDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Fixed Data */
    TimeDate fakeTime = { 2015, 11, 11, 11, 0, 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

    unsigned char test_env_cms[] = {
        0x30, 0x82, 0x02, 0xee, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x03, 0xa0, 0x82, 0x02, 0xdf, 0x30, 0x82, 0x02, 0xdb, 0x02,
        0x01, 0x02, 0x31, 0x82, 0x02, 0x7f, 0x30, 0x82, 0x02, 0x7b, 0x02, 0x01,
        0x00, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55,
        0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03,
        0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c,
        0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06,
        0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52,
        0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52,
        0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
        0x00, 0x13, 0x1f, 0xe4, 0x20, 0xdd, 0x6f, 0xc8, 0x26, 0x33, 0xaa, 0xcf,
        0x5b, 0xcd, 0x5e, 0xfe, 0x02, 0x56, 0x65, 0xbc, 0x74, 0xca, 0xb3, 0x34,
        0x9f, 0x65, 0x59, 0x7e, 0xc2, 0x5b, 0x74, 0xa3, 0xc8, 0x4b, 0xe7, 0x60,
        0xcc, 0xcb, 0x25, 0x22, 0x8b, 0xb0, 0x84, 0x2e, 0xe3, 0x52, 0xd7, 0x2b,
        0x7b, 0x00, 0xc5, 0xde, 0x28, 0x62, 0x42, 0x60, 0xfe, 0x71, 0xaf, 0x83,
        0xef, 0xb0, 0x9f, 0xdc, 0xe2, 0x53, 0x08, 0x77, 0xb3, 0xf2, 0xe0, 0xdb,
        0x14, 0x14, 0x2a, 0x57, 0x04, 0xad, 0xf7, 0x42, 0x6a, 0x25, 0x97, 0xc4,
        0x92, 0x3b, 0x5e, 0x1d, 0x99, 0x3f, 0x10, 0x9a, 0xce, 0xd0, 0x62, 0xcb,
        0x85, 0xa8, 0xf9, 0x5b, 0xf7, 0x08, 0xe9, 0xb7, 0xbf, 0x2c, 0xaf, 0xec,
        0x1f, 0xff, 0x0e, 0x6b, 0xae, 0x53, 0x01, 0x01, 0xac, 0x16, 0xa2, 0x28,
        0xed, 0x0c, 0x34, 0x5d, 0x82, 0xcb, 0xba, 0x97, 0x12, 0x37, 0x32, 0x51,
        0xfe, 0x38, 0x0b, 0x67, 0x1d, 0xdf, 0x13, 0x8d, 0xb5, 0xca, 0x9a, 0x53,
        0xf9, 0x3c, 0xba, 0xaf, 0xf4, 0xf8, 0x18, 0xcd, 0xd3, 0xe8, 0x0b, 0x66,
        0x00, 0xf9, 0xa7, 0x16, 0x77, 0xc1, 0x23, 0xb5, 0xae, 0xea, 0x6e, 0x10,
        0xe1, 0x5a, 0x8a, 0x79, 0x02, 0xb0, 0x74, 0x59, 0xf0, 0xc9, 0x87, 0x09,
        0xaf, 0xb4, 0x39, 0xa3, 0xf4, 0x0c, 0x58, 0x06, 0xf4, 0xf7, 0x08, 0x73,
        0x4d, 0x55, 0x9f, 0xf7, 0x4d, 0x2a, 0xb6, 0xff, 0x85, 0x3c, 0x47, 0xce,
        0x84, 0xbe, 0x25, 0xd3, 0x4e, 0xe9, 0xb5, 0xae, 0x7c, 0xb3, 0xb2, 0x1f,
        0x43, 0x8d, 0x74, 0x98, 0xe2, 0x3a, 0xb1, 0x96, 0xd9, 0x9d, 0x04, 0x3a,
        0x7e, 0x26, 0x27, 0x80, 0x94, 0xa4, 0x6a, 0x9b, 0xa7, 0x13, 0xf7, 0xa2,
        0x7c, 0xca, 0xf3, 0xc4, 0xcb, 0xd9, 0x6f, 0x69, 0x2f, 0xc7, 0x6b, 0x33,
        0x37, 0x23, 0xa1, 0x2d, 0x03, 0xe4, 0x71, 0xc0, 0x95, 0x89, 0x22, 0xf2,
        0x15, 0xca, 0x38, 0x85, 0x33, 0x04, 0x36, 0xf5, 0x34, 0xf6, 0xe7, 0x5a,
        0x94, 0x3f, 0x30, 0xfb, 0xf1, 0x8f, 0x99, 0xd4, 0x7a, 0xff, 0x00, 0x2b,
        0xe1, 0x8e, 0x8f, 0xca, 0x99, 0x38, 0xfa, 0x2d, 0xd5, 0xfa, 0xa2, 0x86,
        0xd2, 0x7a, 0x6e, 0x3c, 0x0e, 0x73, 0xc5, 0xd6, 0xbd, 0x47, 0xd2, 0xb6,
        0x26, 0x97, 0xf7, 0xb5, 0xcc, 0x70, 0x28, 0x6f, 0x31, 0xa7, 0xe2, 0x1b,
        0x5b, 0x18, 0xf9, 0x79, 0x56, 0x2c, 0x98, 0xcd, 0x42, 0x2f, 0xd7, 0x02,
        0x0d, 0x29, 0x7b, 0xa3, 0xc3, 0xb8, 0x08, 0xee, 0x74, 0x84, 0x5d, 0x33,
        0x73, 0x67, 0x1a, 0xf1, 0x05, 0xeb, 0x14, 0x13, 0x63, 0xa1, 0x4a, 0x4c,
        0x51, 0x1f, 0xba, 0x36, 0xa5, 0x30, 0x3c, 0xa1, 0xd3, 0xa0, 0x19, 0x18,
        0xe0, 0x3f, 0xdb, 0xed, 0x23, 0xab, 0xe2, 0x86, 0x19, 0x14, 0xf2, 0xbe,
        0x90, 0xfd, 0x8e, 0x37, 0x8e, 0x7d, 0xbe, 0x38, 0x66, 0xb6, 0x6e, 0x23,
        0xf6, 0x8b, 0xb2, 0xf6, 0x4d, 0xe0, 0x43, 0xbe, 0xd6, 0x24, 0x10, 0xee,
        0x2c, 0x79, 0xc9, 0x90, 0x0b, 0x18, 0x5d, 0xd4, 0x23, 0xaa, 0x81, 0x55,
        0xc1, 0x01, 0xc5, 0xe4, 0x9d, 0xba, 0x47, 0x35, 0xc4, 0xec, 0x15, 0x9b,
        0x19, 0xd5, 0x4f, 0xec, 0x43, 0xcd, 0xa4, 0x02, 0x34, 0xb8, 0x9c, 0x57,
        0x2d, 0x93, 0x75, 0x8f, 0xbf, 0xb3, 0xf1, 0x53, 0xa5, 0xe5, 0xa4, 0xca,
        0xff, 0xd0, 0x8b, 0x69, 0x6f, 0x96, 0x69, 0x6e, 0xe8, 0x0a, 0xe0, 0x71,
        0xb1, 0xb5, 0xe0, 0xb0, 0xdc, 0xd4, 0x8b, 0xa0, 0x7c, 0x0b, 0x2d, 0x7b,
        0x45, 0xe1, 0x6a, 0x82, 0xdd, 0x8d, 0xac, 0xc2, 0xa1, 0x01, 0x2c, 0x1e,
        0xa3, 0xf6, 0x42, 0xa0, 0x64, 0xa6, 0x0c, 0xb5, 0x65, 0x00, 0xe6, 0x33,
        0xa0, 0xe7, 0xef, 0x3b, 0x43, 0xfa, 0xc1, 0x17, 0xe0, 0x30, 0x33, 0x06,
        0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0x30, 0x14,
        0x06, 0x08, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x03, 0x07, 0x04, 0x08,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x80, 0x10, 0xaf, 0xe5,
        0xff, 0x19, 0x54, 0x36, 0xcb, 0x93, 0xc7, 0x08, 0x8d, 0x30, 0x56, 0x0f,
        0x2b, 0xed, 0xa1, 0x1e, 0x30, 0x1c, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86,
        0xf7, 0x0d, 0x01, 0x09, 0x05, 0x31, 0x0f, 0x17, 0x0d, 0x38, 0x35, 0x31,
        0x31, 0x31, 0x31, 0x31, 0x31, 0x30, 0x30, 0x30, 0x30, 0x5a
    };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Read certificate for recipient */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the 3-DES-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    desEDE3CBC_OID + 1,
                                    desEDE3CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Add Time Attribute (just as a test) */
    status = DIGI_CMS_addUnprotectedAttribute (ctx,
                                              PKCS9_SIGNINGTIME_OID, sizeof(PKCS9_SIGNINGTIME_OID),
                                              MASN1_TYPE_UTC_TIME,
                                              (ubyte*)&fakeTime, 0);
    retval += UNITTEST_STATUS (16, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

   /* Can't use known answer test for RSA OAEP since PKCS1 OAEP API does not
    * take in RNGFun and RNGArg. Perform CMS decrypt to make sure envelop is
    * valid */
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    status = decode_cms(t, cb_mocencode_cms_test_envelopTextDefinite);
    retval += UNITTEST_STATUS (40, status);
    if (retval > 0)
        goto exit;
#else
    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_env_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_env_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);
#endif

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextTwoRecipientsDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

    unsigned char test_env_cms[] = {
        0x30, 0x82, 0x04, 0x86, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x07, 0x03, 0xa0, 0x82, 0x04, 0x77, 0x30, 0x82, 0x04, 0x73, 0x02,
        0x01, 0x00, 0x31, 0x82, 0x04, 0x37, 0x30, 0x82, 0x02, 0x7b, 0x02, 0x01,
        0x00, 0x30, 0x63, 0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55,
        0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03,
        0x55, 0x04, 0x08, 0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c,
        0x61, 0x6b, 0x65, 0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06,
        0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52,
        0x53, 0x41, 0x2d, 0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52,
        0xcd, 0x3a, 0xad, 0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
        0x00, 0x13, 0x1f, 0xe4, 0x20, 0xdd, 0x6f, 0xc8, 0x26, 0x33, 0xaa, 0xcf,
        0x5b, 0xcd, 0x5e, 0xfe, 0x02, 0x56, 0x65, 0xbc, 0x74, 0xca, 0xb3, 0x34,
        0x9f, 0x65, 0x59, 0x7e, 0xc2, 0x5b, 0x74, 0xa3, 0xc8, 0x4b, 0xe7, 0x60,
        0xcc, 0xcb, 0x25, 0x22, 0x8b, 0xb0, 0x84, 0x2e, 0xe3, 0x52, 0xd7, 0x2b,
        0x7b, 0x00, 0xc5, 0xde, 0x28, 0x62, 0x42, 0x60, 0xfe, 0x71, 0xaf, 0x83,
        0xef, 0xb0, 0x9f, 0xdc, 0xe2, 0x53, 0x08, 0x77, 0xb3, 0xf2, 0xe0, 0xdb,
        0x14, 0x14, 0x2a, 0x57, 0x04, 0xad, 0xf7, 0x42, 0x6a, 0x25, 0x97, 0xc4,
        0x92, 0x3b, 0x5e, 0x1d, 0x99, 0x3f, 0x10, 0x9a, 0xce, 0xd0, 0x62, 0xcb,
        0x85, 0xa8, 0xf9, 0x5b, 0xf7, 0x08, 0xe9, 0xb7, 0xbf, 0x2c, 0xaf, 0xec,
        0x1f, 0xff, 0x0e, 0x6b, 0xae, 0x53, 0x01, 0x01, 0xac, 0x16, 0xa2, 0x28,
        0xed, 0x0c, 0x34, 0x5d, 0x82, 0xcb, 0xba, 0x97, 0x12, 0x37, 0x32, 0x51,
        0xfe, 0x38, 0x0b, 0x67, 0x1d, 0xdf, 0x13, 0x8d, 0xb5, 0xca, 0x9a, 0x53,
        0xf9, 0x3c, 0xba, 0xaf, 0xf4, 0xf8, 0x18, 0xcd, 0xd3, 0xe8, 0x0b, 0x66,
        0x00, 0xf9, 0xa7, 0x16, 0x77, 0xc1, 0x23, 0xb5, 0xae, 0xea, 0x6e, 0x10,
        0xe1, 0x5a, 0x8a, 0x79, 0x02, 0xb0, 0x74, 0x59, 0xf0, 0xc9, 0x87, 0x09,
        0xaf, 0xb4, 0x39, 0xa3, 0xf4, 0x0c, 0x58, 0x06, 0xf4, 0xf7, 0x08, 0x73,
        0x4d, 0x55, 0x9f, 0xf7, 0x4d, 0x2a, 0xb6, 0xff, 0x85, 0x3c, 0x47, 0xce,
        0x84, 0xbe, 0x25, 0xd3, 0x4e, 0xe9, 0xb5, 0xae, 0x7c, 0xb3, 0xb2, 0x1f,
        0x43, 0x8d, 0x74, 0x98, 0xe2, 0x3a, 0xb1, 0x96, 0xd9, 0x9d, 0x04, 0x3a,
        0x7e, 0x26, 0x27, 0x80, 0x94, 0xa4, 0x6a, 0x9b, 0xa7, 0x13, 0xf7, 0xa2,
        0x7c, 0xca, 0xf3, 0xc4, 0xcb, 0xd9, 0x6f, 0x69, 0x2f, 0xc7, 0x6b, 0x33,
        0x37, 0x23, 0xa1, 0x2d, 0x03, 0xe4, 0x71, 0xc0, 0x95, 0x89, 0x22, 0xf2,
        0x15, 0xca, 0x38, 0x85, 0x33, 0x04, 0x36, 0xf5, 0x34, 0xf6, 0xe7, 0x5a,
        0x94, 0x3f, 0x30, 0xfb, 0xf1, 0x8f, 0x99, 0xd4, 0x7a, 0xff, 0x00, 0x2b,
        0xe1, 0x8e, 0x8f, 0xca, 0x99, 0x38, 0xfa, 0x2d, 0xd5, 0xfa, 0xa2, 0x86,
        0xd2, 0x7a, 0x6e, 0x3c, 0x0e, 0x73, 0xc5, 0xd6, 0xbd, 0x47, 0xd2, 0xb6,
        0x26, 0x97, 0xf7, 0xb5, 0xcc, 0x70, 0x28, 0x6f, 0x31, 0xa7, 0xe2, 0x1b,
        0x5b, 0x18, 0xf9, 0x79, 0x56, 0x2c, 0x98, 0xcd, 0x42, 0x2f, 0xd7, 0x02,
        0x0d, 0x29, 0x7b, 0xa3, 0xc3, 0xb8, 0x08, 0xee, 0x74, 0x84, 0x5d, 0x33,
        0x73, 0x67, 0x1a, 0xf1, 0x05, 0xeb, 0x14, 0x13, 0x63, 0xa1, 0x4a, 0x4c,
        0x51, 0x1f, 0xba, 0x36, 0xa5, 0x30, 0x3c, 0xa1, 0xd3, 0xa0, 0x19, 0x18,
        0xe0, 0x3f, 0xdb, 0xed, 0x23, 0xab, 0xe2, 0x86, 0x19, 0x14, 0xf2, 0xbe,
        0x90, 0xfd, 0x8e, 0x37, 0x8e, 0x7d, 0xbe, 0x38, 0x66, 0xb6, 0x6e, 0x23,
        0xf6, 0x8b, 0xb2, 0xf6, 0x4d, 0xe0, 0x43, 0xbe, 0xd6, 0x24, 0x10, 0xee,
        0x2c, 0x79, 0xc9, 0x90, 0x0b, 0x18, 0x5d, 0xd4, 0x23, 0xaa, 0x81, 0x55,
        0xc1, 0x01, 0xc5, 0xe4, 0x9d, 0xba, 0x47, 0x35, 0xc4, 0xec, 0x15, 0x9b,
        0x19, 0xd5, 0x4f, 0xec, 0x43, 0xcd, 0xa4, 0x02, 0x34, 0xb8, 0x9c, 0x57,
        0x2d, 0x93, 0x75, 0x8f, 0xbf, 0xb3, 0xf1, 0x53, 0xa5, 0xe5, 0xa4, 0xca,
        0xff, 0xd0, 0x8b, 0x69, 0x6f, 0x96, 0x69, 0x6e, 0xe8, 0x0a, 0xe0, 0x71,
        0xb1, 0xb5, 0xe0, 0xb0, 0xdc, 0xd4, 0x8b, 0xa0, 0x7c, 0x0b, 0x2d, 0x7b,
        0x45, 0xe1, 0x6a, 0x82, 0xdd, 0x8d, 0xac, 0xc2, 0xa1, 0x01, 0x2c, 0x1e,
        0xa3, 0xf6, 0x42, 0xa0, 0x64, 0xa6, 0x0c, 0xb5, 0x65, 0x00, 0xe6, 0x33,
        0xa0, 0xe7, 0xef, 0x3b, 0x43, 0xfa, 0xc1, 0x17, 0xe0, 0x30, 0x82, 0x01,
        0xb4, 0x02, 0x01, 0x00, 0x30, 0x81, 0x9b, 0x30, 0x81, 0x94, 0x31, 0x13,
        0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x0a, 0x4e, 0x69, 0x68,
        0x6f, 0x6e, 0x5a, 0x61, 0x72, 0x75, 0x32, 0x31, 0x0f, 0x30, 0x0d, 0x06,
        0x03, 0x55, 0x04, 0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x03, 0x69,
        0x6f, 0x74, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c,
        0x0a, 0x43, 0x61, 0x6c, 0x69, 0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31,
        0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53,
        0x31, 0x16, 0x30, 0x14, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x0d, 0x53,
        0x61, 0x6e, 0x20, 0x46, 0x72, 0x61, 0x6e, 0x63, 0x69, 0x73, 0x63, 0x6f,
        0x31, 0x24, 0x30, 0x22, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x09, 0x01, 0x16, 0x15, 0x74, 0x65, 0x73, 0x74, 0x6d, 0x6f, 0x6e,
        0x6b, 0x65, 0x79, 0x40, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63,
        0x6f, 0x6d, 0x02, 0x02, 0x00, 0xff, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x01,
        0x00, 0x12, 0x32, 0x97, 0x2a, 0x87, 0x2d, 0x8a, 0xf5, 0x4f, 0x4a, 0x8c,
        0x92, 0x94, 0x45, 0x9b, 0x23, 0xbc, 0xc2, 0x51, 0x79, 0xea, 0xf9, 0x9d,
        0x7a, 0x53, 0xe4, 0x7d, 0x54, 0x6c, 0xea, 0xa1, 0xeb, 0x07, 0x4d, 0xa6,
        0xa4, 0x91, 0xf3, 0x55, 0xfc, 0xbc, 0xcc, 0xdd, 0xaa, 0xf1, 0x50, 0xcc,
        0xfd, 0x21, 0x54, 0x77, 0x19, 0x00, 0x22, 0x04, 0xcd, 0xbf, 0x1b, 0xed,
        0x42, 0xac, 0x97, 0x26, 0x2d, 0xcb, 0xbd, 0xbf, 0xad, 0x48, 0xb3, 0xe5,
        0x21, 0xe4, 0x74, 0xc0, 0x95, 0x91, 0x96, 0xb8, 0x67, 0xfa, 0x44, 0x94,
        0xa9, 0xa3, 0x16, 0xed, 0xaf, 0xb8, 0x13, 0xbb, 0xb8, 0xcc, 0xdc, 0x10,
        0x74, 0xbb, 0x2e, 0x3a, 0x54, 0xf5, 0x50, 0x9c, 0x65, 0xb0, 0x18, 0x1f,
        0xd9, 0xf5, 0x8b, 0xca, 0xe1, 0x7e, 0x13, 0x64, 0x06, 0xd5, 0x22, 0xa4,
        0x39, 0x1c, 0x7f, 0xa3, 0x9b, 0x70, 0xb3, 0x9c, 0x5e, 0x18, 0x58, 0x93,
        0x07, 0xe1, 0xa1, 0x4b, 0x42, 0x11, 0x8c, 0x83, 0x02, 0x8c, 0xb9, 0x0a,
        0x49, 0x02, 0x15, 0xfc, 0x07, 0xb0, 0xfb, 0xc5, 0x64, 0x38, 0x17, 0x70,
        0xbb, 0x57, 0xb4, 0xfa, 0xf3, 0xe9, 0x98, 0x7a, 0xa1, 0xc0, 0x39, 0x29,
        0xba, 0x52, 0x84, 0x39, 0x3e, 0x8a, 0x3c, 0x40, 0x54, 0x89, 0xc6, 0xdf,
        0x7c, 0x78, 0x17, 0xdf, 0x40, 0x8d, 0xed, 0xa5, 0xb2, 0x6c, 0x37, 0xb4,
        0x83, 0x26, 0x58, 0x11, 0x36, 0x6f, 0xed, 0x53, 0x8f, 0x6a, 0xe2, 0x4c,
        0x35, 0xbc, 0x0c, 0x4b, 0x68, 0x27, 0x2d, 0x81, 0x17, 0xf5, 0xd3, 0x44,
        0x99, 0xb9, 0x2d, 0xb5, 0x04, 0xff, 0xc6, 0x7b, 0x9d, 0x82, 0x06, 0x5b,
        0xd9, 0xd9, 0xae, 0x70, 0xfd, 0xb7, 0x27, 0x91, 0x9d, 0xae, 0xe6, 0x7f,
        0xec, 0xb7, 0xe1, 0x72, 0x09, 0x97, 0xab, 0x77, 0x41, 0x89, 0xfa, 0xa7,
        0x8b, 0xdc, 0xf9, 0x9e, 0x7a, 0x30, 0x33, 0x06, 0x09, 0x2a, 0x86, 0x48,
        0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0x30, 0x14, 0x06, 0x08, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x03, 0x07, 0x04, 0x08, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x80, 0x10, 0xaf, 0xe5, 0xff, 0x19, 0x54, 0x36,
        0xcb, 0x93, 0xc7, 0x08, 0x8d, 0x30, 0x56, 0x0f, 0x2b, 0xed
    };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the 3-DES-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    desEDE3CBC_OID + 1,
                                    desEDE3CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;


    /* Read certificate for recipient */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Add first recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    DIGI_FREE ((void**)&pCert);

    /* Read certificate for recipient */
    status = DIGICERT_readFile("recipient2.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (13, status);
    if (0 < retval)
       goto exit;

    /* Add second recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (13, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

   /* Can't use known answer test for RSA OAEP since PKCS1 OAEP API does not
    * take in RNGFun and RNGArg. Perform CMS decrypt to make sure envelop is
    * valid */
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    status = decode_cms(t, cb_mocencode_cms_test_envelopTextDefinite);
    retval += UNITTEST_STATUS (40, status);
    if (retval > 0)
        goto exit;
#else
    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_env_cms));
    if (retval > 0)
        goto exit;

    status = DIGI_MEMCMP (t->buf, test_env_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);
#endif

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextECDHDefinite()
{
#if (defined(__ENABLE_DIGICERT_ECC__))
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

    unsigned char test_env_cms[] =
    {
        0x30, 0x82, 0x02, 0x14, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x03, 0xa0,
        0x82, 0x02, 0x05, 0x30, 0x82, 0x02, 0x01, 0x02, 0x01, 0x02, 0x31, 0x82, 0x01, 0xbc, 0xa1, 0x82,
        0x01, 0xb8, 0x02, 0x01, 0x03, 0xa0, 0x81, 0x99, 0xa1, 0x81, 0x96, 0x30, 0x0b, 0x06, 0x07, 0x2a,
        0x86, 0x48, 0xce, 0x3d, 0x02, 0x01, 0x05, 0x00, 0x03, 0x81, 0x86, 0x00, 0x04, 0x00, 0xe8, 0x8c,
        0xed, 0x68, 0x14, 0x0e, 0x42, 0x87, 0xda, 0x04, 0x21, 0xe1, 0xd5, 0x5e, 0xff, 0xaa, 0x96, 0xad,
        0xf7, 0x0e, 0x51, 0x40, 0x34, 0x2a, 0xe2, 0x81, 0xc3, 0x74, 0xd0, 0xfc, 0xf2, 0x72, 0x2b, 0x3e,
        0xe0, 0x3a, 0x32, 0xe4, 0xb7, 0x12, 0x9a, 0xd8, 0xbf, 0xee, 0x65, 0x51, 0x4b, 0x56, 0x93, 0xf7,
        0x90, 0x4a, 0xe9, 0x65, 0x37, 0xbf, 0x1d, 0xe3, 0xb6, 0xaa, 0xe2, 0x44, 0x6b, 0x41, 0x6a, 0x01,
        0x85, 0xa6, 0x26, 0x04, 0xdb, 0xee, 0x23, 0x2e, 0xdb, 0xd3, 0xc1, 0x29, 0x03, 0x21, 0x85, 0x0d,
        0xcf, 0xe3, 0x32, 0xcc, 0xa7, 0x48, 0x8d, 0x7b, 0xea, 0xbe, 0x7b, 0x2c, 0x04, 0x28, 0xf5, 0x1f,
        0x2c, 0xa1, 0x8c, 0x92, 0x27, 0xdb, 0x57, 0x78, 0xb9, 0xcb, 0x21, 0x8e, 0x5c, 0xcf, 0x41, 0xcd,
        0xbf, 0x4d, 0x7b, 0xfa, 0xf9, 0x5e, 0xee, 0x58, 0x7d, 0x86, 0x23, 0x40, 0x87, 0xe9, 0xe3, 0x02,
        0x09, 0xa1, 0x12, 0x04, 0x10, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x30, 0x17, 0x06, 0x06, 0x2b, 0x81, 0x04, 0x01, 0x0b, 0x03, 0x30,
        0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x01, 0x05, 0x05, 0x00, 0x30, 0x81,
        0xe9, 0x30, 0x81, 0xe6, 0x30, 0x81, 0xc9, 0x30, 0x81, 0xb0, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03,
        0x55, 0x04, 0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08,
        0x13, 0x0a, 0x43, 0x61, 0x6c, 0x69, 0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31, 0x16, 0x30, 0x14,
        0x06, 0x03, 0x55, 0x04, 0x07, 0x13, 0x0d, 0x53, 0x61, 0x6e, 0x20, 0x46, 0x72, 0x61, 0x6e, 0x63,
        0x69, 0x73, 0x63, 0x6f, 0x31, 0x21, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x13, 0x18, 0x45,
        0x6e, 0x67, 0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x20, 0x43, 0x41, 0x20, 0x28, 0x45,
        0x43, 0x43, 0x20, 0x35, 0x32, 0x31, 0x29, 0x31, 0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x0b,
        0x13, 0x0b, 0x45, 0x6e, 0x67, 0x69, 0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x31, 0x1b, 0x30,
        0x19, 0x06, 0x03, 0x55, 0x04, 0x03, 0x13, 0x12, 0x73, 0x73, 0x6c, 0x74, 0x65, 0x73, 0x74, 0x2e,
        0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f, 0x6d, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x09,
        0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x09, 0x01, 0x16, 0x0f, 0x69, 0x6e, 0x66, 0x6f, 0x40,
        0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x2e, 0x63, 0x6f, 0x6d, 0x02, 0x14, 0x73, 0xeb, 0x15, 0xcd,
        0xea, 0xc6, 0xdc, 0x4c, 0x5c, 0xa8, 0x67, 0x27, 0xde, 0x8f, 0x77, 0x22, 0x31, 0x60, 0x6d, 0xf0,
        0x04, 0x18, 0xbd, 0xc0, 0x6b, 0x7d, 0xe8, 0xeb, 0x14, 0xa1, 0xf6, 0x1d, 0x74, 0x3e, 0x51, 0xe8,
        0x11, 0x6f, 0x66, 0xde, 0xa1, 0x1e, 0x7f, 0x2c, 0x79, 0x9f, 0x30, 0x3c, 0x06, 0x09, 0x2a, 0x86,
        0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0x30, 0x1d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
        0x03, 0x04, 0x01, 0x02, 0x04, 0x10, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x80, 0x10, 0x45, 0x20, 0x30, 0xea, 0x87, 0x9a, 0x67, 0xee,
        0x01, 0xf9, 0x87, 0x76, 0xe8, 0x19, 0x5e, 0xb9
    };

    /* Read certificate for recipient */
    status = DIGICERT_readFile("ecc_selfcert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the AES128-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    aes128CBC_OID + 1,
                                    aes128CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_env_cms));
    if (retval > 0)
        goto exit;
    
    status = DIGI_MEMCMP (t->buf, test_env_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
#else
    printf("**** ECDH envelop tests disabled!\n");
    return 0;
#endif
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Read certificate for recipient */
    status = DIGICERT_readFile("signer_rsa_crt.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the 3-DES-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    desEDE3CBC_OID + 1,
                                    desEDE3CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopTextECDHIndefinite()
{
#if (defined(__ENABLE_DIGICERT_ECC__))
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = { 'A', ' ', 'S', 'E', 'C', 'R', 'E', 'T' };

    unsigned char test_env_cms[] =
    {
        0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x03, 0xa0, 0x80, 0x30,
        0x80, 0x02, 0x01, 0x02, 0x31, 0x82, 0x01, 0xbc, 0xa1, 0x82, 0x01, 0xb8, 0x02, 0x01, 0x03, 0xa0,
        0x81, 0x99, 0xa1, 0x81, 0x96, 0x30, 0x0b, 0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01,
        0x05, 0x00, 0x03, 0x81, 0x86, 0x00, 0x04, 0x00, 0xe8, 0x8c, 0xed, 0x68, 0x14, 0x0e, 0x42, 0x87,
        0xda, 0x04, 0x21, 0xe1, 0xd5, 0x5e, 0xff, 0xaa, 0x96, 0xad, 0xf7, 0x0e, 0x51, 0x40, 0x34, 0x2a,
        0xe2, 0x81, 0xc3, 0x74, 0xd0, 0xfc, 0xf2, 0x72, 0x2b, 0x3e, 0xe0, 0x3a, 0x32, 0xe4, 0xb7, 0x12,
        0x9a, 0xd8, 0xbf, 0xee, 0x65, 0x51, 0x4b, 0x56, 0x93, 0xf7, 0x90, 0x4a, 0xe9, 0x65, 0x37, 0xbf,
        0x1d, 0xe3, 0xb6, 0xaa, 0xe2, 0x44, 0x6b, 0x41, 0x6a, 0x01, 0x85, 0xa6, 0x26, 0x04, 0xdb, 0xee,
        0x23, 0x2e, 0xdb, 0xd3, 0xc1, 0x29, 0x03, 0x21, 0x85, 0x0d, 0xcf, 0xe3, 0x32, 0xcc, 0xa7, 0x48,
        0x8d, 0x7b, 0xea, 0xbe, 0x7b, 0x2c, 0x04, 0x28, 0xf5, 0x1f, 0x2c, 0xa1, 0x8c, 0x92, 0x27, 0xdb,
        0x57, 0x78, 0xb9, 0xcb, 0x21, 0x8e, 0x5c, 0xcf, 0x41, 0xcd, 0xbf, 0x4d, 0x7b, 0xfa, 0xf9, 0x5e,
        0xee, 0x58, 0x7d, 0x86, 0x23, 0x40, 0x87, 0xe9, 0xe3, 0x02, 0x09, 0xa1, 0x12, 0x04, 0x10, 0x55,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x30,
        0x17, 0x06, 0x06, 0x2b, 0x81, 0x04, 0x01, 0x0b, 0x03, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48,
        0x01, 0x65, 0x03, 0x04, 0x01, 0x05, 0x05, 0x00, 0x30, 0x81, 0xe9, 0x30, 0x81, 0xe6, 0x30, 0x81,
        0xc9, 0x30, 0x81, 0xb0, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x55,
        0x53, 0x31, 0x13, 0x30, 0x11, 0x06, 0x03, 0x55, 0x04, 0x08, 0x13, 0x0a, 0x43, 0x61, 0x6c, 0x69,
        0x66, 0x6f, 0x72, 0x6e, 0x69, 0x61, 0x31, 0x16, 0x30, 0x14, 0x06, 0x03, 0x55, 0x04, 0x07, 0x13,
        0x0d, 0x53, 0x61, 0x6e, 0x20, 0x46, 0x72, 0x61, 0x6e, 0x63, 0x69, 0x73, 0x63, 0x6f, 0x31, 0x21,
        0x30, 0x1f, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x13, 0x18, 0x45, 0x6e, 0x67, 0x69, 0x6e, 0x65, 0x65,
        0x72, 0x69, 0x6e, 0x67, 0x20, 0x43, 0x41, 0x20, 0x28, 0x45, 0x43, 0x43, 0x20, 0x35, 0x32, 0x31,
        0x29, 0x31, 0x14, 0x30, 0x12, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x13, 0x0b, 0x45, 0x6e, 0x67, 0x69,
        0x6e, 0x65, 0x65, 0x72, 0x69, 0x6e, 0x67, 0x31, 0x1b, 0x30, 0x19, 0x06, 0x03, 0x55, 0x04, 0x03,
        0x13, 0x12, 0x73, 0x73, 0x6c, 0x74, 0x65, 0x73, 0x74, 0x2e, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x2e, 0x63, 0x6f, 0x6d, 0x31, 0x1e, 0x30, 0x1c, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d,
        0x01, 0x09, 0x01, 0x16, 0x0f, 0x69, 0x6e, 0x66, 0x6f, 0x40, 0x6d, 0x6f, 0x63, 0x61, 0x6e, 0x61,
        0x2e, 0x63, 0x6f, 0x6d, 0x02, 0x14, 0x73, 0xeb, 0x15, 0xcd, 0xea, 0xc6, 0xdc, 0x4c, 0x5c, 0xa8,
        0x67, 0x27, 0xde, 0x8f, 0x77, 0x22, 0x31, 0x60, 0x6d, 0xf0, 0x04, 0x18, 0xbd, 0xc0, 0x6b, 0x7d,
        0xe8, 0xeb, 0x14, 0xa1, 0xf6, 0x1d, 0x74, 0x3e, 0x51, 0xe8, 0x11, 0x6f, 0x66, 0xde, 0xa1, 0x1e,
        0x7f, 0x2c, 0x79, 0x9f, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
        0x01, 0x30, 0x1d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x01, 0x02, 0x04, 0x10,
        0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55,
        0xa0, 0x80, 0x04, 0x10, 0x45, 0x20, 0x30, 0xea, 0x87, 0x9a, 0x67, 0xee, 0x01, 0xf9, 0x87, 0x76,
        0xe8, 0x19, 0x5e, 0xb9, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    /* Read certificate for recipient */
    status = DIGICERT_readFile("ecc_selfcert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the AES128-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    aes128CBC_OID + 1,
                                    aes128CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_TRUE (31, t->bufUsed > 0);
    if (retval > 0)
        goto exit;

    retval += UNITTEST_INT(40, t->bufUsed, sizeof(test_env_cms));
    if (retval > 0)
        goto exit;
    
    status = DIGI_MEMCMP (t->buf, test_env_cms, t->bufUsed, &cmpResult);
    retval += UNITTEST_STATUS (41, status);
    if (0 < retval)
       goto exit;

    retval += UNITTEST_INT(41, cmpResult, 0);

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
#else
    printf("**** ECDH envelop tests disabled!\n");
    return 0;
#endif
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopLargeTextDefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = {
      0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
      0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
      0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
      0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
      0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
      0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
      0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63,
      0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
      0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
      0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
      0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
      0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
      0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
      0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
      0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
      0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
      0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb,
      0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9,
      0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54,
      0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06,
      0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef,
      0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2,
      0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8,
      0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf,
      0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86,
      0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98,
      0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60,
      0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d,
      0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18,
      0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a,
      0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80,
      0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93,
      0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63,
      0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56,
      0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd,
      0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55,
      0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62,
      0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d,
      0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78,
      0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85,
      0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77,
      0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16,
      0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f,
      0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e,
      0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6,
      0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe,
      0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47,
      0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26,
      0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39,
      0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5,
      0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5,
      0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15,
      0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20,
      0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25,
      0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93,
      0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e,
      0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93,
      0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5,
      0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00
    };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Read certificate for recipient */
    status = DIGICERT_readFile("recipient1.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    FALSE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the AES256-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    aes256CBC_OID + 1,
                                    aes256CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data */
    status = DIGI_CMS_updateContextOut (ctx, payLoad, sizeof(payLoad), TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopLargeTextIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte4               firstLen;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = {
      0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
      0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
      0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
      0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
      0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
      0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
      0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63,
      0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
      0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
      0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
      0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
      0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
      0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
      0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
      0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
      0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
      0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
      0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb,
      0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9,
      0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54,
      0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06,
      0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef,
      0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2,
      0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8,
      0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf,
      0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86,
      0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98,
      0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60,
      0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d,
      0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18,
      0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a,
      0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80,
      0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93,
      0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63,
      0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56,
      0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd,
      0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55,
      0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62,
      0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d,
      0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78,
      0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85,
      0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77,
      0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16,
      0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f,
      0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e,
      0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6,
      0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe,
      0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47,
      0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26,
      0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39,
      0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5,
      0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5,
      0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15,
      0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20,
      0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25,
      0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93,
      0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e,
      0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93,
      0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5,
      0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00
    };

#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
     /* Need to initialize for OAEP since it uses the g_pRandomContext */
     InitMocanaSetupInfo setupInfo = {
        .MocSymRandOperator = NULL,
        .pOperatorInfo = NULL,
        /**********************************************************
         *************** DO NOT USE MOC_NO_AUTOSEED ***************
         ***************** in any production code. ****************
         **********************************************************/
        .flags = MOC_NO_AUTOSEED,
        .pStaticMem = NULL,
        .staticMemSize = 0,
        .pDigestOperators = NULL,
        .digestOperatorCount = 0,
        .pSymOperators = NULL,
        .symOperatorCount = 0,
        .pKeyOperators = NULL,
        .keyOperatorCount = 0
    };
    
    status = DIGICERT_initialize(&setupInfo, NULL);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;
#endif

    /* Read certificate for recipient */
    status = DIGICERT_readFile("recipient1.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the AES256-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    aes256CBC_OID + 1,
                                    aes256CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data in two packets */
    firstLen = sizeof(payLoad) / 2;
    status = DIGI_CMS_updateContextOut (ctx, payLoad, firstLen, FALSE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_updateContextOut (ctx, payLoad + firstLen, sizeof(payLoad) - firstLen, TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
#if defined(__ENABLE_DIGICERT_CMS_RSA_OAEP_DEFAULT__)
    DIGICERT_freeDigicert();
#endif
    return retval;
}


/*----------------------------------------------------------------------*/

int mocencode_cms_test_envelopLargeTextECDHIndefinite()
{
    MSTATUS status;
    int retval = 0;
    sbyte4 cmpResult;

    internal_test        *t = NULL;
    MOC_CMS_context      ctx = NULL;
    ubyte4               firstLen;
    ubyte                *pCert = NULL;
    ubyte4               certLen;
    struct AsymmetricKey key = { 0 };

    /* Data to envelop */
    ubyte payLoad[] = {
            0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07,
            0x02, 0xa0, 0x80, 0x30, 0x80, 0x02, 0x01, 0x01, 0x31, 0x0f, 0x30, 0x0d,
            0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65, 0x03, 0x04, 0x02, 0x01, 0x05,
            0x00, 0x30, 0x80, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01,
            0x07, 0x01, 0xa0, 0x80, 0x24, 0x80, 0x04, 0x09, 0x41, 0x55, 0x54, 0x48,
            0x45, 0x4e, 0x54, 0x49, 0x43, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x31,
            0x82, 0x02, 0x8e, 0x30, 0x82, 0x02, 0x8a, 0x02, 0x01, 0x01, 0x30, 0x63,
            0x30, 0x56, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13,
            0x02, 0x55, 0x53, 0x31, 0x10, 0x30, 0x0e, 0x06, 0x03, 0x55, 0x04, 0x08,
            0x0c, 0x07, 0x46, 0x6c, 0x6f, 0x72, 0x69, 0x64, 0x61, 0x31, 0x11, 0x30,
            0x0f, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x08, 0x4c, 0x61, 0x6b, 0x65,
            0x6c, 0x61, 0x6e, 0x64, 0x31, 0x0f, 0x30, 0x0d, 0x06, 0x03, 0x55, 0x04,
            0x0a, 0x0c, 0x06, 0x4d, 0x6f, 0x63, 0x61, 0x6e, 0x61, 0x31, 0x11, 0x30,
            0x0f, 0x06, 0x03, 0x55, 0x04, 0x0b, 0x0c, 0x08, 0x52, 0x53, 0x41, 0x2d,
            0x34, 0x30, 0x39, 0x36, 0x02, 0x09, 0x00, 0x8d, 0x52, 0xcd, 0x3a, 0xad,
            0x69, 0x44, 0x10, 0x30, 0x0d, 0x06, 0x09, 0x60, 0x86, 0x48, 0x01, 0x65,
            0x03, 0x04, 0x02, 0x01, 0x05, 0x00, 0x30, 0x0d, 0x06, 0x09, 0x2a, 0x86,
            0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05, 0x00, 0x04, 0x82, 0x02,
            0x00, 0x2a, 0xec, 0xc2, 0x91, 0xd8, 0xfe, 0x31, 0x32, 0x5a, 0xa9, 0xfb,
            0x44, 0xbd, 0x1b, 0xe9, 0x13, 0xd6, 0xf5, 0x71, 0x89, 0x11, 0xe5, 0xd9,
            0x73, 0xb9, 0x58, 0x76, 0x57, 0x17, 0x7c, 0xb4, 0x37, 0xd6, 0x50, 0x54,
            0xa1, 0x0b, 0x2f, 0x57, 0x84, 0xc0, 0x1f, 0xbc, 0x7a, 0x6c, 0xa5, 0x06,
            0x97, 0x1d, 0xea, 0x19, 0x2a, 0xef, 0x34, 0xdb, 0x91, 0xb5, 0xa0, 0xef,
            0x08, 0x4c, 0xc2, 0x43, 0x02, 0x06, 0x08, 0x64, 0xfe, 0xac, 0xbb, 0xf2,
            0xbf, 0xda, 0xc6, 0xeb, 0x5e, 0x0f, 0x5f, 0xc4, 0x81, 0xf1, 0xb3, 0xe8,
            0x44, 0x5a, 0xa5, 0x7d, 0xf1, 0x1c, 0x50, 0x8d, 0x3f, 0xb3, 0xbe, 0xbf,
            0xe3, 0xed, 0xea, 0x6e, 0x36, 0xd2, 0x9e, 0xf1, 0x0f, 0xe7, 0xea, 0x86,
            0x01, 0x7b, 0xd1, 0x1b, 0xf8, 0xa2, 0xae, 0x59, 0x1f, 0xc9, 0xb0, 0x98,
            0x68, 0x17, 0x10, 0x68, 0x94, 0x1a, 0xea, 0x1b, 0x73, 0xe4, 0x16, 0x60,
            0x2d, 0xd9, 0x3a, 0x5e, 0x60, 0x06, 0xb1, 0xe8, 0x36, 0xee, 0x2e, 0x2d,
            0x6e, 0xcd, 0x31, 0xaf, 0x6e, 0xdc, 0x65, 0x04, 0x50, 0x21, 0x52, 0x18,
            0xfc, 0xb4, 0x18, 0x4e, 0x9e, 0x2e, 0xdc, 0x4a, 0xc2, 0xac, 0x5a, 0x9a,
            0xe4, 0xd1, 0xfe, 0xc3, 0xfe, 0xa2, 0xf1, 0xec, 0x41, 0x0b, 0x21, 0x80,
            0xc8, 0xc3, 0x98, 0x27, 0xe1, 0x28, 0xeb, 0x2f, 0x07, 0xf1, 0x72, 0x93,
            0xc9, 0x94, 0x68, 0x2c, 0x2e, 0x9c, 0x98, 0x01, 0xbb, 0x91, 0xbb, 0x63,
            0xe0, 0x56, 0xf7, 0x9a, 0xd3, 0xea, 0xfb, 0xec, 0x0b, 0xab, 0x2e, 0x56,
            0x27, 0x43, 0xf0, 0x0d, 0x7f, 0x31, 0x51, 0x4a, 0xed, 0xa0, 0x59, 0xbd,
            0x85, 0xce, 0xeb, 0x7b, 0x11, 0x81, 0x2e, 0xdb, 0xde, 0x5f, 0x73, 0x55,
            0x2d, 0xac, 0xd5, 0x98, 0xb2, 0x74, 0xb6, 0x7e, 0x89, 0x22, 0xe0, 0x62,
            0x1b, 0xb6, 0xdb, 0x37, 0x5a, 0x9b, 0xf3, 0x50, 0x96, 0xf9, 0x26, 0x8d,
            0x2c, 0xb2, 0xd8, 0x9c, 0x89, 0xeb, 0x2d, 0x74, 0x33, 0x1c, 0xdf, 0x78,
            0xe4, 0xdc, 0x63, 0x46, 0xd6, 0x09, 0x39, 0xed, 0xf8, 0x36, 0xcb, 0x85,
            0x73, 0x75, 0xa3, 0xcb, 0xcb, 0x44, 0xc1, 0xce, 0x78, 0xc9, 0xd1, 0x77,
            0x98, 0xca, 0x4c, 0x01, 0xd6, 0x23, 0xfd, 0xef, 0xb2, 0xf5, 0xc6, 0x16,
            0x87, 0x64, 0x44, 0x9b, 0x98, 0x92, 0x23, 0xc4, 0xee, 0xb5, 0x03, 0x9f,
            0x85, 0x8f, 0x76, 0xa5, 0xfc, 0x52, 0x4a, 0x68, 0xaf, 0xe5, 0x7b, 0x9e,
            0x54, 0xaa, 0x82, 0x2c, 0x6f, 0xbc, 0x29, 0xa6, 0x14, 0xd9, 0xf1, 0xa6,
            0xad, 0x91, 0x8b, 0xcb, 0x64, 0x9f, 0xda, 0x85, 0x1c, 0xf2, 0x14, 0xfe,
            0xc1, 0x05, 0xd9, 0x39, 0xd2, 0x89, 0x92, 0xfe, 0x1e, 0xfd, 0xa8, 0x47,
            0x21, 0x1b, 0x71, 0x7a, 0x6b, 0xc6, 0xa2, 0x32, 0x10, 0xec, 0x4f, 0x26,
            0xe2, 0xe2, 0x12, 0x6d, 0xd0, 0xc6, 0xa1, 0xe2, 0x85, 0x1c, 0x0b, 0x39,
            0x6d, 0x88, 0x99, 0x14, 0x3f, 0xe7, 0x27, 0x4c, 0x8a, 0xee, 0x71, 0xc5,
            0x59, 0xa2, 0xb0, 0x9b, 0x65, 0x42, 0xba, 0x2d, 0x2f, 0x8f, 0xe7, 0xd5,
            0x97, 0x40, 0xb4, 0x2f, 0x41, 0xfd, 0xa7, 0xa7, 0xb4, 0xbc, 0xab, 0x15,
            0xa5, 0x3c, 0x70, 0x23, 0x13, 0x2f, 0xfa, 0xea, 0x47, 0xdd, 0xe6, 0x20,
            0x69, 0x71, 0x27, 0x64, 0xd5, 0x71, 0x7a, 0xf1, 0xbf, 0x5e, 0xb4, 0x25,
            0x2d, 0x3d, 0x96, 0x56, 0x50, 0x4f, 0x1e, 0x7e, 0x74, 0x53, 0xb6, 0x93,
            0xcc, 0x18, 0x57, 0x7e, 0x24, 0x91, 0xb3, 0x10, 0xc1, 0x22, 0x55, 0x3e,
            0x02, 0x0e, 0x3c, 0xf7, 0x02, 0xc6, 0x00, 0x75, 0x1f, 0x28, 0x29, 0x93,
            0x2a, 0x51, 0xf4, 0xb7, 0xce, 0x2f, 0xf4, 0xa9, 0x67, 0xe8, 0xb8, 0xe5,
            0x8d, 0x5c, 0x13, 0x8d, 0xfc, 0x02, 0xc2, 0x48, 0xac, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00
    };

    /* Read certificate for recipient */
    status = DIGICERT_readFile("ecc_selfcert.der", &pCert, &certLen);
    retval += UNITTEST_STATUS (0, status);
    if (0 < retval)
       goto exit;

    /* Setup callback data */
    t = MALLOC (sizeof(internal_test));
    t->bufUsed = 0;
    t->bufMax = 2048;
    t->buf = MALLOC (t->bufMax);
    t->done = FALSE;

    /* Create context for envelop */
    status = DIGI_CMS_newContextOut (&ctx,
                                    E_MOC_CMS_ct_envelopedData,
                                    MOCK_RNGFun, NULL,
                                    TRUE,
                                    (void*)t,
                                    &internal_verifyCallback);
    retval += UNITTEST_STATUS (10, status);
    if (0 < retval)
       goto exit;

    /* Set the AES256-CBC encryption algo */
    status = DIGI_CMS_setEncryption (ctx,
                                    aes256CBC_OID + 1,
                                    aes256CBC_OID[0],
                                    MOCK_RNGFun, NULL);
    retval += UNITTEST_STATUS (11, status);
    if (0 < retval)
       goto exit;

    /* Add a single recipient */
    status = DIGI_CMS_addRecipient (ctx, pCert, certLen);
    retval += UNITTEST_STATUS (12, status);
    if (0 < retval)
       goto exit;

    /* Send Data in two packets */
    firstLen = sizeof(payLoad) / 2;
    status = DIGI_CMS_updateContextOut (ctx, payLoad, firstLen, FALSE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_updateContextOut (ctx, payLoad + firstLen, sizeof(payLoad) - firstLen, TRUE);
    retval += UNITTEST_STATUS (20, status);
    if (0 < retval)
       goto exit;

    status = DIGI_CMS_finalizeContextOut (ctx);
    retval += UNITTEST_STATUS (21, status);
    if (0 < retval)
       goto exit;

    /* check size of callback buffer */
    retval += UNITTEST_TRUE (30, t->done);
    if (retval > 0)
        goto exit;

exit:
    CRYPTO_uninitAsymmetricKey (&key, NULL);
    DIGI_FREE ((void**)&pCert);
    DIGI_CMS_deleteContext (&ctx);
    if (NULL != t)
    {
        DIGI_FREE ((void**)&(t->buf));
        DIGI_FREE ((void**)&t);
    }
    return retval;
}
