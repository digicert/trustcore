/*
 * test_mqtt_msg_streaming.c
 *
 * MQTT Message Streaming Unit Test
 *
 * Copyright 2025 DigiCert Project Authors. All Rights Reserved.
 *
 * DigiCert® TrustCore and TrustEdge are licensed under a dual-license model:
 * - **Open Source License**: GNU AGPL v3. See: https://github.com/digicert/trustcore-test/blob/main/LICENSE
 * - **Commercial License**: Available under DigiCert’s Master Services Agreement. See: https://github.com/digicert/trustcore-test/blob/main/LICENSE_COMMERCIAL.txt
 *   or https://www.digicert.com/master-services-agreement/
 *
 * For commercial licensing, contact DigiCert at sales@digicert.com.*
 *
 */

#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>

#include "cmocka.h"

#include "common/moptions.h"
#include "common/mtypes.h"
#include "common/merrors.h"
#include "common/mdefs.h"
#include "common/mstdlib.h"
#include "common/mocana.h"
#include "../../mqtt/mqtt_client.h"
#include "mqtt/mqtt_client_priv.h"
#include "mqtt/mqtt_msg.h"

#if defined(__ENABLE_MQTT_STREAMING__)
static void mqtt_test_MQTT_parsePacketBasic(void **ppState)
{
    MqttCtx *pCtx = NULL;
    ubyte *pBuffer = NULL;
    MSTATUS status;

    MOC_MALLOC((void **)&pCtx, sizeof(MqttCtx));
    assert_non_null(pCtx);
    MOC_MEMSET((ubyte *)pCtx, 0, sizeof(MqttCtx));

    pCtx->maxPacketSize = 1024;
    pCtx->version = 5;
    pCtx->pClientId = "testClient";
    pCtx->clientIdLen = 10;

    /* packet type: Publish*/

    MOC_MEMSET((ubyte *)pCtx, 0, sizeof(MqttCtx));
    pCtx->version = 5;

    pCtx->pClientId = "testClient";
    pCtx->clientIdLen = 10;

    ubyte buffer1[8] = {0x30, 0x0e, 0x00, 0x05, 0x74, 0x6f, 0x70, 0x69};
    pBuffer = buffer1;
    status = MQTT_parsePacket(1, pCtx, pBuffer, 8);
    assert_int_equal(OK, status);

    ubyte buffer2[8] = {0x63, 0x00, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67};
    pBuffer = buffer2;

    status = MQTT_parsePacket(1, pCtx, pBuffer, 8);
    assert_int_equal(OK, status);
    assert_int_equal(0, pCtx->streamingCurPkt);
    assert_int_equal(pCtx->publishState, MQTT_PUBLISH_TYPE_STATE);

    MOC_FREE((void **)&pCtx);
}

static void mqtt_test_MQTT_parsePacketLargePayload(void **ppState)
{
    MqttCtx *pCtx = NULL;
    ubyte *pBuffer = NULL;
    MSTATUS status;
    ubyte4 i;

    MOC_MALLOC((void **)&pCtx, sizeof(MqttCtx));
    assert_non_null(pCtx);
    MOC_MEMSET((ubyte *)pCtx, 0, sizeof(MqttCtx));

    pCtx->version = 5;
    pCtx->pClientId = "testClient";
    pCtx->clientIdLen = 10;

    ubyte buffer[826] = {0x30, 0xb7, 0x06, 0x00, 0x05, 0x74, 0x6f, 0x70, 0x69, 0x63, 0x00, 0x4d, 0x51, 0x54, 0x54, 0x20,
                         0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x73, 0x20, 0x61, 0x72, 0x65, 0x20, 0x76, 0x65, 0x72, 0x79,
                         0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x2c, 0x20, 0x72, 0x65, 0x71, 0x75, 0x69, 0x72, 0x65, 0x20,
                         0x6d, 0x69, 0x6e, 0x69, 0x6d, 0x61, 0x6c, 0x20, 0x72, 0x65, 0x73, 0x6f, 0x75, 0x72, 0x63, 0x65,
                         0x73, 0x20, 0x73, 0x6f, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x62, 0x65, 0x20, 0x75, 0x73, 0x65, 0x64,
                         0x20, 0x6f, 0x6e, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x6d, 0x69, 0x63, 0x72, 0x6f, 0x63,
                         0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x6c, 0x65, 0x72, 0x73, 0x2e, 0x20, 0x4d, 0x51, 0x54, 0x54,
                         0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x68, 0x65, 0x61, 0x64, 0x65, 0x72, 0x73,
                         0x20, 0x61, 0x72, 0x65, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x74, 0x6f, 0x20, 0x6f, 0x70,
                         0x74, 0x69, 0x6d, 0x69, 0x7a, 0x65, 0x20, 0x6e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x20, 0x62,
                         0x61, 0x6e, 0x64, 0x77, 0x69, 0x64, 0x74, 0x68, 0x2e, 0x20, 0x4d, 0x51, 0x54, 0x54, 0x20, 0x61,
                         0x6c, 0x6c, 0x6f, 0x77, 0x73, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67,
                         0x69, 0x6e, 0x67, 0x20, 0x62, 0x65, 0x74, 0x77, 0x65, 0x65, 0x6e, 0x20, 0x64, 0x65, 0x76, 0x69,
                         0x63, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x63, 0x6c, 0x6f, 0x75, 0x64, 0x20, 0x61, 0x6e, 0x64, 0x20,
                         0x63, 0x6c, 0x6f, 0x75, 0x64, 0x20, 0x74, 0x6f, 0x20, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2e,
                         0x20, 0x54, 0x68, 0x69, 0x73, 0x20, 0x6d, 0x61, 0x6b, 0x65, 0x73, 0x20, 0x66, 0x6f, 0x72, 0x20,
                         0x65, 0x61, 0x73, 0x79, 0x20, 0x62, 0x72, 0x6f, 0x61, 0x64, 0x63, 0x61, 0x73, 0x74, 0x69, 0x6e,
                         0x67, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x20, 0x74, 0x6f, 0x20, 0x67, 0x72,
                         0x6f, 0x75, 0x70, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x73, 0x2e, 0x20,
                         0x4d, 0x51, 0x54, 0x54, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x73, 0x63, 0x61, 0x6c, 0x65, 0x20, 0x74,
                         0x6f, 0x20, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x6d,
                         0x69, 0x6c, 0x6c, 0x69, 0x6f, 0x6e, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x49, 0x6f, 0x54, 0x20, 0x64,
                         0x65, 0x76, 0x69, 0x63, 0x65, 0x73, 0x2e, 0x20, 0x52, 0x65, 0x6c, 0x69, 0x61, 0x62, 0x69, 0x6c,
                         0x69, 0x74, 0x79, 0x20, 0x6f, 0x66, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x64,
                         0x65, 0x6c, 0x69, 0x76, 0x65, 0x72, 0x79, 0x20, 0x69, 0x73, 0x20, 0x69, 0x6d, 0x70, 0x6f, 0x72,
                         0x74, 0x61, 0x6e, 0x74, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x6d, 0x61, 0x6e, 0x79, 0x20, 0x49, 0x6f,
                         0x54, 0x20, 0x75, 0x73, 0x65, 0x20, 0x63, 0x61, 0x73, 0x65, 0x73, 0x2e, 0x20, 0x54, 0x68, 0x69,
                         0x73, 0x20, 0x69, 0x73, 0x20, 0x77, 0x68, 0x79, 0x20, 0x4d, 0x51, 0x54, 0x54, 0x20, 0x68, 0x61,
                         0x73, 0x20, 0x33, 0x20, 0x64, 0x65, 0x66, 0x69, 0x6e, 0x65, 0x64, 0x20, 0x71, 0x75, 0x61, 0x6c,
                         0x69, 0x74, 0x79, 0x20, 0x6f, 0x66, 0x20, 0x73, 0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x20, 0x6c,
                         0x65, 0x76, 0x65, 0x6c, 0x73, 0x3a, 0x20, 0x30, 0x20, 0x2d, 0x20, 0x61, 0x74, 0x20, 0x6d, 0x6f,
                         0x73, 0x74, 0x20, 0x6f, 0x6e, 0x63, 0x65, 0x2c, 0x20, 0x31, 0x2d, 0x20, 0x61, 0x74, 0x20, 0x6c,
                         0x65, 0x61, 0x73, 0x74, 0x20, 0x6f, 0x6e, 0x63, 0x65, 0x2c, 0x20, 0x32, 0x20, 0x2d, 0x20, 0x65,
                         0x78, 0x61, 0x63, 0x74, 0x6c, 0x79, 0x20, 0x6f, 0x6e, 0x63, 0x65, 0x20, 0x4d, 0x61, 0x6e, 0x79,
                         0x20, 0x49, 0x6f, 0x54, 0x20, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x73, 0x20, 0x63, 0x6f, 0x6e,
                         0x6e, 0x65, 0x63, 0x74, 0x20, 0x6f, 0x76, 0x65, 0x72, 0x20, 0x75, 0x6e, 0x72, 0x65, 0x6c, 0x69,
                         0x61, 0x62, 0x6c, 0x65, 0x20, 0x63, 0x65, 0x6c, 0x6c, 0x75, 0x6c, 0x61, 0x72, 0x20, 0x6e, 0x65,
                         0x74, 0x77, 0x6f, 0x72, 0x6b, 0x73, 0x2e, 0x20, 0x4d, 0x51, 0x54, 0x54, 0xe2, 0x80, 0x99, 0x73,
                         0x20, 0x73, 0x75, 0x70, 0x70, 0x6f, 0x72, 0x74, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x70, 0x65, 0x72,
                         0x73, 0x69, 0x73, 0x74, 0x65, 0x6e, 0x74, 0x20, 0x73, 0x65, 0x73, 0x73, 0x69, 0x6f, 0x6e, 0x73,
                         0x20, 0x72, 0x65, 0x64, 0x75, 0x63, 0x65, 0x73, 0x20, 0x74, 0x68, 0x65, 0x20, 0x74, 0x69, 0x6d,
                         0x65, 0x20, 0x74, 0x6f, 0x20, 0x72, 0x65, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x20, 0x74,
                         0x68, 0x65, 0x20, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x74,
                         0x68, 0x65, 0x20, 0x62, 0x72, 0x6f, 0x6b, 0x65, 0x72, 0x2e, 0x20, 0x4d, 0x51, 0x54, 0x54, 0x20,
                         0x6d, 0x61, 0x6b, 0x65, 0x73, 0x20, 0x69, 0x74, 0x20, 0x65, 0x61, 0x73, 0x79, 0x20, 0x74, 0x6f,
                         0x20, 0x65, 0x6e, 0x63, 0x72, 0x79, 0x70, 0x74, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65,
                         0x73, 0x20, 0x75, 0x73, 0x69, 0x6e, 0x67, 0x20, 0x54, 0x4c, 0x53, 0x20, 0x61, 0x6e, 0x64, 0x20,
                         0x61, 0x75, 0x74, 0x68, 0x65, 0x6e, 0x74, 0x69, 0x63, 0x61, 0x74, 0x65, 0x20, 0x63, 0x6c, 0x69,
                         0x65, 0x6e, 0x74, 0x73, 0x20, 0x75, 0x73, 0x69, 0x6e, 0x67, 0x20, 0x6d, 0x6f, 0x64, 0x65, 0x72,
                         0x6e, 0x20, 0x61, 0x75, 0x74, 0x68, 0x65, 0x6e, 0x74, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e,
                         0x20, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x73, 0x2c, 0x20, 0x73, 0x75, 0x63, 0x68,
                         0x20, 0x61, 0x73, 0x20, 0x4f, 0x41, 0x75, 0x74, 0x68, 0x2e};
    pBuffer = buffer;
    for (i = 0; i < 51; i++)
    {
        status = MQTT_parsePacket(1, pCtx, pBuffer, 16);
        assert_int_equal(OK, status);
        pBuffer += 16;
    }

    status = MQTT_parsePacket(1, pCtx, pBuffer, 10);
    assert_int_equal(OK, status);
    assert_int_equal(0, pCtx->streamingCurPkt);
    assert_int_equal(pCtx->publishState, MQTT_PUBLISH_TYPE_STATE);

    MOC_FREE((void **)&pCtx);
}

static void mqtt_test_MQTT_parsePacketWithProperties(void **ppState)
{
    MqttCtx *pCtx = NULL;
    ubyte *pBuffer = NULL;
    ubyte4 i;
    MSTATUS status;

    MOC_MALLOC((void **)&pCtx, sizeof(MqttCtx));
    assert_non_null(pCtx);
    MOC_MEMSET((ubyte *)pCtx, 0, sizeof(MqttCtx));

    pCtx->version = 5;
    pCtx->pClientId = "testClient";
    pCtx->clientIdLen = 10;
    pCtx->topicAliasMax = 10;

    ubyte buffer[1015] = {0x30, 0xf4, 0x07, 0x00, 0x05, 0x74, 0x6f, 0x70, 0x69, 0x63, 0x17, 0x01, 0x01, 0x02, 0x00, 0x00,
                          0x00, 0x64, 0x23, 0x00, 0x01, 0x26, 0x00, 0x03, 0x6b, 0x65, 0x79, 0x00, 0x05, 0x76, 0x61, 0x6c,
                          0x75, 0x65, 0x4c, 0x69, 0x67, 0x68, 0x74, 0x77, 0x65, 0x69, 0x67, 0x68, 0x74, 0x20, 0x61, 0x6e,
                          0x64, 0x20, 0x45, 0x66, 0x66, 0x69, 0x63, 0x69, 0x65, 0x6e, 0x74, 0x0a, 0x4d, 0x51, 0x54, 0x54,
                          0x20, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74, 0x73, 0x20, 0x61, 0x72, 0x65, 0x20, 0x76, 0x65, 0x72,
                          0x79, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x2c, 0x20, 0x72, 0x65, 0x71, 0x75, 0x69, 0x72, 0x65,
                          0x20, 0x6d, 0x69, 0x6e, 0x69, 0x6d, 0x61, 0x6c, 0x20, 0x72, 0x65, 0x73, 0x6f, 0x75, 0x72, 0x63,
                          0x65, 0x73, 0x20, 0x73, 0x6f, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x62, 0x65, 0x20, 0x75, 0x73, 0x65,
                          0x64, 0x20, 0x6f, 0x6e, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x6d, 0x69, 0x63, 0x72, 0x6f,
                          0x63, 0x6f, 0x6e, 0x74, 0x72, 0x6f, 0x6c, 0x6c, 0x65, 0x72, 0x73, 0x2e, 0x20, 0x4d, 0x51, 0x54,
                          0x54, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x68, 0x65, 0x61, 0x64, 0x65, 0x72,
                          0x73, 0x20, 0x61, 0x72, 0x65, 0x20, 0x73, 0x6d, 0x61, 0x6c, 0x6c, 0x20, 0x74, 0x6f, 0x20, 0x6f,
                          0x70, 0x74, 0x69, 0x6d, 0x69, 0x7a, 0x65, 0x20, 0x6e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x20,
                          0x62, 0x61, 0x6e, 0x64, 0x77, 0x69, 0x64, 0x74, 0x68, 0x2e, 0x0a, 0x0a, 0x42, 0x69, 0x2d, 0x64,
                          0x69, 0x72, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x61, 0x6c, 0x20, 0x43, 0x6f, 0x6d, 0x6d, 0x75,
                          0x6e, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x73, 0x0a, 0x4d, 0x51, 0x54, 0x54, 0x20, 0x61,
                          0x6c, 0x6c, 0x6f, 0x77, 0x73, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67,
                          0x69, 0x6e, 0x67, 0x20, 0x62, 0x65, 0x74, 0x77, 0x65, 0x65, 0x6e, 0x20, 0x64, 0x65, 0x76, 0x69,
                          0x63, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x63, 0x6c, 0x6f, 0x75, 0x64, 0x20, 0x61, 0x6e, 0x64, 0x20,
                          0x63, 0x6c, 0x6f, 0x75, 0x64, 0x20, 0x74, 0x6f, 0x20, 0x64, 0x65, 0x76, 0x69, 0x63, 0x65, 0x2e,
                          0x20, 0x54, 0x68, 0x69, 0x73, 0x20, 0x6d, 0x61, 0x6b, 0x65, 0x73, 0x20, 0x66, 0x6f, 0x72, 0x20,
                          0x65, 0x61, 0x73, 0x79, 0x20, 0x62, 0x72, 0x6f, 0x61, 0x64, 0x63, 0x61, 0x73, 0x74, 0x69, 0x6e,
                          0x67, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x20, 0x74, 0x6f, 0x20, 0x67, 0x72,
                          0x6f, 0x75, 0x70, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x74, 0x68, 0x69, 0x6e, 0x67, 0x73, 0x2e, 0x0a,
                          0x0a, 0x53, 0x63, 0x61, 0x6c, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x4d, 0x69, 0x6c, 0x6c, 0x69, 0x6f,
                          0x6e, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x54, 0x68, 0x69, 0x6e, 0x67, 0x73, 0x0a, 0x4d, 0x51, 0x54,
                          0x54, 0x20, 0x63, 0x61, 0x6e, 0x20, 0x73, 0x63, 0x61, 0x6c, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x63,
                          0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x6d, 0x69, 0x6c, 0x6c,
                          0x69, 0x6f, 0x6e, 0x73, 0x20, 0x6f, 0x66, 0x20, 0x49, 0x6f, 0x54, 0x20, 0x64, 0x65, 0x76, 0x69,
                          0x63, 0x65, 0x73, 0x2e, 0x0a, 0x0a, 0x52, 0x65, 0x6c, 0x69, 0x61, 0x62, 0x6c, 0x65, 0x20, 0x4d,
                          0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x44, 0x65, 0x6c, 0x69, 0x76, 0x65, 0x72, 0x79, 0x0a,
                          0x52, 0x65, 0x6c, 0x69, 0x61, 0x62, 0x69, 0x6c, 0x69, 0x74, 0x79, 0x20, 0x6f, 0x66, 0x20, 0x6d,
                          0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x64, 0x65, 0x6c, 0x69, 0x76, 0x65, 0x72, 0x79, 0x20,
                          0x69, 0x73, 0x20, 0x69, 0x6d, 0x70, 0x6f, 0x72, 0x74, 0x61, 0x6e, 0x74, 0x20, 0x66, 0x6f, 0x72,
                          0x20, 0x6d, 0x61, 0x6e, 0x79, 0x20, 0x49, 0x6f, 0x54, 0x20, 0x75, 0x73, 0x65, 0x20, 0x63, 0x61,
                          0x73, 0x65, 0x73, 0x2e, 0x20, 0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x77, 0x68, 0x79,
                          0x20, 0x4d, 0x51, 0x54, 0x54, 0x20, 0x68, 0x61, 0x73, 0x20, 0x33, 0x20, 0x64, 0x65, 0x66, 0x69,
                          0x6e, 0x65, 0x64, 0x20, 0x71, 0x75, 0x61, 0x6c, 0x69, 0x74, 0x79, 0x20, 0x6f, 0x66, 0x20, 0x73,
                          0x65, 0x72, 0x76, 0x69, 0x63, 0x65, 0x20, 0x6c, 0x65, 0x76, 0x65, 0x6c, 0x73, 0x3a, 0x20, 0x30,
                          0x20, 0x2d, 0x20, 0x61, 0x74, 0x20, 0x6d, 0x6f, 0x73, 0x74, 0x20, 0x6f, 0x6e, 0x63, 0x65, 0x2c,
                          0x20, 0x31, 0x2d, 0x20, 0x61, 0x74, 0x20, 0x6c, 0x65, 0x61, 0x73, 0x74, 0x20, 0x6f, 0x6e, 0x63,
                          0x65, 0x2c, 0x20, 0x32, 0x20, 0x2d, 0x20, 0x65, 0x78, 0x61, 0x63, 0x74, 0x6c, 0x79, 0x20, 0x6f,
                          0x6e, 0x63, 0x65, 0x0a, 0x0a, 0x53, 0x75, 0x70, 0x70, 0x6f, 0x72, 0x74, 0x20, 0x66, 0x6f, 0x72,
                          0x20, 0x55, 0x6e, 0x72, 0x65, 0x6c, 0x69, 0x61, 0x62, 0x6c, 0x65, 0x20, 0x4e, 0x65, 0x74, 0x77,
                          0x6f, 0x72, 0x6b, 0x73, 0x0a, 0x4d, 0x61, 0x6e, 0x79, 0x20, 0x49, 0x6f, 0x54, 0x20, 0x64, 0x65,
                          0x76, 0x69, 0x63, 0x65, 0x73, 0x20, 0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x20, 0x6f, 0x76,
                          0x65, 0x72, 0x20, 0x75, 0x6e, 0x72, 0x65, 0x6c, 0x69, 0x61, 0x62, 0x6c, 0x65, 0x20, 0x63, 0x65,
                          0x6c, 0x6c, 0x75, 0x6c, 0x61, 0x72, 0x20, 0x6e, 0x65, 0x74, 0x77, 0x6f, 0x72, 0x6b, 0x73, 0x2e,
                          0x20, 0x4d, 0x51, 0x54, 0x54, 0xe2, 0x80, 0x99, 0x73, 0x20, 0x73, 0x75, 0x70, 0x70, 0x6f, 0x72,
                          0x74, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x70, 0x65, 0x72, 0x73, 0x69, 0x73, 0x74, 0x65, 0x6e, 0x74,
                          0x20, 0x73, 0x65, 0x73, 0x73, 0x69, 0x6f, 0x6e, 0x73, 0x20, 0x72, 0x65, 0x64, 0x75, 0x63, 0x65,
                          0x73, 0x20, 0x74, 0x68, 0x65, 0x20, 0x74, 0x69, 0x6d, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x72, 0x65,
                          0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x20, 0x74, 0x68, 0x65, 0x20, 0x63, 0x6c, 0x69, 0x65,
                          0x6e, 0x74, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x74, 0x68, 0x65, 0x20, 0x62, 0x72, 0x6f, 0x6b,
                          0x65, 0x72, 0x2e, 0x0a, 0x0a, 0x53, 0x65, 0x63, 0x75, 0x72, 0x69, 0x74, 0x79, 0x20, 0x45, 0x6e,
                          0x61, 0x62, 0x6c, 0x65, 0x64, 0x0a, 0x20, 0x0a, 0x4d, 0x51, 0x54, 0x54, 0x20, 0x6d, 0x61, 0x6b,
                          0x65, 0x73, 0x20, 0x69, 0x74, 0x20, 0x65, 0x61, 0x73, 0x79, 0x20, 0x74, 0x6f, 0x20, 0x65, 0x6e,
                          0x63, 0x72, 0x79, 0x70, 0x74, 0x20, 0x6d, 0x65, 0x73, 0x73, 0x61, 0x67, 0x65, 0x73, 0x20, 0x75,
                          0x73, 0x69, 0x6e, 0x67, 0x20, 0x54, 0x4c, 0x53, 0x20, 0x61, 0x6e, 0x64, 0x20, 0x61, 0x75, 0x74,
                          0x68, 0x65, 0x6e, 0x74, 0x69, 0x63, 0x61, 0x74, 0x65, 0x20, 0x63, 0x6c, 0x69, 0x65, 0x6e, 0x74,
                          0x73, 0x20, 0x75, 0x73, 0x69, 0x6e, 0x67, 0x20, 0x6d, 0x6f, 0x64, 0x65, 0x72, 0x6e, 0x20, 0x61,
                          0x75, 0x74, 0x68, 0x65, 0x6e, 0x74, 0x69, 0x63, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x70, 0x72,
                          0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x73, 0x2c, 0x20, 0x73, 0x75, 0x63, 0x68, 0x20, 0x61, 0x73,
                          0x20, 0x4f, 0x41, 0x75, 0x74, 0x68, 0x2e};

    pBuffer = buffer;
    for (i = 0; i < 203; i++)
    {
        status = MQTT_parsePacket(1, pCtx, pBuffer, 5);
        assert_int_equal(OK, status);
        pBuffer += 5;
    }

    assert_int_equal(0, pCtx->streamingCurPkt);
    assert_int_equal(pCtx->publishState, MQTT_PUBLISH_TYPE_STATE);
    assert_int_equal(OK, status);

    MOC_FREE((void **)&pCtx);
}

static int testSetup(void **ppState)
{
    MSTATUS status;
    int ret = -1;

    status = MOCANA_initMocana();
    if (OK == status)
        ret = 0;

    return ret;
}

static int testTeardown(void **ppState)
{
    MSTATUS status;
    int ret = -1;

    status = MOCANA_freeMocana();
    if (OK == status)
        ret = 0;

    return ret;
}

int main(void)
{
    const struct CMUnitTest tests[] = {
        cmocka_unit_test(mqtt_test_MQTT_parsePacketBasic),
        cmocka_unit_test(mqtt_test_MQTT_parsePacketLargePayload),
        cmocka_unit_test(mqtt_test_MQTT_parsePacketWithProperties)
    };
    return cmocka_run_group_tests(tests, testSetup, testTeardown);
}

#endif