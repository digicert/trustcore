# NanoCert SCEP Client Build and Run Guide

> **Note:** Run all commands from the root of the repository.

## CMake Options

| Option                   | Description                             | Default |
|--------------------------|-----------------------------------------|---------|
| `ENABLE_SCEP`            | Enable SCEP support                     | `OFF`   |
| `BUILD_SAMPLES`          | Build sample applications               | `OFF`   |
| `WITH_LOGGING`           | Build with logging enabled              | `OFF`   |
| `ENABLE_TPM2`            | Build with TPM2 support                 | `OFF`   |

> **Note:** For common build options, see [`GUIDE.md`](../../GUIDE.md).

## Build

```bash
cmake -DWITH_LOGGING=ON -DBUILD_SAMPLES=ON -DENABLE_SCEP=ON -B build -S .
cmake --build build
```

> For TPM2 Support, add -DENABLE_TPM2=ON in build command

## Environment Setup

The SCEP sample uses `keystore/conf/tpconf.json` to configure file paths for certificates, keys, and configuration files. This file is automatically generated during the build process.

**Configuration Fields:**
- `http_proxy` - HTTP proxy URL (not required for SCEP)
- `root_dir` - Root directory of the repository
- `keystore_dir` - Directory for storing certificates and keys
- `conf_dir` - Directory for configuration files (CSR configs)
- `truststore_dir` - Directory for CA certificates

## SCEP Operations

### 1. Download CA Certificates

Download the CA certificate(s) from the SCEP server. This operation retrieves the Certificate Authority's certificate chain and saves it to the truststore.

**Command:**
```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation getcacert
```

**Output:**
- CA certificate saved to `keystore/ca/scep_ca.der`

### 2. Enrollment

Initial certificate enrollment. Generates a new key pair and submits a certificate signing request (CSR) to the SCEP server.

**Prerequisites:**
- CA certificates downloaded (see section 1)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

**Command:**
```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation enroll \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password>
```

**Output:**
- Enrolled certificate saved to `keystore/certs/requester_cert.der`

### 3. Re-Enrollment

Renew an existing certificate using the same key pair. This operation uses the existing certificate and private key to authenticate the renewal request.

**Prerequisites:**
- Existing certificate (`requester_cert.der` inside `keystore/certs`)
- Existing private key (`requester_key.pem` inside `keystore/keys`)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

**Command:**
```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation renew \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

**Output:**
- Renewed certificate saved to `keystore/certs/requester_cert.der`
- Previous certificate backed up with `.old` extension

### 4. Re-Key

Request a new certificate with a newly generated key pair. This operation generates a new key pair while using the existing certificate to authenticate the request.

**Prerequisites:**
- Existing certificate (`requester_cert.der` inside `keystore/certs`)
- Existing private key (`requester_key.pem` inside `keystore/keys`)
- CSR configuration file (`csr.conf` inside `keystore/ca`)

**Command:**
```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation rekey \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

**Output:**
- New private key saved to `keystore/keys/requester_renewed_key.pem`
- Previous key backed up with `.old` extension
- New certificate saved to `keystore/certs/requester_cert.der`
- Previous certificate backed up as `requester_cert.der.old`

### 5. TPM2 Operations

Perform SCEP operations using TPM2 for key generation and storage. The TPM2 securely stores private keys and performs cryptographic operations.

**Prerequisites:**
- TPM2 supported device available
- CA certificates downloaded (see section 1)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

#### TPM2 Enrollment (RSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation enroll \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
```

#### TPM2 Enrollment (ECDSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation enroll \
  -scepc_keyType ECDSA \
  -scepc_keySize 256 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
```

#### TPM2 Re-Enrollment (RSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation renew \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

#### TPM2 Re-Enrollment (ECDSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation renew \
  -scepc_keyType ECDSA \
  -scepc_keySize 256 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

#### TPM2 Re-Key (RSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation rekey \
  -scepc_keyType RSA \
  -scepc_keySize 2048 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

#### TPM2 Re-Key (ECDSA)

```bash
./samples/bin/scep_sample \
  -scepc_serverURL <server_url> \
  -scepc_pkiOperation rekey \
  -scepc_keyType ECDSA \
  -scepc_keySize 256 \
  -scepc_csr_conf csr.conf \
  -scepc_challengePass <password> \
  -scepc_keysource TPM2 \
  -scepc_oldCert requester_cert.der \
  -scepc_oldPemKey requester_key.pem
```

**Output:**
- New private key saved to `keystore/keys/requester_renewed_key.pem`
- Previous key backed up with `.old` extension
- New certificate saved to `keystore/certs/requester_cert.der`
- Previous certificate backed up as `requester_cert.der.old`

## Additional Notes

- **File Paths:** All certificate and key files are stored under `keystore/` with subdirectories:
  - `ca/`    - CA certificates
  - `certs/` - Client certificates
  - `keys/`  - Private keys
  - `req/`   - Certificate signing requests

- **Backup Files:** Before overwriting existing certificates or keys, the sample automatically creates `.old` backup files (CA certificates are not backed up).

- **Challenge Password:** The `-scepc_challengePass` parameter is required by the SCEP server for enrollment authentication.

- **Key Types:** Supported key types include RSA and ECDSA depending on build configuration. Key size varies by algorithm (e.g., RSA 2048/3072/4096, ECDSA 256/384).

- **Configuration File:** The CSR configuration file (`csr.conf`) specifies the certificate subject DN and optional extensions. See sample configuration file in the `keystore/conf/` directory.
