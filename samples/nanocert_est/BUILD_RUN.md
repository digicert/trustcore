# NanoCert EST Client Build and Run Guide

> **Note:** Run all commands from the root of the repository unless otherwise specified.

## Table of Contents

1. [CMake Options](#cmake-options)
2. [Native Build](#build)
3. [Docker Build and Run](#docker-build-and-run)
4. [Environment Setup](#environment-setup)
5. [EST Operations](#est-operations)

## CMake Options

| Option                   | Description                             | Default |
|--------------------------|-----------------------------------------|---------|
| `ENABLE_EST`             | Enable EST support                      | `OFF`   |
| `BUILD_SAMPLES`          | Build sample applications               | `OFF`   |
| `WITH_LOGGING`           | Build with debug logging enabled        | `OFF`   |
| `ENABLE_TPM2`            | Build with TPM2 support                 | `OFF`   |

> **Note:** For common build options, see [`GUIDE.md`](../../GUIDE.md).

## Build

```bash
cmake -DBUILD_SAMPLES=ON -DENABLE_EST=ON -B build -S .
cmake --build build
```


> For TPM2 Support, add -DENABLE_TPM2=ON in build command

## Docker Build and Run

### Building the Docker Image

The EST sample can be run in a Docker container with TPM 2.0 software emulation. This is useful for testing without requiring physical TPM hardware.

**Build the Docker image (auto-detects platform):**
```bash
docker build -t estsample -f samples/nanocert_est/Dockerfile samples/nanocert_est/
```

**Build for specific architecture (cross-compile):**
```bash
# For AMD64/x86_64
docker build --platform linux/amd64 -t estsample:amd64 -f samples/nanocert_est/Dockerfile samples/nanocert_est/

# For ARM64/aarch64
docker build --platform linux/arm64 -t estsample:arm64 -f samples/nanocert_est/Dockerfile samples/nanocert_est/

# For ARM32
docker build --platform linux/arm/v7 -t estsample:arm32 -f samples/nanocert_est/Dockerfile samples/nanocert_est/
```

### Running the Docker Container

**Display help:**
```bash
docker run --rm estsample
```

**Run EST enrollment with persistent storage with virtual TPM2:**
```bash
docker run --rm \
  -v $(pwd)/keystore:/opt/trustcore/keystore \
  estsample -est_uri <server_url>/simpleenroll \
  -est_keytype RSA \
  -est_keysize 2048 \
  -est_pass <password> \
  -est_keyalias <alias> \
  -est_keysource TPM2
```

### Docker Container Components

The container includes:
- **TrustCore** - DigiCert's security library with EST and TPM2 support
- **swtpm** - Software TPM 2.0 emulator (runs on ports 2321/2322)
- **libtpms** - Core TPM functionality library
- **TPM2 Tools** - DigiCert's tools for TPM provisioning and management
- **EST Sample** - Certificate enrollment application

### Docker Automatic Initialization

On first run, the container automatically:
1. Starts the swtpm daemon (if not running)
2. Provisions the TPM with Endorsement Key (EK) and Storage Root Key (SRK)
3. Generates TPM configuration at `/etc/digicert/tpm2.conf`

**Security Note:** The Docker container is configured for testing with empty TPM passwords. For production use, configure hardware TPM with strong passwords.


## Environment Setup

The EST sample uses `keystore/conf/tpconf.json` to configure file paths for certificates, keys, and configuration files. This file is automatically generated during the build process.

**Configuration Fields:**
- `http_proxy` - HTTP proxy URL (if required)
- `root_dir` - Root directory of the repository
- `keystore_dir` - Directory for storing certificates and keys
- `conf_dir` - Directory for configuration files (CSR configs)
- `truststore_dir` - Directory for CA certificates

## EST Operations

### 1. Download CA Certificates

Download the CA certificate(s) from the EST server. This operation retrieves the Certificate Authority's certificate chain and saves it to the truststore.

**Command:**
```bash
./samples/bin/est_sample \
  -est_uri <server_url>/cacerts
```

**Output:**
- CA certificate(s) saved to `keystore/ca/`

### 2. Simple Enroll

Initial certificate enrollment. Generates a new key pair and submits a certificate signing request (CSR) to the EST server.

**Prerequisites:**
- CA certificates downloaded (see section 1)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

**Command (RSA):**
```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simpleenroll \
  -est_csr_conf csr.conf \
  -est_keytype RSA \
  -est_keysize 2048 \
  -est_pass <password> \
  -est_keyalias <alias>
```

**Command (ECDSA):**
```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simpleenroll \
  -est_csr_conf csr.conf \
  -est_keytype ECDSA \
  -est_keysize 256 \
  -est_pass <password> \
  -est_keyalias <alias>
```

**Output:**
- Private key saved to `keystore/keys/` with alias-based filename
- Certificate saved to `keystore/certs/`
- CSR saved to `keystore/req/`

### 3. Simple Re-Enroll

Renew an existing certificate. This operation uses the existing certificate and private key to authenticate the renewal request.

**Prerequisites:**
- Existing certificate and private key (from enrollment)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

**Command (RSA):**
```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simplereenroll \
  -est_csr_conf csr.conf \
  -est_keytype RSA \
  -est_keysize 2048 \
  -est_keyalias <existing_alias>
```

**Command (ECDSA):**
```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simplereenroll \
  -est_csr_conf csr.conf \
  -est_keytype ECDSA \
  -est_keysize 256 \
  -est_keyalias <existing_alias>
```

**Output:**
- Renewed certificate saved to `keystore/certs/`
- CSR saved to `keystore/req/`

### 4. TPM2 Operations

Perform EST operations using TPM2 for key generation and storage. The TPM2 securely stores private keys and performs cryptographic operations.

**Prerequisites:**
- TPM2 supported device available
- CA certificates downloaded (see section 1)
- CSR configuration file (`csr.conf` inside `keystore/conf`)

#### TPM2 Simple Enroll (RSA)

```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simpleenroll \
  -est_csr_conf csr.conf \
  -est_keytype RSA \
  -est_keysize 2048 \
  -est_pass <password> \
  -est_keysource TPM2 \
  -est_keyalias <alias>
```

#### TPM2 Simple Enroll (ECDSA)

```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simpleenroll \
  -est_csr_conf csr.conf \
  -est_keytype ECDSA \
  -est_keysize 256 \
  -est_pass <password> \
  -est_keysource TPM2 \
  -est_keyalias <alias>
```

#### TPM2 Simple Re-Enroll (RSA)

```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simplereenroll \
  -est_csr_conf csr.conf \
  -est_keytype RSA \
  -est_keysize 2048 \
  -est_keysource TPM2 \
  -est_keyalias <existing_alias>
```

#### TPM2 Simple Re-Enroll (ECDSA)

```bash
./samples/bin/est_sample \
  -est_uri <server_url>/simplereenroll \
  -est_csr_conf csr.conf \
  -est_keytype ECDSA \
  -est_keysize 256 \
  -est_keysource TPM2 \
  -est_keyalias <existing_alias>
```

**Output:**
- TPM2 key handle saved with alias-based identifier
- Certificate saved to `keystore/certs/`
- CSR saved to `keystore/req/`

## Additional Notes

- **File Paths:** All certificate and key files are stored under `keystore/` with subdirectories:
  - `ca/`    - CA certificates
  - `certs/` - Client certificates
  - `keys/`  - Private keys
  - `req/`   - Certificate signing requests

- **Key Alias:** The `-est_keyalias` parameter is used to identify and manage different key pairs. The same alias should be used for enrollment and re-enrollment operations.

- **EST URI:** The EST URI follows the format: `<server_url>/<operation>` where operation is `cacerts`, `simpleenroll`, or `simplereenroll`.

- **Key Types:** Supported key types include RSA, ECDSA, and others depending on build configuration. Key size varies by algorithm (e.g., RSA 2048/3072/4096, ECDSA 256/384).

- **Configuration File:** The CSR configuration file (`csr.conf`) specifies the certificate subject DN and optional extensions. See sample configuration files in the `keystore/conf/` directory.

- **Authentication:** EST typically requires client certificate authentication for re-enrollment. The initial enrollment may use HTTP basic authentication or other methods depending on server configuration.
