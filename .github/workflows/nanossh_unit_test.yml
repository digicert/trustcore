name: NanoSSH unit test
run-name: Running NanoSSH unit tests üöÄ
on:
  workflow_dispatch: {}
  push:
    branches: [ "main" ]
  pull_request:
    paths:
      - .github/workflows/nanossh_unit_test.yml
      - samples/ssh_client/**
      - samples/ssh_server/**
      - src/common/**
      - src/ssh/**
      - projects/nanossh/**
      - projects/nanossh_testunit/**

permissions:
  contents: read

jobs:
  Run-NanoSSH-Unit-Tests:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y cmake libcmocka-dev lcov
          cmake --version

      - name: Build SSH
        env:
          CM_ENV_CODE_COVERAGE: 1
        run: |
          cmake -DENABLE_SSH_SERVER=ON -DENABLE_SSH_CLIENT=ON -DENABLE_SSH_UNITTEST=ON  -B build -S .
          cmake --build build

      - name: Baseline Coverage
        run: |
          lcov --no-external --capture --initial --directory . --output-file /tmp/ssh_base.info

      - name: Run Unit Tests
        run: |
          ./projects/nanossh_testunit/run.sh

      - name: Capture Coverage
        run: |
          lcov --no-external --capture --directory . --output-file /tmp/ssh_test.info

      - name: Combine Coverage
        run: |
          lcov --add-tracefile /tmp/ssh_base.info \
               --add-tracefile /tmp/ssh_test.info \
               --output-file /tmp/ssh_combined.info

      - name: Print Coverage Summary
        run: |
          echo "NanoSSH Coverage Summary:"
          lcov --extract /tmp/ssh_combined.info '*/ssh/*' --output-file /tmp/ssh_filtered.info
          lcov --list /tmp/ssh_filtered.info

      - name: Show Job Status
        run: echo "üçè This job's status is ${{ job.status }}."
