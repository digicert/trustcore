57a58
>     BIO *pop_bio = NULL;
71a73
>     pop_bio = asn_bio;
73,74c75,78
<     BIO_asn1_set_prefix(asn_bio, ndef_prefix, ndef_prefix_free);
<     BIO_asn1_set_suffix(asn_bio, ndef_suffix, ndef_suffix_free);
---
>     if (BIO_asn1_set_prefix(asn_bio, ndef_prefix, ndef_prefix_free) <= 0
>             || BIO_asn1_set_suffix(asn_bio, ndef_suffix, ndef_suffix_free) <= 0
>             || BIO_ctrl(asn_bio, BIO_C_SET_EX_ARG, 0, ndef_aux) <= 0)
>         goto err;
77,78c81,82
<      * Now let callback prepends any digest, cipher etc BIOs ASN1 structure
<      * needs.
---
>      * Now let the callback prepend any digest, cipher, etc., that the BIO's
>      * ASN1 structure needs.
85c89,98
<     if (aux->asn1_cb(ASN1_OP_STREAM_PRE, &val, it, &sarg) <= 0)
---
>     /*
>      * The asn1_cb(), must not have mutated asn_bio on error, leaving it in the
>      * middle of some partially built, but not returned BIO chain.
>      */
>     if (aux->asn1_cb(ASN1_OP_STREAM_PRE, &val, it, &sarg) <= 0) {
>         /*
>          * ndef_aux is now owned by asn_bio so we must not free it in the err
>          * clean up block
>          */
>         ndef_aux = NULL;
86a100,105
>     }
> 
>     /*
>      * We must not fail now because the callback has prepended additional
>      * BIOs to the chain
>      */
94,95d112
<     BIO_ctrl(asn_bio, BIO_C_SET_EX_ARG, 0, ndef_aux);
< 
98a116,117
>     /* BIO_pop() is NULL safe */
>     (void)BIO_pop(pop_bio);
